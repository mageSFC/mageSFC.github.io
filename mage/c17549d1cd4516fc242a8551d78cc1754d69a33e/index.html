<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Ansible自动化运维工具之常用的模块 | 马哥私房菜</title><meta name="author" content="mage"><meta name="copyright" content="mage"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="ansible 常用模块ansible 常用模块1)ping模块主机连通性测试 我们使用ansible web -m ping命令来进行主机连通性测试，效果如下： 12345678910111213141516171819202122ansible@ansible:~$ ansible all -m ping 192.168.xxxxxx.92 | SUCCESS &#x3D;&gt; &amp;#123;">
<meta property="og:type" content="article">
<meta property="og:title" content="Ansible自动化运维工具之常用的模块">
<meta property="og:url" content="https://magesfc.github.io/mage/c17549d1cd4516fc242a8551d78cc1754d69a33e/">
<meta property="og:site_name" content="马哥私房菜">
<meta property="og:description" content="ansible 常用模块ansible 常用模块1)ping模块主机连通性测试 我们使用ansible web -m ping命令来进行主机连通性测试，效果如下： 12345678910111213141516171819202122ansible@ansible:~$ ansible all -m ping 192.168.xxxxxx.92 | SUCCESS &#x3D;&gt; &amp;#123;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://t.mwm.moe/fj/">
<meta property="article:published_time" content="2022-04-04T03:38:58.000Z">
<meta property="article:modified_time" content="2022-10-31T08:44:04.000Z">
<meta property="article:author" content="mage">
<meta property="article:tag" content="ansible">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://t.mwm.moe/fj/"><link rel="shortcut icon" href="https://www.zeekrlife.com/favicon.png"><link rel="canonical" href="https://magesfc.github.io/mage/c17549d1cd4516fc242a8551d78cc1754d69a33e/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: mage","link":"链接: ","source":"来源: 马哥私房菜","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Ansible自动化运维工具之常用的模块',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-10-31 16:44:04'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><style type="text/css">.card-announcement .social-button{margin:.6rem 0 0 0;text-align:center}.card-announcement .social-button a{display:block;background-color:var(--btn-bg);color:var(--btn-color);text-align:center;line-height:2.4;margin:4px 0}.card-announcement .social-button a:hover{background-color:var(--btn-hover-color)}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "/img/loading.gif" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">212</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">230</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">40</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-compass"></i><span> 目录</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 精选文档</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/21cfbf15/"><span> 🚀 快速开始</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/dc584b87/"><span> 📑 主题页面</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/4aa8abbe/"><span> 🛠 主题配置-1</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/ceeb73f/"><span> 🛠 主题配置-2</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/98d20436/"><span> ❓ 主题问答</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/4073eda/"><span> ⚡️ 进阶教程</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/198a4240/"><span> ✨ 更新日志</span></a></li></ul></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://butterfly.js.org/link/"><i class="fa-fw fas fa-thumbs-up"></i><span> 其他示例</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://t.mwm.moe/fj/')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">马哥私房菜</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-compass"></i><span> 目录</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 精选文档</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/21cfbf15/"><span> 🚀 快速开始</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/dc584b87/"><span> 📑 主题页面</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/4aa8abbe/"><span> 🛠 主题配置-1</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/ceeb73f/"><span> 🛠 主题配置-2</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/98d20436/"><span> ❓ 主题问答</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/4073eda/"><span> ⚡️ 进阶教程</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/198a4240/"><span> ✨ 更新日志</span></a></li></ul></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://butterfly.js.org/link/"><i class="fa-fw fas fa-thumbs-up"></i><span> 其他示例</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Ansible自动化运维工具之常用的模块</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-04-04T03:38:58.000Z" title="发表于 2022-04-04 11:38:58">2022-04-04</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-10-31T08:44:04.000Z" title="更新于 2022-10-31 16:44:04">2022-10-31</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/ansible/">ansible</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Ansible自动化运维工具之常用的模块"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="ansible-常用模块"><a href="#ansible-常用模块" class="headerlink" title="ansible 常用模块"></a>ansible 常用模块</h1><h1 id="ansible-常用模块-1"><a href="#ansible-常用模块-1" class="headerlink" title="ansible 常用模块"></a>ansible 常用模块</h1><h2 id="1-ping模块"><a href="#1-ping模块" class="headerlink" title="1)ping模块"></a>1)ping模块</h2><p>主机连通性测试 我们使用ansible web -m ping命令来进行主机连通性测试，效果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">ansible@ansible:~$ ansible all -m ping </span><br><span class="line">192.168.xxxxxx.92 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python3&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.xxxxxx.114 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python3&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.xxxxxx.87 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python3&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-command模块"><a href="#2-command模块" class="headerlink" title="2)command模块"></a>2)command模块</h2><p>这个模块可以直接在远程主机上执行命令，并将结果返回本主机。</p>
<p>command模块的常用参数如下：</p>
<pre><code>chdir           # 在执行命令之前，先切换到该目录
executable      # 切换shell来执行命令，需要使用命令的绝对路径
free_form       # 要执行的Linux指令，一般使用Ansible的-a参数代替。
creates         # 一个文件名，当这个文件存在，则该命令不执行,可以用来做判断
removes         # 一个文件名，这个文件不存在，则该命令不执行
</code></pre>
<p>功能：在远程主机执行 shell 命令；为默认模块，可省略 -m 选项；</p>
<p>注意：不支持管道命令 |；</p>
<p>在被控机器上执行 date 命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ansible@ansible:~$ ansible all -m command -a &#x27;date&#x27;</span><br><span class="line">192.168.xxx.92 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Tue 07 Dec 2021 02:08:46 PM UTC</span><br><span class="line">192.168.xxx.87 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Tue 07 Dec 2021 02:08:43 PM UTC</span><br><span class="line">192.168.xxx.114 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Tue 07 Dec 2021 02:08:46 PM UTC</span><br></pre></td></tr></table></figure>

<p>在被控机器上 设置时区</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ansible all -m command -a &#x27;sudo timedatectl set-timezone Asia/Shanghai&#x27;</span><br><span class="line">192.168.xxx.87 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">192.168.xxx.92 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">192.168.xxx.114 | CHANGED | rc=0 &gt;&gt;</span><br></pre></td></tr></table></figure>

<p>在被控机器上 查看设置时区</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ansible@ansible:~$ ansible all -m command -a &#x27;cat /etc/timezone&#x27;</span><br><span class="line">192.168.xxx.114 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Asia/Shanghai</span><br><span class="line">192.168.xxx.87 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Asia/Shanghai</span><br><span class="line">192.168.xxx.92 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Asia/Shanghai</span><br></pre></td></tr></table></figure>

<p>命令模块接受命令名称，后面是空格分隔的列表参数。给定的命令将在所有选定的节点上执行。<br>它不会通过shell进行处理，比如$HOME和操作如”&lt;”，”&gt;”，”|”，”;”，”&amp;” 工作（需要使用（shell)模块实现这些功能)。注意，该命令不支持| 管道命令。<br>要想使用 管道 等特殊的用法，可以像下面这样 利用  bash -c 这样执行一段脚本代码。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ansible rmsz -m command -a &#x27;bash -c &quot;git config -l|grep push&quot;&#x27;</span><br><span class="line">192.168.xxx.173 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">url.ssh://gerrit.ansible.com.pushinsteadof=ssh://gerrit-sh.ansible.com</span><br><span class="line">url.ssh://gerrit.ansible.com.pushinsteadof=ssh://gerrit-sz.ansible.com</span><br><span class="line">url.ssh://gerrit.ansible.com.pushinsteadof=ssh://gerrit-nj.ansible.com</span><br><span class="line">192.168.xxx.175 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">url.ssh://gerrit.ansible.com.pushinsteadof=ssh://gerrit-sh.ansible.com</span><br><span class="line">url.ssh://gerrit.ansible.com.pushinsteadof=ssh://gerrit-sz.ansible.com</span><br><span class="line">url.ssh://gerrit.ansible.com.pushinsteadof=ssh://gerrit-nj.ansible.com</span><br><span class="line">192.168.xxx.172 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">url.ssh://gerrit.ansible.com.pushinsteadof=ssh://gerrit-sh.ansible.com</span><br><span class="line">url.ssh://gerrit.ansible.com.pushinsteadof=ssh://gerrit-sz.ansible.com</span><br><span class="line">url.ssh://gerrit.ansible.com.pushinsteadof=ssh://gerrit-nj.ansible.com</span><br><span class="line">192.168.xxx.171 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">url.ssh://gerrit.ansible.com.pushinsteadof=ssh://gerrit-sh.ansible.com</span><br><span class="line">url.ssh://gerrit.ansible.com.pushinsteadof=ssh://gerrit-sz.ansible.com</span><br><span class="line">url.ssh://gerrit.ansible.com.pushinsteadof=ssh://gerrit-nj.ansible.com</span><br><span class="line">192.168.xxx.174 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">url.ssh://gerrit.ansible.com.pushinsteadof=ssh://gerrit-sh.ansible.com</span><br><span class="line">url.ssh://gerrit.ansible.com.pushinsteadof=ssh://gerrit-sz.ansible.com</span><br><span class="line">url.ssh://gerrit.ansible.com.pushinsteadof=ssh://gerrit-nj.ansible.com</span><br><span class="line">192.168.xxx.176 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">url.ssh://gerrit.ansible.com.pushinsteadof=ssh://gerrit-sh.ansible.com</span><br><span class="line">url.ssh://gerrit.ansible.com.pushinsteadof=ssh://gerrit-sz.ansible.com</span><br><span class="line">url.ssh://gerrit.ansible.com.pushinsteadof=ssh://gerrit-nj.ansible.com</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible rmsz -m command -a &#x27;git config -l|grep push&#x27;</span><br><span class="line">直接这样执行 是不行的！！！</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>示例一：command模块基础用法，在远端主机执行命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.20.22 -a &quot;id&quot;</span><br><span class="line">192.168.20.22 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>示例二：在被控端主机切换到指定目录，执行命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.20.22 -a &quot;chdir=/tmp pwd&quot;</span><br><span class="line">192.168.20.22 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">/tmp</span><br></pre></td></tr></table></figure>

<p>示例三：creates：指定的文件存在时，不执行对应命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.20.22 -a &quot;creates=/etc/passwd ls&quot;</span><br><span class="line">192.168.20.22 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">skipped, since /etc/passwd exists   &lt;==跳过，未执行；</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>示例四：removes：与creates相反，指定的文件存在，则执行对应命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.20.22 -a &quot;removes=/etc/passwd ls&quot;</span><br><span class="line">192.168.20.22 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">anaconda-ks.cfg</span><br><span class="line">apache-tomcat-10.0.7.tar.gz</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="3-shell模块"><a href="#3-shell模块" class="headerlink" title="3)shell模块"></a>3)shell模块</h2><p>shell模块可以在远程主机上调用shell解释器运行命令，支持shell的各种功能，例如管道等。</p>
<p>功能：在远程主机执行 Shell 命令，支持管道等特殊符号的操作，比command模块使用广泛；</p>
<p> shell模块的常用参数如下：</p>
<pre><code>chdir DIR 	执行ansible时，切换到指定的目录
creates FILE 	如果文件FILE存在，则不执行命令
removes FILE 	如果文件FILE存在，则执行命令
</code></pre>
<p>shell模块支持管道命令，在被控主机上创建用户和密码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.20.22 -m shell -a &#x27;useradd xxx&#x27;</span><br><span class="line">192.168.20.22 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">ansible 192.168.20.22 -m shell -a &#x27;echo 123456 | passwd --stdin xxx&#x27;</span><br><span class="line">192.168.20.22 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Changing password for user xxx.</span><br><span class="line">passwd: all authentication tokens updated successfully.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意：调用bash执行命令 类似cat &#x2F;tmp&#x2F;stanley.md | awk -F’|’ ‘{print $1,$2}’ &amp;&gt; &#x2F;tmp&#x2F;example.txt这些复杂命令，即使使用shell也可能会失败，解决办法：写到脚本中，copy到远程，执行，再把需要的结果拉回执行命令的机器。</p>
<p>注意：虽然可以使用shell模块完成绝大多数操作，但是shell模块无法很好的保证ansible的幂等性，因此建议使用以下各个专用模块完成特定的功能，可以保证幂等性。</p>
<h2 id="4-copy模块"><a href="#4-copy模块" class="headerlink" title="4)copy模块"></a>4)copy模块</h2><p>这个模块用于将文件复制到远程主机，同时支持给定内容生成文件和修改权限等。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">src 	复制的源文件路径，若源文件为目录，默认进行递归复制，如果路劲以“/”结尾，仅会复制目录下的内容，该目录本身不会复制，如果路径不带“/”，目录本身和目录下的内容会一并复制过去。</span><br><span class="line">dest 	目标绝对路径，如果源是文件夹，目标也必须是文件夹，不存在将创建</span><br><span class="line">backup 	如果目标主机已经有源文件，会事先备份，防止覆盖</span><br><span class="line">mode 	文件复制到远程并设定权限，默认file=644，directory=755</span><br><span class="line">owner 	文件复制到远程并设定属主，默认为root</span><br><span class="line">group 	文件复制到远程并设定属组，默认为root</span><br><span class="line">content 	将目标文件的内容，指定为content所带的字符串</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>示例一：把&#x2F;data&#x2F;nginx&#x2F;html&#x2F;web01&#x2F;index.html复制到被控主机&#x2F;tmp目录下，属主属组为nginx，权限为644：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># ansible NginxWebs -m copy -a &quot;src=/data/nginx/html/web01/index.html dest=/tmp owner=nginx group=nginx mode=644&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># ll /tmp/index.html </span><br><span class="line">-rw-r--r-- 1 nginx nginx 7 Aug  1 11:16 /tmp/index.html</span><br></pre></td></tr></table></figure>
<p>示例二：再次复制上例文件，并对原文件备份：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># ansible NginxWebs -m copy -a &quot;src=/data/nginx/html/web01/index.html dest=/tmp owner=nginx group=nginx mode=644 backup=yes&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># ll /tmp/index.html*</span><br><span class="line">-rw-r--r-- 1 nginx nginx 10 Aug  1 11:20 /tmp/index.html</span><br><span class="line">-rw-r--r-- 1 nginx nginx  7 Aug  1 11:16 /tmp/index.html.6043.2021-08-01@11:20:39~   &lt;==备份的原文件</span><br></pre></td></tr></table></figure>

<p>往远程的主机文件中写入内容，如果文件不存在则创建：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># ansible NginxWebs -m copy -a &quot;content=&quot;Http_Server\n&quot; dest=/var/www/html/index.html&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># cat /var/www/html/index.html </span><br><span class="line">Http_Server</span><br></pre></td></tr></table></figure>

<p>示例四：复制目录到目标主机：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># ansible NginxWebs -m copy -a &quot;src=/root/test dest=/root&quot;</span><br><span class="line"></span><br><span class="line"># ll /root/test/</span><br><span class="line">total 4</span><br><span class="line">-rw-r--r-- 1 root root 3258 Aug  1 11:26 nginx.conf</span><br></pre></td></tr></table></figure>


<p>示例 5：复制目录到目标主机：目标目录不存在，目标目录多一级目录的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ ansible 10.0.12.31 -m copy -a &#x27;src=./telegraf dest=/tmp/telegraf&#x27;</span><br><span class="line">10.0.12.31 | CHANGED =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true,</span><br><span class="line">    &quot;dest&quot;: &quot;/tmp/telegraf/&quot;,</span><br><span class="line">    &quot;src&quot;: &quot;/home/buildfarm/./telegraf&quot;</span><br><span class="line">&#125;</span><br><span class="line">$ tree /tmp/telegraf/  # 在目标 机器上查看发现 目录结构 是 /tmp/telegraf/telegraf 这样的，是把源目录telegraf 复制到 目标 /tmp/telegraf 目录里面 了。目标目录不存在是会自动创建的</span><br><span class="line">/tmp/telegraf/</span><br><span class="line">└── telegraf</span><br><span class="line">    ├── telegraf</span><br><span class="line">    ├── telegraf.conf</span><br><span class="line">    ├── telegraf.log</span><br><span class="line">    ├── telegraf.pid</span><br><span class="line">    ├── telegraf.service</span><br><span class="line">    └── telegraf.sh</span><br><span class="line"></span><br><span class="line">1 directory, 6 files</span><br></pre></td></tr></table></figure>

<p>示例 6：复制目录到目标主机：目标目录只有一级目录的， </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ ansible 10.0.12.31 -m copy -a &#x27;src=./telegraf dest=/tmp/&#x27;</span><br><span class="line">10.0.12.31 | CHANGED =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true,</span><br><span class="line">    &quot;dest&quot;: &quot;/tmp/&quot;,</span><br><span class="line">    &quot;src&quot;: &quot;/home/buildfarm/./telegraf&quot;</span><br><span class="line">&#125;</span><br><span class="line">$ tree /tmp/telegraf/ # 在目标 机器上查看发现，这个和上面的例子就很好的对比出来 差异了</span><br><span class="line">/tmp/telegraf/</span><br><span class="line">├── telegraf</span><br><span class="line">├── telegraf.conf</span><br><span class="line">├── telegraf.log</span><br><span class="line">├── telegraf.pid</span><br><span class="line">├── telegraf.service</span><br><span class="line">└── telegraf.sh</span><br></pre></td></tr></table></figure>

<p>示例 6：复制目录到目标主机：目标目录不存在，并且有多级级目录的， </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ ansible 10.0.12.31 -m copy -a &#x27;src=./telegraf dest=/tmp/a/b/c/telegraf&#x27;</span><br><span class="line">10.0.12.31 | CHANGED =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true,</span><br><span class="line">    &quot;dest&quot;: &quot;/tmp/a/b/c/telegraf/&quot;,</span><br><span class="line">    &quot;src&quot;: &quot;/home/buildfarm/./telegraf&quot;</span><br><span class="line">&#125;</span><br><span class="line">$ tree /tmp/a   这个和 例 5 一样的，会放到目标 目录 里面，等于  /tmp/a/b/c/telegraf/telegraf </span><br><span class="line">/tmp/a</span><br><span class="line">└── b</span><br><span class="line">    └── c</span><br><span class="line">        └── telegraf</span><br><span class="line">            └── telegraf</span><br><span class="line">                ├── telegraf</span><br><span class="line">                ├── telegraf.conf</span><br><span class="line">                ├── telegraf.log</span><br><span class="line">                ├── telegraf.pid</span><br><span class="line">                ├── telegraf.service</span><br><span class="line">                └── telegraf.sh</span><br><span class="line"></span><br><span class="line">4 directories, 6 files</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>示例 7：复制目录到目标主机：目标目录不存在，并且有多级级目录的，  这个和 上面的 例6 做个 对比</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ ansible 10.0.12.31 -m copy -a &#x27;src=./telegraf/ dest=/tmp/a/b/c/telegraf&#x27;</span><br><span class="line">10.0.12.31 | CHANGED =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true,</span><br><span class="line">    &quot;dest&quot;: &quot;/tmp/a/b/c/telegraf/&quot;,</span><br><span class="line">    &quot;src&quot;: &quot;/home/buildfarm/./telegraf/&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ tree /tmp/a        这个和 例 6  做个 对比 ， 等于  /tmp/a/b/c/telegraf， 源目录如果 / 结尾的话 情况就不一样了，这个和rsync 很类似 </span><br><span class="line">/tmp/a</span><br><span class="line">└── b</span><br><span class="line">    └── c</span><br><span class="line">        └── telegraf</span><br><span class="line">            ├── telegraf</span><br><span class="line">            ├── telegraf.conf</span><br><span class="line">            ├── telegraf.log</span><br><span class="line">            ├── telegraf.pid</span><br><span class="line">            ├── telegraf.service</span><br><span class="line">            └── telegraf.sh</span><br><span class="line"></span><br><span class="line">3 directories, 6 files</span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">$ ansible 10.0.12.31 -m copy -a &#x27;src=./telegraf dest=/tmp/a/b/c/telegraf/&#x27;</span><br><span class="line">10.0.12.31 | CHANGED =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true,</span><br><span class="line">    &quot;dest&quot;: &quot;/tmp/a/b/c/telegraf/&quot;,</span><br><span class="line">    &quot;src&quot;: &quot;/home/buildfarm/./telegraf&quot;</span><br><span class="line">&#125;</span><br><span class="line">$ tree /tmp/a</span><br><span class="line">/tmp/a</span><br><span class="line">└── b</span><br><span class="line">    └── c</span><br><span class="line">        └── telegraf</span><br><span class="line">            └── telegraf</span><br><span class="line">                ├── telegraf</span><br><span class="line">                ├── telegraf.conf</span><br><span class="line">                ├── telegraf.log</span><br><span class="line">                ├── telegraf.pid</span><br><span class="line">                ├── telegraf.service</span><br><span class="line">                └── telegraf.sh</span><br><span class="line"></span><br><span class="line">结果同 示例 6，</span><br><span class="line"></span><br><span class="line">$ ansible 10.0.12.31 -m copy -a &#x27;src=./telegraf/ dest=/tmp/a/b/c/telegraf/&#x27;</span><br><span class="line">10.0.12.31 | CHANGED =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true,</span><br><span class="line">    &quot;dest&quot;: &quot;/tmp/a/b/c/telegraf/&quot;,</span><br><span class="line">    &quot;src&quot;: &quot;/home/buildfarm/./telegraf/&quot;  </span><br><span class="line">&#125;</span><br><span class="line">$ tree /tmp/a</span><br><span class="line">/tmp/a</span><br><span class="line">└── b</span><br><span class="line">    └── c</span><br><span class="line">        └── telegraf</span><br><span class="line">            ├── telegraf</span><br><span class="line">            ├── telegraf.conf</span><br><span class="line">            ├── telegraf.log</span><br><span class="line">            ├── telegraf.pid</span><br><span class="line">            ├── telegraf.service</span><br><span class="line">            └── telegraf.sh</span><br><span class="line"></span><br><span class="line">结果同 示例 7</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">最终  放不放到子目录里面，是要看 源路径 上 是否 /  结尾的，类似 rsync 命令</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="5-fetch模块"><a href="#5-fetch模块" class="headerlink" title="5)fetch模块"></a>5)fetch模块</h2><p>作用：从客户端取文件（只能是文件,不支持目录)至服务器端的目录里，与copy相反，如果一定要拉取目录，可以先将目录tar，再拉取。</p>
<p>主要参数如下：</p>
<pre><code>参数 	说明
src 	复制的源文件路径，源文件只能是文件
dest 	目标绝对路径
</code></pre>
<p>示例一：把被控主机的&#x2F;etc&#x2F;nginx&#x2F;nginx&#x2F;conf配置文件拷贝到本机的&#x2F;root&#x2F;nginx目录下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ ansible 10.0.12.31 -m fetch -a &#x27;src=/etc/hostname dest=/tmp/fetch/aaaaa&#x27;</span><br><span class="line">10.0.12.31 | CHANGED =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true,</span><br><span class="line">    &quot;checksum&quot;: &quot;8260afc442f28647c4a78cdcc12c492f7b580f15&quot;,</span><br><span class="line">    &quot;dest&quot;: &quot;/tmp/fetch/aaaaa/10.0.12.31/etc/hostname&quot;,</span><br><span class="line">    &quot;md5sum&quot;: &quot;b9613c443c158f95653754a49b211171&quot;,</span><br><span class="line">    &quot;remote_checksum&quot;: &quot;8260afc442f28647c4a78cdcc12c492f7b580f15&quot;,</span><br><span class="line">    &quot;remote_md5sum&quot;: null</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#注意：把远程主机文件拷贝到本机时，会为每个远程主机建立一个文件夹，名称就是该远程主机的ip地址，然后把文件分别放到对应主机的目录下；</span><br><span class="line">#目标目录不存在是可以创建出来的，源文件必须是一个存在的文件！！！</span><br><span class="line">$ tree /tmp/fetch/</span><br><span class="line">/tmp/fetch/</span><br><span class="line">└── aaaaa</span><br><span class="line">    └── 10.0.12.31</span><br><span class="line">        └── etc</span><br><span class="line">            └── hostname</span><br><span class="line"></span><br><span class="line">3 directories, 1 file</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>示例二：拷贝远程主机的目录到本机</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">#1.首先需要把远程主机的目录打包，默认打包到远程主机的家目录下（/root)</span><br><span class="line"># ansible NginxWebs -m shell -a &#x27;tar jcf log.tar.bzip2 /var/log/nginx/access*&#x27;</span><br><span class="line">192.168.20.23 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">tar: Removing leading `/&#x27; from member names</span><br><span class="line">192.168.20.22 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">tar: Removing leading `/&#x27; from member names</span><br><span class="line"></span><br><span class="line">#2.把打包文件取回本机：</span><br><span class="line"># ansible NginxWebs -m fetch -a &#x27;src=/root/log.tar.bzip2 dest=/root/nginx&#x27;</span><br><span class="line">192.168.20.23 | CHANGED =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;checksum&quot;: &quot;832b6b9863baf60970f0972c749df8a26221ab26&quot;, </span><br><span class="line">    &quot;dest&quot;: &quot;/root/nginx/192.168.20.23/root/log.tar.bzip2&quot;, </span><br><span class="line">    &quot;md5sum&quot;: &quot;86c762c3ab6f3253c6b6be1739a95ac8&quot;, </span><br><span class="line">    &quot;remote_checksum&quot;: &quot;832b6b9863baf60970f0972c749df8a26221ab26&quot;, </span><br><span class="line">    &quot;remote_md5sum&quot;: null</span><br><span class="line">&#125;</span><br><span class="line">192.168.20.22 | CHANGED =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;checksum&quot;: &quot;c66537be74f74e1c03254be3400ce7af4a1fe4bb&quot;, </span><br><span class="line">    &quot;dest&quot;: &quot;/root/nginx/192.168.20.22/root/log.tar.bzip2&quot;, </span><br><span class="line">    &quot;md5sum&quot;: &quot;74671b6a38285ae2d576451b3b248f3e&quot;, </span><br><span class="line">    &quot;remote_checksum&quot;: &quot;c66537be74f74e1c03254be3400ce7af4a1fe4bb&quot;, </span><br><span class="line">    &quot;remote_md5sum&quot;: null</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># tree /root/nginx</span><br><span class="line">/root/nginx</span><br><span class="line">├── 192.168.20.22</span><br><span class="line">│   ├── etc</span><br><span class="line">│   │   └── nginx</span><br><span class="line">│   │       └── nginx.conf</span><br><span class="line">│   └── root</span><br><span class="line">│       └── log.tar.bzip2</span><br><span class="line">└── 192.168.20.23</span><br><span class="line">    ├── etc</span><br><span class="line">    │   └── nginx</span><br><span class="line">    │       └── nginx.conf</span><br><span class="line">    └── root</span><br><span class="line">        └── log.tar.bzip2</span><br><span class="line"></span><br><span class="line">8 directories, 4 files</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="6-file模块"><a href="#6-file模块" class="headerlink" title="6)file模块"></a>6)file模块</h2><p>功能：为被控端创建文件或目录，设定权限属性；</p>
<p>主要参数如下：</p>
<pre><code>path 	指定远程服务器的路径，也可以写成‘dest’，‘name’
state 	状态，可以将值设定为directory表示创建目录，设定为touch表示创建文件，设定为link表示创建软连接，设定为hard表示创建硬连接，设定为absent表示删除目录文件或链接
mode 	文件复制到远程并设定权限，默认file=644，directory=755
owner 	文件复制到远程并设定属主，默认为root
group 	文件复制到远程并设定属组，默认为root
recurese 	递归修改
</code></pre>
<p>示例一：创建文件&#x2F;root&#x2F;f1.sh，并设定属主、属组、权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># ansible NginxWebs -m file -a &#x27;path=/root/f1.sh owner=root group=root mode=755 state=touch&#x27;</span><br><span class="line">192.168.20.23 | CHANGED =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;dest&quot;: &quot;/root/f1.sh&quot;, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0755&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;size&quot;: 0, </span><br><span class="line">    &quot;state&quot;: &quot;file&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line">192.168.20.22 | CHANGED =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;dest&quot;: &quot;/root/f1.sh&quot;, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0755&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;size&quot;: 0, </span><br><span class="line">    &quot;state&quot;: &quot;file&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>示例二：修改上例中文件的属主属组为xu：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"># ansible NginxWebs -m file -a &#x27;path=/root/f1.sh owner=xu group=xu&#x27;</span><br><span class="line">192.168.20.22 | CHANGED =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;gid&quot;: 1000, </span><br><span class="line">    &quot;group&quot;: &quot;xu&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0755&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;xu&quot;, </span><br><span class="line">    &quot;path&quot;: &quot;/root/f1.sh&quot;, </span><br><span class="line">    &quot;size&quot;: 0, </span><br><span class="line">    &quot;state&quot;: &quot;file&quot;, </span><br><span class="line">    &quot;uid&quot;: 1000</span><br><span class="line">&#125;</span><br><span class="line">192.168.20.23 | CHANGED =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;gid&quot;: 1000, </span><br><span class="line">    &quot;group&quot;: &quot;xu&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0755&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;xu&quot;, </span><br><span class="line">    &quot;path&quot;: &quot;/root/f1.sh&quot;, </span><br><span class="line">    &quot;size&quot;: 0, </span><br><span class="line">    &quot;state&quot;: &quot;file&quot;, </span><br><span class="line">    &quot;uid&quot;: 1000</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># ll /root/f1.sh </span><br><span class="line">-rwxr-xr-x 1 xu xu 0 Aug  1 22:22 /root/f1.sh</span><br></pre></td></tr></table></figure>

<p>示例三：创建目录&#x2F;root&#x2F;test&#x2F;，并设定属主、属组、权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"># ansible NginxWebs -m file -a &#x27;path=/root/test owner=root group=root mode=755 state=directory&#x27; </span><br><span class="line">192.168.20.23 | CHANGED =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0755&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;path&quot;: &quot;/root/test&quot;, </span><br><span class="line">    &quot;size&quot;: 6, </span><br><span class="line">    &quot;state&quot;: &quot;directory&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line">192.168.20.22 | CHANGED =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0755&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;path&quot;: &quot;/root/test&quot;, </span><br><span class="line">    &quot;size&quot;: 6, </span><br><span class="line">    &quot;state&quot;: &quot;directory&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># ll /root/test/ -d</span><br><span class="line">drwxr-xr-x 2 root root 6 Aug  1 22:26 /root/test/</span><br></pre></td></tr></table></figure>

<p>示例四：为&#x2F;root&#x2F;f1.sh创建软链接文件&#x2F;root&#x2F;f1.sh.link：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># ansible NginxWebs -m file -a &#x27;src=/root/f1.sh dest=/root/f1.sh.link state=link&#x27; </span><br><span class="line">192.168.20.23 | CHANGED =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;dest&quot;: &quot;/root/f1.sh.link&quot;, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0777&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;size&quot;: 11, </span><br><span class="line">    &quot;src&quot;: &quot;/root/f1.sh&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;link&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line">192.168.20.22 | CHANGED =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;dest&quot;: &quot;/root/f1.sh.link&quot;, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0777&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;size&quot;: 11, </span><br><span class="line">    &quot;src&quot;: &quot;/root/f1.sh&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;link&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># ll /root/f1.sh*</span><br><span class="line">-rwxr-xr-x 1 xu   xu    0 Aug  1 22:22 /root/f1.sh</span><br><span class="line">lrwxrwxrwx 1 root root 11 Aug  1 22:28 /root/f1.sh.link -&gt; /root/f1.sh</span><br></pre></td></tr></table></figure>

<p>示例五：删除以上示例中创建的目录和文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># ansible NginxWebs -m file -a &#x27;path=/root/f1.sh.link state=absent&#x27; </span><br><span class="line">192.168.20.23 | CHANGED =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;path&quot;: &quot;/root/f1.sh.link&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;absent&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.20.22 | CHANGED =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;path&quot;: &quot;/root/f1.sh.link&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;absent&quot;</span><br><span class="line">&#125;</span><br><span class="line"># ansible NginxWebs -m file -a &#x27;path=/root/f1.sh state=absent&#x27; </span><br><span class="line"></span><br><span class="line"># ansible NginxWebs -m file -a &#x27;path=/root/test state=absent&#x27; </span><br></pre></td></tr></table></figure>
<p>示例六：也可以删除一级目录（挂载点)，会报错，但是可以清楚数据：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> #ansible app -m file -a &#x27;dest=/data/ state=absent&#x27;</span><br><span class="line">192.168.169.130 | FAILED! =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,      &lt;==报错</span><br><span class="line"></span><br><span class="line"> #ansible app  -a &#x27;ls -l /data/&#x27;</span><br><span class="line">total 0               &lt;==数据已经清空</span><br></pre></td></tr></table></figure>
<p>示例七：递归授权目录，类似于-R的作用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># ansible webservers -m file -a &quot;path=/tmp/foo state=directory owner=root group=root mode=777 recurse=yes&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="7-yum模块"><a href="#7-yum模块" class="headerlink" title="7)yum模块"></a>7)yum模块</h2><p>功能：管理软件包，需要确认被管理端为红帽系列的，并且需要被管理端配置好yum源。</p>
<p>主要的参数如下：</p>
<pre><code>    name            指定安装软件包名或软件包URL
    state           指定yum对应的方法，present(Defaults)表示安装；absent表示卸载；latest表示安装最新版本软件包，支持多程序一起安装，用逗号隔开
    enablerepo      允许从哪些仓库获取软件
    disablerepo     禁止从哪些仓库获取软件
    exclude         排除某些软件包，例如kernel
    download_only   仅下载软件包，不安装
    disable_gpg_check   不进行gpg检测
    update_cache        可以在安装包的同时更新yum缓存
</code></pre>
<p>示例一：在被控端安装vsftpd，apache软件包：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># ansible 192.168.20.23 -m yum -a &#x27;name=vsftpd,httpd state=present&#x27;</span><br><span class="line">192.168.20.23 | CHANGED =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;changes&quot;: &#123;</span><br><span class="line">        &quot;installed&quot;: [</span><br><span class="line">            &quot;vsftpd&quot;, </span><br><span class="line">            &quot;httpd&quot;</span><br><span class="line">        ]</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;msg&quot;: &quot;&quot;, </span><br><span class="line">    &quot;rc&quot;: 0, </span><br><span class="line">    &quot;results&quot;: [</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># rpm -q httpd</span><br><span class="line">httpd-2.4.6-93.el7.centos.x86_64</span><br><span class="line"># rpm -q vsftpd</span><br><span class="line">vsftpd-3.0.2-27.el7.x86_64</span><br></pre></td></tr></table></figure>
<p>示例二：安装当前最新的Apache软件，通过epel仓库安装：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ansible webservers -m yum -a &quot;name=httpd state=present enablerepo=epel&quot;</span><br></pre></td></tr></table></figure>
<p>示例三：通过公网URL安装 rpm 软件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ansible webservers -m yum -a &quot;name=https://xx.rpm state=present&quot;</span><br></pre></td></tr></table></figure>
<p>示例四：卸载被控主机的vsftpd，apache软件包：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ansible 192.168.20.23 -m yum -a &#x27;name=vsftpd,httpd state=absent&#x27;</span><br></pre></td></tr></table></figure>
<p>示例五：安装最新版本的 Apache 软件，如果存在则更新 Apache：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ansible webservers -m yum -a &quot;name=httpd state=latest</span><br></pre></td></tr></table></figure>
<p>示例六：更新所有的软件包，但排除和kernel相关的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ansible webservers -m yum -a &quot;name=* state=latest exclude=kernel&quot;</span><br></pre></td></tr></table></figure>

<h2 id="8-systemd模块"><a href="#8-systemd模块" class="headerlink" title="8)systemd模块"></a>8)systemd模块</h2><p>功能：管理服务启动与停止，与 service 模块用法一致；</p>
<p>主要参数如下：</p>
<pre><code>    name        指定需要控制的服务名称
    state       指定服务状态，其值可以为stopped、started、reloaded、restarted、running
    enabled         指定服务是否为开机启动，yes为启动，no为不启动
    daemon_reload   yes：重启systemd服务，让unit文件生效
</code></pre>
<p>示例一：启动nginx服务，并设置为开机自启：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ansible 192.168.20.23 -m service -a &#x27;name=nginx state=started enabled=yes&#x27;</span><br></pre></td></tr></table></figure>
<p>示例二：重新启动nginx服务：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ansible 192.168.20.23 -m service -a &#x27;name=nginx state=restarted&#x27;</span><br></pre></td></tr></table></figure>
<p>示例三：重载nginx服务：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ansible 192.168.20.23 -m service -a &#x27;name=nginx state=reloaded&#x27;</span><br></pre></td></tr></table></figure>
<p>示例四：停止nginx服务：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ansible 192.168.20.23 -m service -a &#x27;name=nginx state=stopped&#x27;</span><br></pre></td></tr></table></figure>


<h2 id="9-cron模块"><a href="#9-cron模块" class="headerlink" title="9)cron模块"></a>9)cron模块</h2><p>功能：管理被控端计划任务；</p>
<p>主要参数如下：</p>
<pre><code>    参数 	说明
    name 	定时任务基本描述
    job 	定时任务要执行的命令
    minute 	分
    hour 	小时
    day 	日
    month 	月
    weekday 	周，0-6
    disabled 	yes：禁用计划任务，no：启用计划任务
        absent：删除计划任务
</code></pre>
<p>示例一：创建计划任务，每10分钟执行一次同步时间，将此计划任务命名为synctime；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># ansible NginxWebs -m cron -a &#x27;name=&quot;synctime&quot; job=&quot;ntpdate 192.168.20.1 &amp;&gt; /dev/null&quot; minute=*/10&#x27;</span><br><span class="line"></span><br><span class="line"># crontab -l</span><br><span class="line">#Ansible: synctime</span><br><span class="line">*/10 * * * * ntpdate 192.168.20.1 &amp;&gt; /dev/null</span><br></pre></td></tr></table></figure>

<p>示例二：添加定时任务， 每天的凌晨2点和凌晨5点执行一次ls：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># ansible NginxWebs -m cron -a &#x27;name=&quot;ls&quot; job=&quot;ls &amp;&gt; /dev/null&quot; minute=0 hour=2,5&#x27;</span><br><span class="line"></span><br><span class="line"># crontab -l</span><br><span class="line">#Ansible: synctime</span><br><span class="line">*/10 * * * * ntpdate 192.168.20.1 &amp;&gt; /dev/null</span><br><span class="line">#Ansible: ls</span><br><span class="line">0 2,5 * * * ls &amp;&gt; /dev/null</span><br></pre></td></tr></table></figure>

<p>示例三：禁用上面示例的计划任务：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># ansible NginxWebs -m cron -a &#x27;name=&quot;ls&quot; job=&quot;ls &amp;&gt; /dev/null&quot; minute=0 hour=2,5 disabled=yes&#x27;</span><br><span class="line"></span><br><span class="line"># ansible NginxWebs -m cron -a &#x27;name=&quot;synctime&quot; job=&quot;ntpdate 192.168.20.1 &amp;&gt; /dev/null&quot; minute=*/10 disabled=yes&#x27;</span><br><span class="line"></span><br><span class="line">#被控主机被注释掉了</span><br><span class="line"># crontab -l</span><br><span class="line">#Ansible: synctime</span><br><span class="line">#*/10 * * * * ntpdate 192.168.20.1 &amp;&gt; /dev/null</span><br><span class="line">#Ansible: ls</span><br><span class="line">#0 2,5 * * * ls &amp;&gt; /dev/null</span><br></pre></td></tr></table></figure>

<p>示例四：删除上述的计划任务：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># ansible NginxWebs -m cron -a &#x27;name=&quot;synctime&quot; state=absent&#x27;</span><br><span class="line"></span><br><span class="line"># ansible NginxWebs -m cron -a &#x27;name=&quot;ls&quot; state=absent&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="10-get-url模块"><a href="#10-get-url模块" class="headerlink" title="10)get_url模块"></a>10)get_url模块</h2><p>功能：通过互联网下载软件至被控端本地；</p>
<pre><code>    主要参数如下：
    参数 	说明
    url 	资源文件在互联网上的具体url地址
    dest 	文件下载位置的绝对路径
    mode 	文件下载位置的绝对路径
    checksum 	对下载的资源进行校验
    timeout 	URL请求超时时间，默认10s
</code></pre>
<p>示例一：下载互联网的软件至本地：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ansible webservers -m get_url -a &quot;url=https://raw.githubusercontent.com/psf/black/main/README.md dest=/tmp&quot;</span><br></pre></td></tr></table></figure>

<p>示例二：下载互联网文件并进行 md5 校验：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ansible webservers -m get_url -a &quot;url=http,https dest=/opt checksum=md5:76eb3af80ffd&quot;</span><br></pre></td></tr></table></figure>


<h2 id="11-mount模块"><a href="#11-mount模块" class="headerlink" title="11)mount模块"></a>11)mount模块</h2><p>功能：管理被控端设备挂载；</p>
<pre><code>    主要参数如下：
    参数 	说明
    src 	本地或远程设备的路径
    path 	设备挂载至本地的路径
    fstype 	挂载的文件系统类型，xfs、nfs...
    opts 	挂载的参数，defaults、ro...
    state 	挂载的状态，absent、mounted、unmounted
</code></pre>
<p>环境准备：将 ansible 作为 nfs 服务端， 192.168.20.22、192.168.20.23 作为 nfs客户端挂载；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># ansible localhost -m yum -a &#x27;name=nfs-utils state=present&#x27;</span><br><span class="line"></span><br><span class="line"># ansible localhost -m file -a &#x27;path=/data/nfs/ owner=nginx group=nginx state=directory&#x27;</span><br><span class="line"></span><br><span class="line"># ansible localhost -m copy -a &#x27;dest=/etc/exports content=&quot;/data/nfs 192.168.20.0/24(rw,all_squash,anonuid=887,anongid=887)\n&quot;&#x27;</span><br><span class="line"></span><br><span class="line"># ansible localhost -m service -a &#x27;name=nfs-server state=started&#x27;</span><br><span class="line"></span><br><span class="line"># exportfs -arv</span><br><span class="line">exporting 192.168.20.0/24:/data/nfs</span><br></pre></td></tr></table></figure>

<p>示例一：挂载 nfs 至本地的 &#x2F;opt 目录，并实现开机自动挂载：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># ansible NginxWebs -m mount -a &#x27;src=192.168.20.17:/data/nfs path=/opt fstype=nfs opts=defaults state=mounted&#x27;</span><br><span class="line"></span><br><span class="line"># df </span><br><span class="line">Filesystem              1K-blocks    Used Available Use% Mounted on</span><br><span class="line">192.168.20.17:/data/nfs 154057344   33280 154024064   1% /opt</span><br><span class="line"></span><br><span class="line"># cat /etc/fstab </span><br><span class="line">192.168.20.17:/data/nfs /opt nfs defaults 0 0</span><br></pre></td></tr></table></figure>

<p>示例二：临时卸载 nfs 的挂载，但不清理 &#x2F;etc&#x2F;fstab ：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ansible NginxWebs -m mount -a &#x27;src=192.168.20.17:/data/nfs path=/opt fstype=nfs opts=defaults state=unmounted&#x27;</span><br></pre></td></tr></table></figure>

<p>示例三：永久卸载 nfs 挂载，同时清理 &#x2F;etc&#x2F;fstab：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ansible NginxWebs -m mount -a &#x27;src=192.168.20.17:/data/nfs path=/opt fstype=nfs opts=defaults state=absent&#x27;</span><br></pre></td></tr></table></figure>


<h2 id="12-archive模块"><a href="#12-archive模块" class="headerlink" title="12)archive模块"></a>12)archive模块</h2><p>功能：在远端主机打包与压缩；</p>
<pre><code>主要参数如下：
参数 	说明
path 	要压缩的文件或目录
dest 	压缩后的文件
format 	指定打包压缩的类型：bz2、gz、tar、xz、zip
</code></pre>
<p>示例一：将 &#x2F;var&#x2F;log 目录压缩为 tar.gz 格式，并存储至 &#x2F;opt 目录下；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># ansible 192.168.20.23 -m archive -a &#x27;path=/var/log dest=/opt/log.tar.gz format=gz&#x27;</span><br><span class="line"></span><br><span class="line"># ll /opt</span><br><span class="line">total 692</span><br><span class="line">-rw-r--r-- 1 root root 705807 Aug  2 15:22 log.tar.gz</span><br></pre></td></tr></table></figure>


<h2 id="13-unarchive模块"><a href="#13-unarchive模块" class="headerlink" title="13)unarchive模块"></a>13)unarchive模块</h2><p>功能：在远端主机解包与解压缩；</p>
<pre><code>主要参数如下：
参数 	说明
src 	要解压的软件包路径
dest 	解压到目标位置，需要是一个目录
remote_src 	yes：要解压的包在被控端、no：要解压的包在控制端
owner 	文件复制到远程并设定属主，默认为root
group 	文件复制到远程并设定属组，默认为root
mode 	文件复制到远程并设定权限，默认file=644，directory=755
</code></pre>
<p>示例一：把压缩包推送到被控端，在被控端主机解压缩：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#把压缩包拷贝到远端主机：</span><br><span class="line"># ansible 192.168.20.23 -m copy -a &#x27;src=/root/nginx-1.20.1.tar.gz dest=/tmp/&#x27;</span><br><span class="line"></span><br><span class="line">#在远端主机解压缩：</span><br><span class="line"># ansible 192.168.20.23 -m copy -a &#x27;src=/tmp/nginx-1.20.1.tar.gz dest=/tmp/nginx-1.20.1 remote_src=yes&#x27;</span><br></pre></td></tr></table></figure>
<p>示例二：压缩包在ansible主机上，直接解压到被控主机：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># ansible 192.168.20.23 -m unarchive -a &#x27;src=/root/nginx-1.20.1.tar.gz dest=/tmp/&#x27;</span><br><span class="line"></span><br><span class="line"># ll /tmp/</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x 8 xu1 xu1 158 May 25 20:35 nginx-1.20.1</span><br></pre></td></tr></table></figure>


<h2 id="14-selinux模块"><a href="#14-selinux模块" class="headerlink" title="14)selinux模块"></a>14)selinux模块</h2><p>功能：管理远端主机的 SELINUX 防火墙；</p>
<pre><code>主要参数如下：
参数 	说明
state 	Selinux模式：enforcing、permissive、disabled
polocy 	targeted
</code></pre>
<p>示例一：设置 selinux 为 enforcing</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># ansible 192.168.20.23 -m selinux -a &#x27;state=enforcing policy=targeted&#x27;</span><br><span class="line"></span><br><span class="line"># grep &quot;^SELINUX&quot; /etc/selinux/config</span><br><span class="line">SELINUX=enforcing</span><br><span class="line">SELINUXTYPE=targeted</span><br></pre></td></tr></table></figure>
<p>示例二：设置 selinux 为 disabled：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># ansible 192.168.20.23 -m selinux -a &#x27;state=disabled&#x27;</span><br><span class="line"></span><br><span class="line"># grep &quot;^SELINUX&quot; /etc/selinux/config</span><br><span class="line">SELINUX=disabled</span><br><span class="line">SELINUXTYPE=targeted</span><br></pre></td></tr></table></figure>


<h2 id="15-service-模块"><a href="#15-service-模块" class="headerlink" title="15)service 模块"></a>15)service 模块</h2><p>该模块用于服务程序的管理。<br>　　<br>其主要选项如下：</p>
<pre><code>    arguments #命令行提供额外的参数
    enabled #设置开机启动。
    name= #服务名称
    runlevel #开机启动的级别，一般不用指定。
    sleep #在重启服务的过程中，是否等待。如在服务关闭以后等待2秒再启动。(定义在剧本中。)
    state #有四种状态，分别为：started---&gt;启动服务， stopped---&gt;停止服务， restarted---&gt;重启服务， reloaded---&gt;重载配置
</code></pre>
<p>示例1 开启服务并设置自启动</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># ansible web -m service -a &#x27;name=nginx state=started enabled=true&#x27; </span><br><span class="line">192.168.37.122 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;enabled&quot;: true, </span><br><span class="line">    &quot;name&quot;: &quot;nginx&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;started&quot;, </span><br><span class="line">    ……</span><br><span class="line">&#125;</span><br><span class="line">192.168.37.133 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;enabled&quot;: true, </span><br><span class="line">    &quot;name&quot;: &quot;nginx&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;started&quot;, </span><br><span class="line">    ……</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>我们可以去查看一下端口是否打开：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># ansible web -m shell -a &#x27;ss -ntl&#x27;</span><br><span class="line">192.168.37.122 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">LISTEN     0      128          *:80                       *:*                                  </span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">State      Recv-Q Send-Q Local Address:Port               Peer Address:Port                    </span><br><span class="line">LISTEN     0      128          *:80                       *:*   </span><br></pre></td></tr></table></figure>
<p>示例2 关闭服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># ansible web -m service -a &#x27;name=nginx state=stopped&#x27;</span><br><span class="line">192.168.37.122 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;name&quot;: &quot;nginx&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;stopped&quot;, </span><br><span class="line">	……</span><br><span class="line">&#125;</span><br><span class="line">192.168.37.133 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;name&quot;: &quot;nginx&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;stopped&quot;, </span><br><span class="line">	……</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># ansible web -m shell -a &#x27;ss -ntl | grep 80&#x27;</span><br><span class="line">192.168.37.122 | FAILED | rc=1 &gt;&gt;</span><br><span class="line"></span><br><span class="line">192.168.37.133 | FAILED | rc=1 &gt;&gt;</span><br></pre></td></tr></table></figure>

<h2 id="16）user-模块"><a href="#16）user-模块" class="headerlink" title="16）user 模块"></a>16）user 模块</h2><p>该模块主要是用来管理用户账号。<br>　　<br>其主要选项如下：</p>
<pre><code>comment　　# 用户的描述信息
createhome　　# 是否创建家目录
force　　# 在使用state=absent时, 行为与userdel –force一致.
group　　# 指定基本组
groups　　# 指定附加组，如果指定为(groups=)表示删除所有组
home　　# 指定用户家目录
move_home　　# 如果设置为home=时, 试图将用户主目录移动到指定的目录
name　　# 指定用户名
non_unique　　# 该选项允许改变非唯一的用户ID值
password　　# 指定用户密码
remove　　# 在使用state=absent时, 行为是与userdel –remove一致
shell　　# 指定默认shell
state　　# 设置帐号状态，不指定为创建，指定值为absent表示删除
system　　# 当创建一个用户，设置这个用户是系统用户。这个设置不能更改现有用户
uid　　# 指定用户的uid
</code></pre>
<p>① 添加一个用户并指定其 uid</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># ansible web -m user -a &#x27;name=keer uid=11111&#x27;</span><br><span class="line">192.168.37.122 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;comment&quot;: &quot;&quot;, </span><br><span class="line">    &quot;createhome&quot;: true, </span><br><span class="line">    &quot;group&quot;: 11111, </span><br><span class="line">    &quot;home&quot;: &quot;/home/keer&quot;, </span><br><span class="line">    &quot;name&quot;: &quot;keer&quot;, </span><br><span class="line">    &quot;shell&quot;: &quot;/bin/bash&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;present&quot;, </span><br><span class="line">    &quot;stderr&quot;: &quot;useradd: warning: the home directory already exists.\nNot copying any file from skel directory into it.\nCreating mailbox file: File exists\n&quot;, </span><br><span class="line">    &quot;system&quot;: false, </span><br><span class="line">    &quot;uid&quot;: 11111</span><br><span class="line">&#125;</span><br><span class="line">192.168.37.133 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;comment&quot;: &quot;&quot;, </span><br><span class="line">    &quot;createhome&quot;: true, </span><br><span class="line">    &quot;group&quot;: 11111, </span><br><span class="line">    &quot;home&quot;: &quot;/home/keer&quot;, </span><br><span class="line">    &quot;name&quot;: &quot;keer&quot;, </span><br><span class="line">    &quot;shell&quot;: &quot;/bin/bash&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;present&quot;, </span><br><span class="line">    &quot;stderr&quot;: &quot;useradd: warning: the home directory already exists.\nNot copying any file from skel directory into it.\nCreating mailbox file: File exists\n&quot;, </span><br><span class="line">    &quot;system&quot;: false, </span><br><span class="line">    &quot;uid&quot;: 11111</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　添加完成，我们可以去查看一下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># ansible web -m shell -a &#x27;cat /etc/passwd |grep keer&#x27;</span><br><span class="line">192.168.37.122 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">keer:x:11111:11111::/home/keer:/bin/bash</span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">keer:x:11111:11111::/home/keer:/bin/bash</span><br></pre></td></tr></table></figure>


<p>② 删除用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># ansible web -m user -a &#x27;name=keer state=absent&#x27;</span><br><span class="line">192.168.37.122 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;force&quot;: false, </span><br><span class="line">    &quot;name&quot;: &quot;keer&quot;, </span><br><span class="line">    &quot;remove&quot;: false, </span><br><span class="line">    &quot;state&quot;: &quot;absent&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.37.133 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;force&quot;: false, </span><br><span class="line">    &quot;name&quot;: &quot;keer&quot;, </span><br><span class="line">    &quot;remove&quot;: false, </span><br><span class="line">    &quot;state&quot;: &quot;absent&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　一样的，删除之后，我们去看一下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># ansible web -m shell -a &#x27;cat /etc/passwd |grep keer&#x27;</span><br><span class="line">192.168.37.122 | FAILED | rc=1 &gt;&gt;</span><br><span class="line"></span><br><span class="line">192.168.37.133 | FAILED | rc=1 &gt;&gt;</span><br></pre></td></tr></table></figure>
<p>　　发现已经没有这个用户了。</p>
<h2 id="17）group-模块"><a href="#17）group-模块" class="headerlink" title="17）group 模块"></a>17）group 模块</h2><p>该模块主要用于添加或删除组。
　　</p>
<pre><code>常用的选项如下：

gid=　　#设置组的GID号
name=　　#指定组的名称
state=　　#指定组的状态，默认为创建，设置值为absent为删除
system=　　#设置值为yes，表示创建为系统组
</code></pre>
<p>① 创建组</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># ansible web -m group -a &#x27;name=sanguo gid=12222&#x27;</span><br><span class="line">192.168.37.122 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;gid&quot;: 12222, </span><br><span class="line">    &quot;name&quot;: &quot;sanguo&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;present&quot;, </span><br><span class="line">    &quot;system&quot;: false</span><br><span class="line">&#125;</span><br><span class="line">192.168.37.133 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;gid&quot;: 12222, </span><br><span class="line">    &quot;name&quot;: &quot;sanguo&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;present&quot;, </span><br><span class="line">    &quot;system&quot;: false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　创建过后，我们来查看一下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># ansible web -m shell -a &#x27;cat /etc/group | grep 12222&#x27; </span><br><span class="line">192.168.37.122 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">sanguo:x:12222:</span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">sanguo:x:12222:</span><br></pre></td></tr></table></figure>
<p>　　可以看出，我们的组已经创建成功了。</p>
<p>② 删除组</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># ansible web -m group -a &#x27;name=sanguo state=absent&#x27;</span><br><span class="line">192.168.37.122 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;name&quot;: &quot;sanguo&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;absent&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.37.133 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;name&quot;: &quot;sanguo&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;absent&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　照例查看一下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># ansible web -m shell -a &#x27;cat /etc/group | grep 12222&#x27; </span><br><span class="line">192.168.37.122 | FAILED | rc=1 &gt;&gt;</span><br><span class="line"></span><br><span class="line">192.168.37.133 | FAILED | rc=1 &gt;&gt;</span><br></pre></td></tr></table></figure>
<p>　　已经没有这个组的相关信息了。</p>
<h2 id="18）script-模块"><a href="#18）script-模块" class="headerlink" title="18）script 模块"></a>18）script 模块</h2><p>该模块用于将本机的脚本在被管理端的机器上运行。</p>
<p>　　该模块直接指定脚本的路径即可，我们通过例子来看一看到底如何使用的：</p>
<p>首先，我们写一个脚本，并给其加上执行权限：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># vim /tmp/df.sh</span><br><span class="line">	#!/bin/bash</span><br><span class="line"></span><br><span class="line">	date &gt;&gt; /tmp/disk_total.log</span><br><span class="line">	df -lh &gt;&gt; /tmp/disk_total.log </span><br><span class="line"># chmod +x /tmp/df.sh </span><br></pre></td></tr></table></figure>
<p>　　然后，我们直接运行命令来实现在被管理端执行该脚本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># ansible web -m script -a &#x27;/tmp/df.sh&#x27;</span><br><span class="line">192.168.37.122 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;rc&quot;: 0, </span><br><span class="line">    &quot;stderr&quot;: &quot;Shared connection to 192.168.37.122 closed.\r\n&quot;, </span><br><span class="line">    &quot;stdout&quot;: &quot;&quot;, </span><br><span class="line">    &quot;stdout_lines&quot;: []</span><br><span class="line">&#125;</span><br><span class="line">192.168.37.133 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;rc&quot;: 0, </span><br><span class="line">    &quot;stderr&quot;: &quot;Shared connection to 192.168.37.133 closed.\r\n&quot;, </span><br><span class="line">    &quot;stdout&quot;: &quot;&quot;, </span><br><span class="line">    &quot;stdout_lines&quot;: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　照例查看一下文件内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># ansible web -m shell -a &#x27;cat /tmp/disk_total.log&#x27;</span><br><span class="line">192.168.37.122 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">Tue Dec  5 15:58:21 CST 2017</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sda2        47G  4.4G   43G  10% /</span><br><span class="line">devtmpfs        978M     0  978M   0% /dev</span><br><span class="line">tmpfs           993M   84K  993M   1% /dev/shm</span><br><span class="line">tmpfs           993M  9.1M  984M   1% /run</span><br><span class="line">tmpfs           993M     0  993M   0% /sys/fs/cgroup</span><br><span class="line">/dev/sda3        47G   33M   47G   1% /app</span><br><span class="line">/dev/sda1       950M  153M  798M  17% /boot</span><br><span class="line">tmpfs           199M   16K  199M   1% /run/user/42</span><br><span class="line">tmpfs           199M     0  199M   0% /run/user/0</span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">Tue Dec  5 15:58:21 CST 2017</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sda2        46G  4.1G   40G  10% /</span><br><span class="line">devtmpfs        898M     0  898M   0% /dev</span><br><span class="line">tmpfs           912M   84K  912M   1% /dev/shm</span><br><span class="line">tmpfs           912M  9.0M  903M   1% /run</span><br><span class="line">tmpfs           912M     0  912M   0% /sys/fs/cgroup</span><br><span class="line">/dev/sda3       3.7G   15M  3.4G   1% /app</span><br><span class="line">/dev/sda1       1.9G  141M  1.6G   9% /boot</span><br><span class="line">tmpfs           183M   16K  183M   1% /run/user/42</span><br><span class="line">tmpfs           183M     0  183M   0% /run/user/0</span><br></pre></td></tr></table></figure>
<p>　　可以看出已经执行成功了。</p>
<h2 id="19）setup-模块"><a href="#19）setup-模块" class="headerlink" title="19）setup 模块"></a>19）setup 模块</h2><p>该模块主要用于收集信息，是通过调用facts组件来实现的。</p>
<p>　　facts组件是Ansible用于采集被管机器设备信息的一个功能，我们可以使用setup模块查机器的所有facts信息，可以使用filter来查看指定信息。整个facts信息被包装在一个JSON格式的数据结构中，ansible_facts是最上层的值。</p>
<p>　　facts就是变量，内建变量 。每个主机的各种信息，cpu颗数、内存大小等。会存在facts中的某个变量中。调用后返回很多对应主机的信息，在后面的操作中可以根据不同的信息来做不同的操作。如redhat系列用yum安装，而debian系列用apt来安装软件。</p>
<p>① 查看信息<br>　　我们可以直接用命令获取到变量的值，具体我们来看看例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"># ansible web -m setup -a &#x27;filter=&quot;*mem*&quot;&#x27;	#查看内存</span><br><span class="line">192.168.37.122 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;ansible_memfree_mb&quot;: 1116, </span><br><span class="line">        &quot;ansible_memory_mb&quot;: &#123;</span><br><span class="line">            &quot;nocache&quot;: &#123;</span><br><span class="line">                &quot;free&quot;: 1397, </span><br><span class="line">                &quot;used&quot;: 587</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;real&quot;: &#123;</span><br><span class="line">                &quot;free&quot;: 1116, </span><br><span class="line">                &quot;total&quot;: 1984, </span><br><span class="line">                &quot;used&quot;: 868</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;swap&quot;: &#123;</span><br><span class="line">                &quot;cached&quot;: 0, </span><br><span class="line">                &quot;free&quot;: 3813, </span><br><span class="line">                &quot;total&quot;: 3813, </span><br><span class="line">                &quot;used&quot;: 0</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;ansible_memtotal_mb&quot;: 1984</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: false</span><br><span class="line">&#125;</span><br><span class="line">192.168.37.133 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;ansible_memfree_mb&quot;: 1203, </span><br><span class="line">        &quot;ansible_memory_mb&quot;: &#123;</span><br><span class="line">            &quot;nocache&quot;: &#123;</span><br><span class="line">                &quot;free&quot;: 1470, </span><br><span class="line">                &quot;used&quot;: 353</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;real&quot;: &#123;</span><br><span class="line">                &quot;free&quot;: 1203, </span><br><span class="line">                &quot;total&quot;: 1823, </span><br><span class="line">                &quot;used&quot;: 620</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;swap&quot;: &#123;</span><br><span class="line">                &quot;cached&quot;: 0, </span><br><span class="line">                &quot;free&quot;: 3813, </span><br><span class="line">                &quot;total&quot;: 3813, </span><br><span class="line">                &quot;used&quot;: 0</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;ansible_memtotal_mb&quot;: 1823</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　我们可以通过命令查看一下内存的大小以确认一下是否一致：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># ansible web -m shell -a &#x27;free -m&#x27;</span><br><span class="line">192.168.37.122 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:           1984         404        1122           9         457        1346</span><br><span class="line">Swap:          3813           0        3813</span><br><span class="line"></span><br><span class="line">192.168.37.133 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:           1823         292        1207           9         323        1351</span><br><span class="line">Swap:          3813           0        3813</span><br></pre></td></tr></table></figure>
<p>　　可以看出信息是一致的。</p>
<p>② 保存信息</p>
<p>我们的setup模块还有一个很好用的功能就是可以保存我们所筛选的信息至我们的主机上，同时，文件名为我们被管制的主机的IP，这样方便我们知道是哪台机器出的问题。</p>
<p>　　<br>我们可以看一看例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"># ansible web -m setup -a &#x27;filter=&quot;*mem*&quot;&#x27; --tree /tmp/facts</span><br><span class="line">192.168.37.122 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;ansible_memfree_mb&quot;: 1115, </span><br><span class="line">        &quot;ansible_memory_mb&quot;: &#123;</span><br><span class="line">            &quot;nocache&quot;: &#123;</span><br><span class="line">                &quot;free&quot;: 1396, </span><br><span class="line">                &quot;used&quot;: 588</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;real&quot;: &#123;</span><br><span class="line">                &quot;free&quot;: 1115, </span><br><span class="line">                &quot;total&quot;: 1984, </span><br><span class="line">                &quot;used&quot;: 869</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;swap&quot;: &#123;</span><br><span class="line">                &quot;cached&quot;: 0, </span><br><span class="line">                &quot;free&quot;: 3813, </span><br><span class="line">                &quot;total&quot;: 3813, </span><br><span class="line">                &quot;used&quot;: 0</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;ansible_memtotal_mb&quot;: 1984</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: false</span><br><span class="line">&#125;</span><br><span class="line">192.168.37.133 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;ansible_memfree_mb&quot;: 1199, </span><br><span class="line">        &quot;ansible_memory_mb&quot;: &#123;</span><br><span class="line">            &quot;nocache&quot;: &#123;</span><br><span class="line">                &quot;free&quot;: 1467, </span><br><span class="line">                &quot;used&quot;: 356</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;real&quot;: &#123;</span><br><span class="line">                &quot;free&quot;: 1199, </span><br><span class="line">                &quot;total&quot;: 1823, </span><br><span class="line">                &quot;used&quot;: 624</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;swap&quot;: &#123;</span><br><span class="line">                &quot;cached&quot;: 0, </span><br><span class="line">                &quot;free&quot;: 3813, </span><br><span class="line">                &quot;total&quot;: 3813, </span><br><span class="line">                &quot;used&quot;: 0</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;ansible_memtotal_mb&quot;: 1823</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　然后我们可以去查看一下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># cd /tmp/facts/</span><br><span class="line"># ls</span><br><span class="line">192.168.37.122  192.168.37.133</span><br><span class="line"># cat 192.168.37.122 </span><br><span class="line">&#123;&quot;ansible_facts&quot;: &#123;&quot;ansible_memfree_mb&quot;: 1115, &quot;ansible_memory_mb&quot;: &#123;&quot;nocache&quot;: &#123;&quot;free&quot;: 1396, &quot;used&quot;: 588&#125;, &quot;real&quot;: &#123;&quot;free&quot;: 1115, &quot;total&quot;: 1984, &quot;used&quot;: 869&#125;, &quot;swap&quot;: &#123;&quot;cached&quot;: 0, &quot;free&quot;: 3813, &quot;total&quot;: 3813, &quot;used&quot;: 0&#125;&#125;, &quot;ansible_memtotal_mb&quot;: 1984&#125;, &quot;changed&quot;: false&#125;</span><br></pre></td></tr></table></figure>



<h1 id="ansible执行原理分析"><a href="#ansible执行原理分析" class="headerlink" title="ansible执行原理分析"></a>ansible执行原理分析</h1><p>执行之后 主控节点上会是这样的几个进程：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">│   │                   └─bash,224417</span><br><span class="line">│   │                       └─ansible,228966 /home/conda/envs/ansible/bin/ansible bf -i hosts -m command -a sleep 100</span><br><span class="line">│   │                           ├─ansible,228971 /home/conda/envs/ansible/bin/ansible bf -i hosts -m command -a sleep 100</span><br><span class="line">│   │                           │   └─ssh,229034 -C -o ControlMaster=auto -o ControlPersist=60s -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o User=&quot;ansible&quot; -o ConnectTimeout=10 -o ControlPath=/work/jenkins/.ansible/cp/fd15400aed -tt 192.168.xxx.31 /bin/sh -c &#x27;/usr/bin/python3 /home/ansible/.ansible/tmp/ansible-tmp-1638944600.2393298-228971-228771323588639/AnsiballZ_command.py &amp;&amp; sleep 0&#x27;</span><br><span class="line">│   │                           ├─ansible,228972 /home/conda/envs/ansible/bin/ansible bf -i hosts -m command -a sleep 100</span><br><span class="line">│   │                           │   └─ssh,229035 -C -o ControlMaster=auto -o ControlPersist=60s -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o User=&quot;ansible&quot; -o ConnectTimeout=10 -o ControlPath=/work/jenkins/.ansible/cp/0a0c5feff5 -tt 192.168.xxx.32 /bin/sh -c &#x27;/usr/bin/python3 /home/ansible/.ansible/tmp/ansible-tmp-1638944600.239494-228972-9855025113577/AnsiballZ_command.py &amp;&amp; sleep 0&#x27;</span><br><span class="line">│   │                           ├─ansible,228974 /home/conda/envs/ansible/bin/ansible bf -i hosts -m command -a sleep 100</span><br><span class="line">│   │                           │   └─ssh,229033 -C -o ControlMaster=auto -o ControlPersist=60s -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o User=&quot;ansible&quot; -o ConnectTimeout=10 -o ControlPath=/work/jenkins/.ansible/cp/bc143f4fd4 -tt 192.168.xxx.33 /bin/sh -c &#x27;/usr/bin/python3 /home/ansible/.ansible/tmp/ansible-tmp-1638944600.2476149-228974-207118697615073/AnsiballZ_command.py &amp;&amp; sleep 0&#x27;</span><br><span class="line">│   │                           ├─ansible,228976 /home/conda/envs/ansible/bin/ansible bf -i hosts -m command -a sleep 100</span><br><span class="line">│   │                           │   └─ssh,229036 -C -o ControlMaster=auto -o ControlPersist=60s -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o User=&quot;ansible&quot; -o ConnectTimeout=10 -o ControlPath=/work/jenkins/.ansible/cp/bfd44f17d4 -tt 192.168.xxx.34 /bin/sh -c &#x27;/usr/bin/python3 /home/ansible/.ansible/tmp/ansible-tmp-1638944600.255245-228976-274177687105611/AnsiballZ_command.py &amp;&amp; sleep 0&#x27;</span><br><span class="line">│   │                           ├─ansible,228979 /home/conda/envs/ansible/bin/ansible bf -i hosts -m command -a sleep 100</span><br><span class="line">│   │                           │   └─ssh,229032 -C -o ControlMaster=auto -o ControlPersist=60s -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o User=&quot;ansible&quot; -o ConnectTimeout=10 -o ControlPath=/work/jenkins/.ansible/cp/278053c7e1 -tt 192.168.xxx.35 /bin/sh -c &#x27;/usr/bin/python3 /home/ansible/.ansible/tmp/ansible-tmp-1638944600.2513506-228979-200134538240917/AnsiballZ_command.py &amp;&amp; sleep 0&#x27;</span><br><span class="line">│   │                           └─&#123;ansible&#125;,228970</span><br></pre></td></tr></table></figure>

<h2 id="1-当我们执行ansible命令-之后发生了什么？"><a href="#1-当我们执行ansible命令-之后发生了什么？" class="headerlink" title="1. 当我们执行ansible命令 之后发生了什么？"></a>1. 当我们执行ansible命令 之后发生了什么？</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.xxx.31 -f 1 -m command -a &#x27;sleep 100&#x27; -o</span><br><span class="line"></span><br><span class="line">主控节点上执行如下：</span><br><span class="line">ansible,832930 /home/conda/envs/ansible/bin/ansible 192.168.xxx.31 -f 1 -m command -a sleep 100 -o</span><br><span class="line">  ├─ansible,833070 /home/conda/envs/ansible/bin/ansible 192.168.xxx.31 -f 1 -m command -a sleep 100 -o</span><br><span class="line">  └─ssh,833089 -C -o ControlMaster=auto -o ControlPersist=60s -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o User=&quot;ansible&quot; -o ConnectTimeout=10 -o ControlPath=/tmp/ansibletmpl/cp/ansible-ssh-%h-%p-%r -tt 192.168.xxx.31 /bin/bash -c &#x27;/usr/bin/python3 /tmp/ansibletmpr/ansible-tmp-1638962875.8801572-833070-192363216003291/AnsiballZ_command.py &amp;&amp; sleep 0&#x27;</span><br><span class="line">  │   └─&#123;ansible&#125;,833069</span><br><span class="line">可以看到主控节点上是直接执行了 ssh 命令，简写为 ssh 192.168.xxx.31 /bin/bash xxxx</span><br><span class="line">我们还可以看到 是执行了远端服务器上的一个py脚本。</span><br><span class="line"></span><br><span class="line">被控节点上执行</span><br><span class="line">└─bash -c /usr/bin/python3 /tmp/ansibletmpr/ansible-tmp-1638962875.8801572-833070-192363216003291/AnsiballZ_command.py &amp;&amp; sleep 0</span><br><span class="line">    └─python3  /tmp/ansibletmpr/ansible-tmp-1638962875.8801572-833070-192363216003291/AnsiballZ_command.py</span><br><span class="line">    └─sleep  100</span><br><span class="line">我们可以看到远端服务器上是执行了一个py脚本，py脚本里面调用了我们的命令 sleep 100 这个。</span><br></pre></td></tr></table></figure>

<h2 id="2-如何使用sudo、root-等特权命令？？"><a href="#2-如何使用sudo、root-等特权命令？？" class="headerlink" title="2. 如何使用sudo、root 等特权命令？？"></a>2. 如何使用sudo、root 等特权命令？？</h2><p>使用 –become-method sudo -b 提升权限去执行命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible -i tools/ansible/inventory.conf -m command -a &#x27;sleep 60&#x27; --forks 1  192.168.12.31 -v --become-method sudo -b</span><br></pre></td></tr></table></figure>
<p>下面是主控服务器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">─ansible,457479 /home/conda/envs/ansible/bin/ansible -i tools/ansible/inventory.conf -m command -a sleep 60 --forks 1 192.168.12.31 -v --become-method sudo -b</span><br><span class="line">   ├─ansible,457587 /home/conda/envs/ansible/bin/ansible -i tools/ansible/inventory.conf -m command -a sleep 60 --forks 1 192.168.12.31 -v --become-method sudo -b</span><br><span class="line">   │   └─ssh,457596 -C -o ControlMaster=auto -o ControlPersist=60s -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o User=&quot;buildfarm&quot; -o ConnectTimeout=10 -o ControlPath=/tmp/buildfarm/ansibletmpcp/ansible-ssh-%h-%p-%r -tt 192.168.12.31 /bin/bash -c &#x27;sudo -H -S -n  -u root /bin/bash -c &#x27;&quot;&#x27;&quot;&#x27;echo BECOME-SUCCESS-irtokqitnflolaawnheahtwcoduedpsx ; /usr/bin/python3 /tmp/buildfarm/ansibletmpr/ansible-tmp-1648609937.0120566-457587-22932890217715/AnsiballZ_command.py&#x27;&quot;&#x27;&quot;&#x27; &amp;&amp; sleep 0&#x27;</span><br><span class="line">   └─&#123;ansible&#125;,457586</span><br></pre></td></tr></table></figure>
<p>下面是被执行服务器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">│   ├─sshd,2313068</span><br><span class="line">│   │   └─sshd,2313079</span><br><span class="line">│   │       └─bash,2313233 -c sudo -H -S -n  -u root /bin/bash -c &#x27;echo BECOME-SUCCESS-irtokqitnflolaawnheahtwcoduedpsx ; /usr/bin/python3 /tmp/buildfarm/ansibletmpr/ansible-tmp-1648609937.0120566-457587-22932890217715/AnsiballZ_command.py&#x27; &amp;&amp; sleep 0</span><br><span class="line">│   │           └─sudo,2313234 -H -S -n -u root /bin/bash -c echo BECOME-SUCCESS-irtokqitnflolaawnheahtwcoduedpsx ; /usr/bin/python3 /tmp/buildfarm/ansibletmpr/ansible-tmp-1648609937.0120566-457587-22932890217715/AnsiballZ_command.py</span><br><span class="line">│   │               └─bash,2313235 -c echo BECOME-SUCCESS-irtokqitnflolaawnheahtwcoduedpsx ; /usr/bin/python3 /tmp/buildfarm/ansibletmpr/ansible-tmp-1648609937.0120566-457587-22932890217715/AnsiballZ_command.py</span><br><span class="line">│   │                   └─python3,2313236 /tmp/buildfarm/ansibletmpr/ansible-tmp-1648609937.0120566-457587-22932890217715/AnsiballZ_command.py</span><br><span class="line">│   │                       └─sleep,2313238 60</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用 –become-user ‘’ 指定个空的用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(ansible) buildfarm@jenkins-master:~$ ansible -i tools/ansible/inventory.conf -m command -a &#x27;sleep 60&#x27; --forks 1  192.168.12.31 -v --become-method sudo -b --become-user &#x27;&#x27;</span><br></pre></td></tr></table></figure>
<p>可以发现远程被控服务器就会执行sudo -H -S -n &#x2F;bin&#x2F;bash -c ‘’ 这样的命令了，少了一个 -u root 这个参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">│   └─sshd,2313389</span><br><span class="line">│       └─sshd,2313400</span><br><span class="line">│           └─bash,2313442 -c sudo -H -S -n   /bin/bash -c &#x27;echo BECOME-SUCCESS-rqpombkywyxtrdmhmlrjbsfstljrwscc ; /usr/bin/python3 /tmp/buildfarm/ansibletmpr/ansible-tmp-1648613811.7588933-542772-245836208212105/AnsiballZ_command.py&#x27; &amp;&amp; sleep 0</span><br><span class="line">│               └─sudo,2313443 -H -S -n /bin/bash -c echo BECOME-SUCCESS-rqpombkywyxtrdmhmlrjbsfstljrwscc ; /usr/bin/python3 /tmp/buildfarm/ansibletmpr/ansible-tmp-1648613811.7588933-542772-245836208212105/AnsiballZ_command.py</span><br><span class="line">│                   └─bash,2313445 -c echo BECOME-SUCCESS-rqpombkywyxtrdmhmlrjbsfstljrwscc ; /usr/bin/python3 /tmp/buildfarm/ansibletmpr/ansible-tmp-1648613811.7588933-542772-245836208212105/AnsiballZ_command.py</span><br><span class="line">│                       └─python3,2313446 /tmp/buildfarm/ansibletmpr/ansible-tmp-1648613811.7588933-542772-245836208212105/AnsiballZ_command.py</span><br><span class="line">│                           └─sleep,2313448 60</span><br></pre></td></tr></table></figure>



<h2 id="copy模块执行分析"><a href="#copy模块执行分析" class="headerlink" title="copy模块执行分析"></a>copy模块执行分析</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">目标机器上执行 AnsiballZ_copy.py</span><br><span class="line"></span><br><span class="line">─ansible,1415889 /home/conda/envs/ansible/bin/ansible 10.0.12.31 -m copy -a src=/work/backup/ dest=/tmp/a/b/c/telegraf/</span><br><span class="line">  │   │ ├─ansible,1415895 /home/conda/envs/ansible/bin/ansible 10.0.12.31 -m copy -a src=/work/backup/ dest=/tmp/a/b/c/telegraf/</span><br><span class="line">  │   │ │   └─sftp,1417138 -b - -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o User=&quot;buildfarm&quot; -o ConnectTimeout=10 [10.0.12.31]</span><br><span class="line">  │   │ │       └─ssh,1417139 -oForwardX11 no -oForwardAgent no -oPermitLocalCommand no -oClearAllForwardings yes -obatchmode yes -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o User=&quot;buildfarm&quot; -o ConnectTimeout=10 -oProtocol 2 -s -- 10.0.12.31 sftp</span><br><span class="line">主控服务器会通过ftp 把 src 指定的 源目录下面的文件一个一个上传到 /tmp/buildfarm/ansibletmpr/xxxxx/source 这个文件。tmp路径是 我们在 ansible.cfg 文件中配置的remote_tmp      = /tmp/$USER/ansibletmpr</span><br><span class="line"></span><br><span class="line">通过ftp上传到目标服务器之后，在目标服务器上会执行 下面这个 AnsiballZ_copy.py 脚本的</span><br><span class="line">└─bash,1838989 -c /usr/bin/python3 /tmp/buildfarm/ansibletmpr/ansible-tmp-1648990563.6564553-1431017-227311237310306/AnsiballZ_copy.py &amp;&amp; sleep 0</span><br><span class="line">    └─python3,1838990 /tmp/buildfarm/ansibletmpr/ansible-tmp-1648990563.6564553-1431017-227311237310306/AnsiballZ_copy.py</span><br><span class="line"></span><br><span class="line">├── [  60]  /tmp/buildfarm</span><br><span class="line">│   └── [  60]  /tmp/buildfarm/ansibletmpr</span><br><span class="line">│       └── [ 100]  /tmp/buildfarm/ansibletmpr/ansible-tmp-1648990563.6564553-1431017-227311237310306</span><br><span class="line">│           ├── [133K]  /tmp/buildfarm/ansibletmpr/ansible-tmp-1648990563.6564553-1431017-227311237310306/AnsiballZ_copy.py</span><br><span class="line">│           ├── [128K]  /tmp/buildfarm/ansibletmpr/ansible-tmp-1648990563.6564553-1431017-227311237310306/AnsiballZ_stat.py</span><br><span class="line">│           └── [402M]  /tmp/buildfarm/ansibletmpr/ansible-tmp-1648990563.6564553-1431017-227311237310306/source</span><br><span class="line">在目标机器上 会把 文件 /tmp/buildfarm/ansibletmpr/ansible-tmp-1648990563.6564553-1431017-227311237310306/source 再次复制到 dest指定的目录下面</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>






</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://magesfc.github.io">mage</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://magesfc.github.io/mage/c17549d1cd4516fc242a8551d78cc1754d69a33e/">https://magesfc.github.io/mage/c17549d1cd4516fc242a8551d78cc1754d69a33e/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://magesfc.github.io" target="_blank">马哥私房菜</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ansible/">ansible</a></div><div class="post_share"><div class="social-share" data-image="https://t.mwm.moe/fj/" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/null" target="_blank"><img class="post-qr-code-img" src= "/img/loading.gif" data-lazy-src="/null" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/null" target="_blank"><img class="post-qr-code-img" src= "/img/loading.gif" data-lazy-src="/null" alt="支付寶"/></a><div class="post-qr-code-desc">支付寶</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/mage/041aeaf616293d64689343ad605f14cf73b589b0/"><img class="prev-cover" src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Django学习之初识</div></div></a></div><div class="next-post pull-right"><a href="/mage/3988ad506287c3c5ea81a4669e671c026ed1520e/"><img class="next-cover" src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Ansible自动化运维工具之总体介绍总结</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/mage/9797fe175c0183a6563e7397692d780ecf683a6f/" title="Ansible自动化运维工具之ansible-resources"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-16</div><div class="title">Ansible自动化运维工具之ansible-resources</div></div></a></div><div><a href="/mage/531887d5e7eb014078dd6f2951d13500e0551ca5/" title="Ansible自动化运维工具之playbook介绍"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-04</div><div class="title">Ansible自动化运维工具之playbook介绍</div></div></a></div><div><a href="/mage/c480dbde40d58e354795a1a408fdb8bad06fe7cc/" title="Ansible自动化运维工具之role介绍"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-01</div><div class="title">Ansible自动化运维工具之role介绍</div></div></a></div><div><a href="/mage/a0bfcc2b49b5167196ecf1ed7f20f9eb180d9a43/" title="Ansible自动化运维工具之synchronize模块学习"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-13</div><div class="title">Ansible自动化运维工具之synchronize模块学习</div></div></a></div><div><a href="/mage/3988ad506287c3c5ea81a4669e671c026ed1520e/" title="Ansible自动化运维工具之总体介绍总结"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-04</div><div class="title">Ansible自动化运维工具之总体介绍总结</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "/img/loading.gif" data-lazy-src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">mage</div><div class="author-info__description"> 这里是 马哥 的个人博客 </div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">212</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">230</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">40</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mamh2021"><i class="fab fa-github"></i><span>GitHub</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/mamh2021" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ansible-%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97"><span class="toc-number">1.</span> <span class="toc-text">ansible 常用模块</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ansible-%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97-1"><span class="toc-number">2.</span> <span class="toc-text">ansible 常用模块</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-ping%E6%A8%A1%E5%9D%97"><span class="toc-number">2.1.</span> <span class="toc-text">1)ping模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-command%E6%A8%A1%E5%9D%97"><span class="toc-number">2.2.</span> <span class="toc-text">2)command模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-shell%E6%A8%A1%E5%9D%97"><span class="toc-number">2.3.</span> <span class="toc-text">3)shell模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-copy%E6%A8%A1%E5%9D%97"><span class="toc-number">2.4.</span> <span class="toc-text">4)copy模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-fetch%E6%A8%A1%E5%9D%97"><span class="toc-number">2.5.</span> <span class="toc-text">5)fetch模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-file%E6%A8%A1%E5%9D%97"><span class="toc-number">2.6.</span> <span class="toc-text">6)file模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-yum%E6%A8%A1%E5%9D%97"><span class="toc-number">2.7.</span> <span class="toc-text">7)yum模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-systemd%E6%A8%A1%E5%9D%97"><span class="toc-number">2.8.</span> <span class="toc-text">8)systemd模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-cron%E6%A8%A1%E5%9D%97"><span class="toc-number">2.9.</span> <span class="toc-text">9)cron模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-get-url%E6%A8%A1%E5%9D%97"><span class="toc-number">2.10.</span> <span class="toc-text">10)get_url模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-mount%E6%A8%A1%E5%9D%97"><span class="toc-number">2.11.</span> <span class="toc-text">11)mount模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-archive%E6%A8%A1%E5%9D%97"><span class="toc-number">2.12.</span> <span class="toc-text">12)archive模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-unarchive%E6%A8%A1%E5%9D%97"><span class="toc-number">2.13.</span> <span class="toc-text">13)unarchive模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-selinux%E6%A8%A1%E5%9D%97"><span class="toc-number">2.14.</span> <span class="toc-text">14)selinux模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-service-%E6%A8%A1%E5%9D%97"><span class="toc-number">2.15.</span> <span class="toc-text">15)service 模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#16%EF%BC%89user-%E6%A8%A1%E5%9D%97"><span class="toc-number">2.16.</span> <span class="toc-text">16）user 模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#17%EF%BC%89group-%E6%A8%A1%E5%9D%97"><span class="toc-number">2.17.</span> <span class="toc-text">17）group 模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#18%EF%BC%89script-%E6%A8%A1%E5%9D%97"><span class="toc-number">2.18.</span> <span class="toc-text">18）script 模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#19%EF%BC%89setup-%E6%A8%A1%E5%9D%97"><span class="toc-number">2.19.</span> <span class="toc-text">19）setup 模块</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ansible%E6%89%A7%E8%A1%8C%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">ansible执行原理分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%BD%93%E6%88%91%E4%BB%AC%E6%89%A7%E8%A1%8Cansible%E5%91%BD%E4%BB%A4-%E4%B9%8B%E5%90%8E%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">3.1.</span> <span class="toc-text">1. 当我们执行ansible命令 之后发生了什么？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8sudo%E3%80%81root-%E7%AD%89%E7%89%B9%E6%9D%83%E5%91%BD%E4%BB%A4%EF%BC%9F%EF%BC%9F"><span class="toc-number">3.2.</span> <span class="toc-text">2. 如何使用sudo、root 等特权命令？？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#copy%E6%A8%A1%E5%9D%97%E6%89%A7%E8%A1%8C%E5%88%86%E6%9E%90"><span class="toc-number">3.3.</span> <span class="toc-text">copy模块执行分析</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/mage/53776646b88e8b3c368d34d9936b880421441770/" title="Linux学习之bash学习之在bash中Quoting的解释"><img src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux学习之bash学习之在bash中Quoting的解释"/></a><div class="content"><a class="title" href="/mage/53776646b88e8b3c368d34d9936b880421441770/" title="Linux学习之bash学习之在bash中Quoting的解释">Linux学习之bash学习之在bash中Quoting的解释</a><time datetime="2024-03-23T10:41:42.000Z" title="更新于 2024-03-23 18:41:42">2024-03-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/mage/0158e8186f0827d0b00df276735e46e876749b88/" title="Linux学习之bash学习之在bash中=和=~的区别"><img src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux学习之bash学习之在bash中=和=~的区别"/></a><div class="content"><a class="title" href="/mage/0158e8186f0827d0b00df276735e46e876749b88/" title="Linux学习之bash学习之在bash中=和=~的区别">Linux学习之bash学习之在bash中=和=~的区别</a><time datetime="2024-03-23T10:00:34.000Z" title="更新于 2024-03-23 18:00:34">2024-03-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/mage/29b1dee9b6336ea01be4716d95ecfbad663018d6/" title="Linux学习之bash学习之几个特殊变量"><img src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux学习之bash学习之几个特殊变量"/></a><div class="content"><a class="title" href="/mage/29b1dee9b6336ea01be4716d95ecfbad663018d6/" title="Linux学习之bash学习之几个特殊变量">Linux学习之bash学习之几个特殊变量</a><time datetime="2024-03-23T09:51:41.000Z" title="更新于 2024-03-23 17:51:41">2024-03-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/mage/8578f837ae5bc22b09842c0f84ac8860bb13a393/" title="Linux学习之常用的github仓库"><img src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux学习之常用的github仓库"/></a><div class="content"><a class="title" href="/mage/8578f837ae5bc22b09842c0f84ac8860bb13a393/" title="Linux学习之常用的github仓库">Linux学习之常用的github仓库</a><time datetime="2024-03-23T09:41:50.000Z" title="更新于 2024-03-23 17:41:50">2024-03-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/mage/d09beb62ca31e9a0cf278d3ff1a8795bc551ec06/" title="Linux学习之文件系统zfs性能优化"><img src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux学习之文件系统zfs性能优化"/></a><div class="content"><a class="title" href="/mage/d09beb62ca31e9a0cf278d3ff1a8795bc551ec06/" title="Linux学习之文件系统zfs性能优化">Linux学习之文件系统zfs性能优化</a><time datetime="2024-03-23T09:40:51.000Z" title="更新于 2024-03-23 17:40:51">2024-03-23</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://t.mwm.moe/fj/')"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2024 By mage</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="true" data-click="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>