<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Ansible自动化运维工具之synchronize模块学习 | 马哥私房菜</title><meta name="author" content="mage"><meta name="copyright" content="mage"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Ansible自动化运维工具之synchronize模块学习 synchronize is a wrapper around rsync to make common tasks in your playbooks quick and easy. It is run and originates on the local host where Ansible is being run. Of co">
<meta property="og:type" content="article">
<meta property="og:title" content="Ansible自动化运维工具之synchronize模块学习">
<meta property="og:url" content="https://magesfc.github.io/mage/a0bfcc2b49b5167196ecf1ed7f20f9eb180d9a43/">
<meta property="og:site_name" content="马哥私房菜">
<meta property="og:description" content="Ansible自动化运维工具之synchronize模块学习 synchronize is a wrapper around rsync to make common tasks in your playbooks quick and easy. It is run and originates on the local host where Ansible is being run. Of co">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg">
<meta property="article:published_time" content="2022-10-13T03:27:35.000Z">
<meta property="article:modified_time" content="2022-10-31T08:37:59.000Z">
<meta property="article:author" content="mage">
<meta property="article:tag" content="ansible">
<meta property="article:tag" content="synchronize">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg"><link rel="shortcut icon" href="http://www.blackshark.com/favicon.ico"><link rel="canonical" href="https://magesfc.github.io/mage/a0bfcc2b49b5167196ecf1ed7f20f9eb180d9a43/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: mage","link":"链接: ","source":"来源: 马哥私房菜","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Ansible自动化运维工具之synchronize模块学习',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-10-31 16:37:59'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><style type="text/css">.card-announcement .social-button{margin:.6rem 0 0 0;text-align:center}.card-announcement .social-button a{display:block;background-color:var(--btn-bg);color:var(--btn-color);text-align:center;line-height:2.4;margin:4px 0}.card-announcement .social-button a:hover{background-color:var(--btn-hover-color)}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "/img/loading.gif" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">167</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">185</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">34</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-compass"></i><span> 目录</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 精选文档</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/21cfbf15/"><span> 🚀 快速开始</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/dc584b87/"><span> 📑 主题页面</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/4aa8abbe/"><span> 🛠 主题配置-1</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/ceeb73f/"><span> 🛠 主题配置-2</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/98d20436/"><span> ❓ 主题问答</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/4073eda/"><span> ⚡️ 进阶教程</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/198a4240/"><span> ✨ 更新日志</span></a></li></ul></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://butterfly.js.org/link/"><i class="fa-fw fas fa-thumbs-up"></i><span> 其他示例</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">马哥私房菜</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-compass"></i><span> 目录</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 精选文档</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/21cfbf15/"><span> 🚀 快速开始</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/dc584b87/"><span> 📑 主题页面</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/4aa8abbe/"><span> 🛠 主题配置-1</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/ceeb73f/"><span> 🛠 主题配置-2</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/98d20436/"><span> ❓ 主题问答</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/4073eda/"><span> ⚡️ 进阶教程</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/198a4240/"><span> ✨ 更新日志</span></a></li></ul></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://butterfly.js.org/link/"><i class="fa-fw fas fa-thumbs-up"></i><span> 其他示例</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Ansible自动化运维工具之synchronize模块学习</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-10-13T03:27:35.000Z" title="发表于 2022-10-13 11:27:35">2022-10-13</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-10-31T08:37:59.000Z" title="更新于 2022-10-31 16:37:59">2022-10-31</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/ansible/">ansible</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Ansible自动化运维工具之synchronize模块学习"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>Ansible自动化运维工具之synchronize模块学习</p>
<p>synchronize is a wrapper around rsync to make common tasks in your playbooks quick and easy.</p>
<p>It is run and originates on the local host where Ansible is being run.</p>
<p>Of course, you could just use the command action to call rsync yourself, but you also have to add a fair number of boilerplate options and host facts.</p>
<p>This module is not intended to provide access to the full power of rsync, but does make the most common invocations easier to implement. You still may need to call rsync directly via command or shell depending on your use case.</p>
<p>该模块是 ansible.posix 集合（版本 1.4.0）的一部分。</p>
<p>如果您使用的是 ansible 软件包，您可能已经安装了这个集合。 它不包含在 ansible-core 中。 要检查它是否已安装，请运行 ansible-galaxy collection list。</p>
<p>要安装它，请使用：ansible-galaxy collection install ansible.posix。</p>
<p>要在 playbook 中使用它，请指定：ansible.posix.synchronize。</p>
<h1 id="问题1："><a href="#问题1：" class="headerlink" title="问题1："></a>问题1：</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">---                        #固定格式</span><br><span class="line">- hosts: centos            # 将要执行任务的主机，已经在hosts文件中定义好了，可是单个主机或主机组</span><br><span class="line">  become: False            # 在目标主机上执行任务时的用户身份</span><br><span class="line">  gather_facts: False</span><br><span class="line">  vars:</span><br><span class="line">    - ansible_shell_executable: /bin/sh</span><br><span class="line">    - ansible_shell_type: sh</span><br><span class="line">  tasks:</span><br><span class="line">    - name: &quot;start categraf agent&quot;</span><br><span class="line">      shell: ls -alh</span><br><span class="line">    - name: &quot;test ping&quot;</span><br><span class="line">      ping:</span><br><span class="line">    - name: &quot;Synchronize and delete files for categraf&quot;</span><br><span class="line">      ansible.posix.synchronize:</span><br><span class="line">        src: /work/jenkins/workspace/categraf/</span><br><span class="line">        dest: categraf/</span><br><span class="line">        delete: yes</span><br><span class="line">        recursive: yes</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在执行 这个模块的时候 总是报错：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;Could not find the shell plugin required (bash).&quot;</span><br></pre></td></tr></table></figure>

<p>经过源码分析，发现 是在  ansible&#x2F;plugins&#x2F;loader.py 文件中的 get_shell_plugin 抛出的异常<br>shell_type&#x3D; sh executable &#x2F;bin&#x2F;bash  # 这个不会报错<br>shell_type&#x3D; bash executable &#x2F;bin&#x2F;bash # 这个会报错的，因为会根据这个 shell type 值去找 ansible&#x2F;plugins&#x2F;shell 下面的哪个 文件的。如果 这个目录下面 复制个 文件 叫 bash.py 的也就不会报错了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">def get_shell_plugin(shell_type=None, executable=None):</span><br><span class="line"></span><br><span class="line">    if not shell_type:</span><br><span class="line">        # default to sh</span><br><span class="line">        shell_type = &#x27;sh&#x27;</span><br><span class="line"></span><br><span class="line">        # mostly for backwards compat</span><br><span class="line">        if executable:</span><br><span class="line">            if isinstance(executable, string_types):</span><br><span class="line">                shell_filename = os.path.basename(executable)</span><br><span class="line">                try:</span><br><span class="line">                    shell = shell_loader.get(shell_filename)</span><br><span class="line">                except Exception:</span><br><span class="line">                    shell = None</span><br><span class="line"></span><br><span class="line">                if shell is None:</span><br><span class="line">                    for shell in shell_loader.all():</span><br><span class="line">                        if shell_filename in shell.COMPATIBLE_SHELLS:</span><br><span class="line">                            shell_type = shell.SHELL_FAMILY</span><br><span class="line">                            break</span><br><span class="line">        else:</span><br><span class="line">            raise AnsibleError(&quot;Either a shell type or a shell executable must be provided &quot;)</span><br><span class="line"></span><br><span class="line">    shell = shell_loader.get(shell_type)</span><br><span class="line">    if not shell:</span><br><span class="line">        raise AnsibleError(&quot;Could not find the shell plugin required (%s).&quot; % shell_type)</span><br><span class="line"></span><br><span class="line">    if executable:</span><br><span class="line">        setattr(shell, &#x27;executable&#x27;, executable)</span><br><span class="line"></span><br><span class="line">    return shell</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="问题分析-1"><a href="#问题分析-1" class="headerlink" title="问题分析 1"></a>问题分析 1</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">在执行 task的时候，3个 task 发现 fact和 ping task 都是 sh，但是 Synchronize 为什么执行了2 次，第一次是 sh，第二次 就是 bash拉？？？？正式因为这第二次 导致报错</span><br><span class="line">TASK [Gathering Facts] *********************************************************</span><br><span class="line">sh /bin/sh</span><br><span class="line">ok: [192.168.1.105]</span><br><span class="line"></span><br><span class="line">TASK [Induce an exception to see what happens] *********************************</span><br><span class="line">sh /bin/sh</span><br><span class="line">ok: [192.168.1.105]</span><br><span class="line"></span><br><span class="line">TASK [Synchronize and delete files for categraf] *******************************</span><br><span class="line">sh /bin/sh</span><br><span class="line">bash /bin/bash</span><br></pre></td></tr></table></figure>

<h2 id="问题分析-2"><a href="#问题分析-2" class="headerlink" title="问题分析 2"></a>问题分析 2</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">在  ansible/plugins/loader.py 方法的 846 行加上 打印 print(self.class_name, str(obj))</span><br><span class="line">第一次是</span><br><span class="line">class_name ansible.plugins.connectin.ssh.Connection</span><br><span class="line">第二次是</span><br><span class="line">class_name ansible.plugins.connectin.local.Connection</span><br><span class="line"></span><br><span class="line">每个task都是先调用了 一个 Connection， 然后调用对应的 xxxModule</span><br><span class="line"></span><br><span class="line">shell 模块的 调用</span><br><span class="line">TASK [start categraf agent] ****************************************************</span><br><span class="line">Connection &lt;class &#x27;ansible.plugins.connection.ssh.Connection&#x27;&gt;</span><br><span class="line">ShellModule &lt;class &#x27;ansible.plugins.shell.sh.ShellModule&#x27;&gt;</span><br><span class="line">shell_type= sh executable /bin/bash</span><br><span class="line"></span><br><span class="line">ActionModule &lt;class &#x27;ansible.plugins.action.shell.ActionModule&#x27;&gt;</span><br><span class="line">ActionModule &lt;class &#x27;ansible.plugins.action.command.ActionModule&#x27;&gt;</span><br><span class="line">changed: [192.168.1.105]</span><br><span class="line"></span><br><span class="line">ping模块的 调用</span><br><span class="line">TASK [test ping] ***************************************************************</span><br><span class="line">Connection &lt;class &#x27;ansible.plugins.connection.ssh.Connection&#x27;&gt;</span><br><span class="line">ShellModule &lt;class &#x27;ansible.plugins.shell.sh.ShellModule&#x27;&gt;</span><br><span class="line">shell_type= sh executable /bin/bash</span><br><span class="line"></span><br><span class="line">ActionModule &lt;class &#x27;ansible.plugins.action.normal.ActionModule&#x27;&gt;</span><br><span class="line">ok: [192.168.1.105]</span><br><span class="line"></span><br><span class="line">1 Connection &lt;class &#x27;ansible.plugins.connection.ssh.Connection&#x27;&gt;</span><br><span class="line">1 ShellModule &lt;class &#x27;ansible.plugins.shell.sh.ShellModule&#x27;&gt;</span><br><span class="line">2 ShellModule &lt;ansible.plugins.shell.sh.ShellModule object at 0x7f39bdb239a0&gt;  这里正好反过来了，类似 入栈，出栈的效果 Connection -&gt; ShellModule -&gt; ShellModule -&gt; Connection</span><br><span class="line">2 Connection &lt;ansible.plugins.connection.ssh.Connection object at 0x7f39bdb23a30&gt;</span><br><span class="line"></span><br><span class="line">1 ActionModule &lt;class &#x27;ansible.plugins.action.normal.ActionModule&#x27;&gt;</span><br><span class="line">2 ActionModule &lt;ansible.plugins.action.normal.ActionModule object at 0x7f39bdb233a0&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>但是 synchronize 这个就比较特殊了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">这个会调用2次 Connection， 一次ssh的，另外一次 变成 local 了</span><br><span class="line">TASK [Synchronize and delete files for categraf] *******************************</span><br><span class="line">Connection &lt;class &#x27;ansible.plugins.connection.ssh.Connection&#x27;&gt;  # 最初这里 我们得到 self._play_context.shell 和 self._play_context.executable 分别是  None /bin/sh</span><br><span class="line">ShellModule &lt;class &#x27;ansible.plugins.shell.sh.ShellModule&#x27;&gt;</span><br><span class="line">shell_type= sh executable /bin/bash</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ActionModule &lt;class &#x27;ansible_collections.ansible.posix.plugins.action.synchronize.ActionModule&#x27;&gt;  # 经过这里的时候也是 self._play_context.shell 和 self._play_context.executable 分别是  None /bin/sh，但是接着往下的时候 在 synchronize.ActionModule 的run方法里面 把它改了！！！！！！！！！！1</span><br><span class="line"></span><br><span class="line">Connection &lt;class &#x27;ansible.plugins.connection.local.Connection&#x27;&gt;   这个调用是 因为在 synchronize.ActionModule 中的run() 方法里面 new_connection = connection_loader.get(&#x27;local&#x27;, self._play_context, new_stdin) 主动去调用了一个 获取了一个 新的 Connection</span><br><span class="line">shell_type= bash executable /bin/bash</span><br><span class="line"></span><br><span class="line">fatal: [192.168.1.105]: FAILED! =&gt; &#123;&quot;msg&quot;: &quot;Could not find the shell plugin required (bash).&quot;&#125;</span><br><span class="line"></span><br><span class="line">ShellModule &lt;class &#x27;ansible.plugins.shell.sh.ShellModule&#x27;&gt; # 如果不失败，后续会执行这个</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">通过追踪 我们 发现  self._play_context 中有问题：</span><br><span class="line"></span><br><span class="line">这个 self._play_context 是 从  ssh.Connection 传过来的 &lt;ansible.playbook.play_context.PlayContext object at 0x7fdd6f7b40a0&gt;，</span><br><span class="line">然后传给到了 synchronize.ActionModule 的init方法里面。</span><br><span class="line">在 .synchronize.ActionModule 的run方法里面 它自己有修改了 几个 self._play_context,中的变量的值 self._play_context.shell 和 self._play_context.executable</span><br><span class="line">然后在 调用 connection_loader.get(&#x27;local&#x27;, self._play_context, new_stdin)  时候 就传入了 self._play_context</span><br><span class="line"></span><br><span class="line">通过打印 __init__方法中的  self._play_context.shell 和 self._play_context.executable 值分别是： None  和 /bin/sh</span><br><span class="line">通过打印 run 方法最开始的时候 self._play_context.shell 和 self._play_context.executable 值分别是：   None /bin/sh</span><br><span class="line">通过打印 run 方法调用 connection_loader.get(&#x27;local&#x27;, self._play_context, new_stdin) 之前的 时候 值分别是：    bash /bin/bash</span><br><span class="line"></span><br><span class="line">可以发现 这里确实是 在  synchronize.ActionModule  的 run() 方法中把这2个 self._play_context.shell 和 self._play_context.executable 值重新修改了 </span><br></pre></td></tr></table></figure>

<p>下面是默认的代码。可以发现 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">if not use_delegate and remote_transport:</span><br><span class="line">    # Create a connection to localhost to run rsync on</span><br><span class="line">    new_stdin = self._connection._new_stdin</span><br><span class="line"></span><br><span class="line">    # Unlike port, there can be only one shell</span><br><span class="line">    localhost_shell = None</span><br><span class="line">    for host in C.LOCALHOST:   # 这里是从 &#x27;127.0.0.1&#x27;, &#x27;localhost&#x27;, &#x27;::1&#x27;这个3个主机配置参数中获取 C.MAGIC_VARIABLE_MAPPING[&#x27;shell&#x27;]=ansible_shell_type 的，这3个主机中肯定是没单独配置</span><br><span class="line">        localhost_vars = task_vars[&#x27;hostvars&#x27;].get(host, &#123;&#125;)</span><br><span class="line">        for shell_var in C.MAGIC_VARIABLE_MAPPING[&#x27;shell&#x27;]:</span><br><span class="line">            localhost_shell = localhost_vars.get(shell_var, None)</span><br><span class="line">            if localhost_shell:</span><br><span class="line">                break</span><br><span class="line">        if localhost_shell:</span><br><span class="line">            break</span><br><span class="line">    else:</span><br><span class="line">        localhost_shell = os.path.basename(C.DEFAULT_EXECUTABLE)  # 上面的 没有 获取到 就从 ansible.cfg 文件中的这个executable=/bin/bash</span><br><span class="line">    self._play_context.shell = localhost_shell  # 最终就是这里 没事多去 赋值了这个值导致了 报错</span><br><span class="line"></span><br><span class="line">    # Unlike port, there can be only one executable</span><br><span class="line">    localhost_executable = None</span><br><span class="line">    for host in C.LOCALHOST:</span><br><span class="line">        localhost_vars = task_vars[&#x27;hostvars&#x27;].get(host, &#123;&#125;)</span><br><span class="line">        for executable_var in C.MAGIC_VARIABLE_MAPPING[&#x27;executable&#x27;]:</span><br><span class="line">            localhost_executable = localhost_vars.get(executable_var, None)</span><br><span class="line">            if localhost_executable:</span><br><span class="line">                break</span><br><span class="line">        if localhost_executable:</span><br><span class="line">            break</span><br><span class="line">    else:</span><br><span class="line">        localhost_executable = C.DEFAULT_EXECUTABLE</span><br><span class="line">    self._play_context.executable = localhost_executable</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>经过我们的修复，我们不然它从 DEFAULT_EXECUTABLE 获取这个值，优先从 剧本的yaml文件中获取，如果没有再用默认的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">if not use_delegate and remote_transport:</span><br><span class="line">    # Create a connection to localhost to run rsync on</span><br><span class="line">    new_stdin = self._connection._new_stdin</span><br><span class="line"></span><br><span class="line">    # Unlike port, there can be only one shell</span><br><span class="line">    localhost_shell = None</span><br><span class="line">    for host in C.LOCALHOST:</span><br><span class="line">        localhost_vars = task_vars[&#x27;hostvars&#x27;].get(host, &#123;&#125;)</span><br><span class="line">        for shell_var in C.MAGIC_VARIABLE_MAPPING[&#x27;shell&#x27;]:  # 这里是从 &#x27;127.0.0.1&#x27;, &#x27;localhost&#x27;, &#x27;::1&#x27;这个3个主机配置参数中获取 C.MAGIC_VARIABLE_MAPPING[&#x27;shell&#x27;]=ansible_shell_type 的，这3个主机中肯定是没单独配置这个变量的</span><br><span class="line">            localhost_shell = localhost_vars.get(shell_var, None)</span><br><span class="line">            if localhost_shell:</span><br><span class="line">                break</span><br><span class="line">        if localhost_shell:</span><br><span class="line">            break</span><br><span class="line">    else:</span><br><span class="line">        for shell_var in C.MAGIC_VARIABLE_MAPPING[&#x27;shell&#x27;]: # ansible_shell_type</span><br><span class="line">            localhost_shell = task_vars.get(shell_var, None)</span><br><span class="line">            if localhost_shell:</span><br><span class="line">                break</span><br><span class="line">        if not localhost_shell: #从 task vars 里面获取，这里是 剧本中 特意指定了，如果没有再去使用 默认的 ansible.cfg 文件中的这个executable</span><br><span class="line">            localhost_shell = os.path.basename(C.DEFAULT_EXECUTABLE) #  ansible.cfg 文件中的这个executable=/bin/bash</span><br><span class="line">    self._play_context.shell = localhost_shell</span><br><span class="line"></span><br><span class="line">    # Unlike port, there can be only one executable</span><br><span class="line">    localhost_executable = None</span><br><span class="line">    for host in C.LOCALHOST:</span><br><span class="line">        localhost_vars = task_vars[&#x27;hostvars&#x27;].get(host, &#123;&#125;)</span><br><span class="line">        for executable_var in C.MAGIC_VARIABLE_MAPPING[&#x27;executable&#x27;]: #  # 这里是从 &#x27;127.0.0.1&#x27;, &#x27;localhost&#x27;, &#x27;::1&#x27;这个3个主机配置参数中获取 C.MAGIC_VARIABLE_MAPPING[&#x27;executable&#x27;]=ansible_shell_executable 的，这3个主机中肯定是没单独配置这个变量的</span><br><span class="line">            localhost_executable = localhost_vars.get(executable_var, None)</span><br><span class="line">            if localhost_executable:</span><br><span class="line">                break</span><br><span class="line">        if localhost_executable:</span><br><span class="line">            break</span><br><span class="line">    else:</span><br><span class="line">        for executable_var in C.MAGIC_VARIABLE_MAPPING[&#x27;executable&#x27;]: # ansible_shell_executable</span><br><span class="line">            localhost_executable = task_vars.get(executable_var, None)</span><br><span class="line">            if localhost_executable:</span><br><span class="line">                break</span><br><span class="line">        if not localhost_executable:</span><br><span class="line">            localhost_executable = C.DEFAULT_EXECUTABLE  #  ansible.cfg 文件中的这个executable=/bin/bash</span><br><span class="line">    self._play_context.executable = localhost_executable</span><br><span class="line">    print(&quot;run2: &quot;, self._play_context.shell , self._play_context.executable)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p>pull 的例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># /usr/bin/rsync --delay-updates -F --compress --archive --rsh=&#x27;/usr/bin/ssh -S none -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null&#x27; --out-format=&#x27;&lt;&lt;CHANGED&gt;&gt;%i %n%L&#x27; mage@192.168.1.105:/tmp/hsperfdata_mamh/ /tmp/hsperfdata/</span><br><span class="line">    - name: Synchronization of two paths both on the control machine</span><br><span class="line">      ansible.posix.synchronize:</span><br><span class="line">        src: /tmp/hsperfdata_mamh/</span><br><span class="line">        dest: /tmp/hsperfdata/</span><br><span class="line">        mode: pull</span><br><span class="line"></span><br><span class="line">本地执行 playbook 命令的机器上会有如下进程</span><br><span class="line">  │       ├─python,31664 -u /home/mamh/work/github/ansible-ansible/bin/ansible-playbook -i /home/mamh/work/aais/tools/ansible/inventory.conf /home/mamh/work/aais/tools/ansible/categraf.yaml</span><br><span class="line">  │       │   ├─python,31671 -u /home/mamh/work/github/ansible-ansible/bin/ansible-playbook -i /home/mamh/work/aais/tools/ansible/inventory.conf /home/mamh/work/aais/tools/ansible/categraf.yaml</span><br><span class="line">  │       │   │   └─bash,31681 -c /home/conda/envs/python3.8/bin/python /tmp/mamh/ansibletmpl/ansible-local-3166456lt3s78/ansible-tmp-1665713880.6339345-31671-178074395576684/AnsiballZ_synchronize.py &amp;&amp; sleep 0</span><br><span class="line">  │       │   │       └─python,31682 /tmp/mamh/ansibletmpl/ansible-local-3166456lt3s78/ansible-tmp-1665713880.6339345-31671-178074395576684/AnsiballZ_synchronize.py</span><br><span class="line">  │       │   │           └─rsync,31683 --delay-updates -F --compress --archive --rsh=/usr/bin/ssh -S none -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null --out-format=&lt;&lt;CHANGED&gt;&gt;%i %n%L mage@192.168.1.105:/tmp/hsperfdata_mamh/ /tmp/hsperfdata/</span><br><span class="line">  │       │   │               ├─rsync,31691 --delay-updates -F --compress --archive --rsh=/usr/bin/ssh -S none -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null --out-format=&lt;&lt;CHANGED&gt;&gt;%i %n%L mage@192.168.1.105:/tmp/hsperfdata_mamh/ /tmp/hsperfdata/</span><br><span class="line">  │       │   │               └─ssh,31684 -S none -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -l mage 192.168.1.105 rsync --server --sender -logDtprze.LsfxC . /tmp/hsperfdata_mamh/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">对应的远端服务器上有如下进程：</span><br><span class="line">  │   └─sshd,154588</span><br><span class="line">  │       └─sshd,154592</span><br><span class="line">  │           └─rsync,154593 --server --sender -logDtprze.LsfxC . /tmp/hsperfdata_mamh/</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>push 的例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"># /usr/bin/rsync --delay-updates -F --compress --archive --rsh=&#x27;/usr/bin/ssh -S none -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null&#x27; --out-format=&#x27;&lt;&lt;CHANGED&gt;&gt;%i %n%L&#x27; /tmp/hsperfdata_mamh/ mage@192.168.1.105:/tmp/hsperfdata/</span><br><span class="line">    - name: Synchronization of two paths both on the control machine</span><br><span class="line">      ansible.posix.synchronize:</span><br><span class="line">        src: /tmp/hsperfdata_mamh/</span><br><span class="line">        dest: /tmp/hsperfdata/</span><br><span class="line">        mode: push</span><br><span class="line">        </span><br><span class="line">默认没有配置 delegate_to的 都是在 当前 执行 playbook 命令的机器上执行的。</span><br><span class="line"></span><br><span class="line">过程大致如下：</span><br><span class="line">执行到 lib/ansible_collections/ansible/posix/plugins/action/synchronize.py 文件中 run() 方法，</span><br><span class="line">            new_stdin = self._connection._new_stdin</span><br><span class="line">            new_connection = connection_loader.get(&#x27;local&#x27;, self._play_context, new_stdin)</span><br><span class="line">            self._connection = new_connection</span><br><span class="line">通过上面的 代码 从新 弄个 local的 _connection， 这样就会在本机 执行了。            </span><br><span class="line">后面调用都这里        </span><br><span class="line">        result.update(self._execute_module(&#x27;ansible.posix.synchronize&#x27;, module_args=_tmp_args, task_vars=task_vars))</span><br><span class="line">进入到 _execute_module 方法中  lib/ansible/plugins/action/__init__.py 中的 _execute_module</span><br><span class="line">改方法会拼接出来一个 cmd 执行的命令，如下：</span><br><span class="line">&#x27;/home/conda/envs/python3.8/bin/python /tmp/mamh/ansibletmpl/ansible-local-3029657nhez0k/ansible-tmp-1665712649.202284-30307-156158933036685/AnsiballZ_synchronize.py&#x27;</span><br><span class="line">后面会调用：</span><br><span class="line">         res = self._low_level_execute_command(cmd, sudoable=sudoable, in_data=in_data)</span><br><span class="line">然后直接就 执行了 cmd 命令了。         </span><br><span class="line">本地机器上就会有个这样的 进程：</span><br><span class="line">  │       ├─python,31570 -u /home/mamh/work/github/ansible-ansible/bin/ansible-playbook -i /home/mamh/work/aais/tools/ansible/inventory.conf /home/mamh/work/aais/tools/ansible/categraf.yaml</span><br><span class="line">  │       │   ├─python,31577 -u /home/mamh/work/github/ansible-ansible/bin/ansible-playbook -i /home/mamh/work/aais/tools/ansible/inventory.conf /home/mamh/work/aais/tools/ansible/categraf.yaml</span><br><span class="line">  │       │   │   └─bash,31587 -c /home/conda/envs/python3.8/bin/python /tmp/mamh/ansibletmpl/ansible-local-31570uqrgmtd8/ansible-tmp-1665713765.2156665-31577-964977609392/AnsiballZ_synchronize.py &amp;&amp; sleep 0</span><br><span class="line">  │       │   │       └─python,31588 /tmp/mamh/ansibletmpl/ansible-local-31570uqrgmtd8/ansible-tmp-1665713765.2156665-31577-964977609392/AnsiballZ_synchronize.py</span><br><span class="line">  │       │   │           └─rsync,31589 --delay-updates -F --compress --archive --rsh=/usr/bin/ssh -S none -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null --out-format=&lt;&lt;CHANGED&gt;&gt;%i %n%L /tmp/hsperfdata_mamh/ mage@192.168.1.105:/tmp/hsperfdata/</span><br><span class="line">  │       │   │               └─ssh,31590 -S none -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -l mage 192.168.1.105 rsync --server -logDtprze.iLsfxC --log-format=%i --delay-updates . /tmp/hsperfdata/</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>delegate_to 例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"># /usr/bin/rsync --delay-updates -F --compress --archive --rsh=&#x27;/usr/bin/ssh -S none -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null&#x27; --out-format=&#x27;&lt;&lt;CHANGED&gt;&gt;%i %n%L&#x27; /tmp/hsperfdata_mamh/ mage@192.168.1.105:/tmp/hsperfdata/    </span><br><span class="line">    - name: Synchronization of two paths both on the control machine</span><br><span class="line">      ansible.posix.synchronize:</span><br><span class="line">        src: /tmp/hsperfdata_mamh/</span><br><span class="line">        dest: /tmp/hsperfdata/</span><br><span class="line">      delegate_to: localhost  # </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># /usr/bin/rsync --delay-updates -F --compress --archive --rsh=&#x27;/usr/bin/ssh -S none -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null&#x27; --out-format=&#x27;&lt;&lt;CHANGED&gt;&gt;%i %n%L&#x27; /tmp/hsperfdata_mamh/ mage@192.168.1.105:/tmp/hsperfdata/</span><br><span class="line">    - name: Synchronization of two paths both on the control machine</span><br><span class="line">      ansible.posix.synchronize:</span><br><span class="line">        src: /tmp/hsperfdata_mamh/</span><br><span class="line">        dest: /tmp/hsperfdata/</span><br><span class="line">      delegate_to: 192.168.1.106  # 这样执行的时候实际是在 12.106 这台服务器上执行的 rsync 命令， 这个task 执行 host 是 192.168.1.105，采用的push模式，也就是 这里把 12.106 上的文件 push到 12.105 上了。playbook执行的机器也不是这2台，是我本地的一台 61.75这个。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">在12.106 服务器上如下进程</span><br><span class="line">│   └─sshd,83521</span><br><span class="line">│       └─sshd,83525</span><br><span class="line">│           └─bash,83526 -c /usr/bin/python3 /tmp/mage/ansibletmpr/ansible-tmp-1665645007.8448188-6693-24565751160851/AnsiballZ_synchronize.py &amp;&amp; sleep 0</span><br><span class="line">│               └─python3,83527 /tmp/mage/ansibletmpr/ansible-tmp-1665645007.8448188-6693-24565751160851/AnsiballZ_synchronize.py</span><br><span class="line">│                   └─rsync,83529 --delay-updates -F --compress --archive --rsh=/usr/bin/ssh -S none -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null --out-format=&lt;&lt;CHANGED&gt;&gt;%i %n%L /tmp/hsperfdata_mamh/ mage@192.168.1.105:/tmp/hsperfdata/</span><br><span class="line">│                       └─ssh,83530 -S none -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -l mage 192.168.1.105 rsync --server -logDtprze.iLsfxCIvu --log-format=%i --delay-updates . /tmp/hsperfdata/</span><br><span class="line"></span><br><span class="line">在 12.105 服务器上如下进程，这个是 rsync 同步的目标机器</span><br><span class="line">  │   └─sshd,147613</span><br><span class="line">  │       └─sshd,147617</span><br><span class="line">  │           └─rsync,147618 --server -logDtprze.iLsfxCIvu --log-format=%i --delay-updates . /tmp/hsperfdata/</span><br><span class="line">  │               └─rsync,147619 --server -logDtprze.iLsfxCIvu --log-format=%i --delay-updates . /tmp/hsperfdata/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">执行 playbook 命令机器上 如下进程：</span><br><span class="line">│       ├─python,6667 -u /home/mamh/work/github/ansible-ansible/bin/ansible-playbook -i /home/mamh/work/aais/tools/ansible/inventory.conf /home/mamh/work/aais/tools/ansible/categraf.yaml -v</span><br><span class="line">│       │   ├─python,6693 -u /home/mamh/work/github/ansible-ansible/bin/ansible-playbook -i /home/mamh/work/aais/tools/ansible/inventory.conf /home/mamh/work/aais/tools/ansible/categraf.yaml -v</span><br><span class="line">│       │   │   └─ssh,6700 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o User=&quot;mage&quot; -o ConnectTimeout=10 -tt 192.168.1.106 /bin/bash -c &#x27;/usr/bin/python3 /tmp/mage/ansibletmpr/ansible-tmp-1665645007.8448188-6693-24565751160851/AnsiballZ_synchronize.py &amp;&amp; sleep 0&#x27;</span><br><span class="line">│       │   └─&#123;python&#125;,6673</span><br><span class="line"></span><br><span class="line">playbook 命令机器上 执行，然后会在 12.106 上复制一个 AnsiballZ_synchronize.py 文件</span><br><span class="line">通过这个文件 调用了 rsync 命令。</span><br><span class="line">在  ansible/plugins/action/__init__.py 中的 _execute_module 方法中有个 复制 这个  AnsiballZ_synchronize.py 文件 文件的方法调用，这个取自ping模块调试时候看到的，估计其他模块也是类似的。</span><br><span class="line">if module_style == &#x27;binary&#x27;:</span><br><span class="line">self._transfer_file(module_path, remote_module_path)</span><br><span class="line">else:</span><br><span class="line">self._transfer_data(remote_module_path, module_data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># /usr/bin/rsync --delay-updates -F --compress --archive --out-format=&#x27;&lt;&lt;CHANGED&gt;&gt;%i %n%L&#x27; /tmp/105_src/ /tmp/105_dst/</span><br><span class="line">    - name: Synchronization of two paths both on the control machine</span><br><span class="line">      ansible.posix.synchronize:</span><br><span class="line">        src: /tmp/105_src/</span><br><span class="line">        dest: /tmp/105_dst/</span><br><span class="line">      delegate_to: 192.168.1.105  这里把 delegate_to的ip改成192.168.1.15， 这样执行 rsync 命令的服务器是 12.105， 需要 push到的目标 服务器也是 12.105. 这就相当于，在12.105 服务器 本地 自己 执行 rsync，也就是从本地一个目录复制到本地另外一个目录。</span><br><span class="line">在 12.105 上 会有如下进程：</span><br><span class="line">  │   └─sshd,148680</span><br><span class="line">  │       └─sshd,148684</span><br><span class="line">  │           └─bash,148685 -c /usr/bin/python3 /tmp/mage/ansibletmpr/ansible-tmp-1665645894.8538651-7370-177548815339364/AnsiballZ_synchronize.py &amp;&amp; sleep 0</span><br><span class="line">  │               └─python3,148686 /tmp/mage/ansibletmpr/ansible-tmp-1665645894.8538651-7370-177548815339364/AnsiballZ_synchronize.py</span><br><span class="line">  │                   └─rsync,148688 --delay-updates -F --compress --archive --out-format=&lt;&lt;CHANGED&gt;&gt;%i %n%L /tmp/105_src/ /tmp/105_dst/</span><br><span class="line">  │                       └─rsync,148689 --delay-updates -F --compress --archive --out-format=&lt;&lt;CHANGED&gt;&gt;%i %n%L /tmp/105_src/ /tmp/105_dst/</span><br><span class="line">  │                           └─rsync,148690 --delay-updates -F --compress --archive --out-format=&lt;&lt;CHANGED&gt;&gt;%i %n%L /tmp/105_src/ /tmp/105_dst/</span><br><span class="line"></span><br><span class="line">```      </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 其他</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>&#x2F;home&#x2F;mamh&#x2F;work&#x2F;github&#x2F;ansible-ansible&#x2F;lib&#x2F;ansible&#x2F;executor&#x2F;task_queue_manager.py<br>321行<br>            play_return &#x3D; strategy.run(iterator, play_context)  # 入口执行 task的地方</p>
<p>&#x2F;home&#x2F;mamh&#x2F;work&#x2F;github&#x2F;ansible-ansible&#x2F;lib&#x2F;ansible&#x2F;plugins&#x2F;strategy&#x2F;linear.py</p>
<p>315行<br>                        self._queue_task(host, task, task_vars, play_context)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>├─ansible-playboo,257412 &#x2F;home&#x2F;conda&#x2F;envs&#x2F;ansible&#x2F;bin&#x2F;ansible-playbook -i &#x2F;work&#x2F;jenkins&#x2F;workspace&#x2F;mage-auto-devops&#x2F;aais&#x2F;tools&#x2F;ansible&#x2F;inventory.conf -vvv &#x2F;work&#x2F;jenkins&#x2F;workspace&#x2F;mage-auto-devops&#x2F;aais&#x2F;tools&#x2F;ansible&#x2F;categraf.yaml<br>│   └─sh,257426 -c &#x2F;bin&#x2F;sh -c ‘&#x2F;home&#x2F;conda&#x2F;envs&#x2F;ansible&#x2F;bin&#x2F;python &#x2F;tmp&#x2F;jenkins&#x2F;ansibletmpl&#x2F;ansible-local-257296rnz0q177&#x2F;ansible-tmp-1665562937.9518697-257412-178133226040161&#x2F;AnsiballZ_synchronize.py &amp;&amp; sleep 0’<br>│       └─sh,257427 -c &#x2F;home&#x2F;conda&#x2F;envs&#x2F;ansible&#x2F;bin&#x2F;python &#x2F;tmp&#x2F;jenkins&#x2F;ansibletmpl&#x2F;ansible-local-257296rnz0q177&#x2F;ansible-tmp-1665562937.9518697-257412-178133226040161&#x2F;AnsiballZ_synchronize.py &amp;&amp; sleep 0<br>│           └─python,257428 &#x2F;tmp&#x2F;jenkins&#x2F;ansibletmpl&#x2F;ansible-local-257296rnz0q177&#x2F;ansible-tmp-1665562937.9518697-257412-178133226040161&#x2F;AnsiballZ_synchronize.py<br>│               └─rsync,257429 –delay-updates -F –compress –delete-after –archive –rsh&#x3D;&#x2F;usr&#x2F;bin&#x2F;ssh -S none -o StrictHostKeyChecking&#x3D;no -o UserKnownHostsFile&#x3D;&#x2F;dev&#x2F;null –out-format&#x3D;&lt;<CHANGED>&gt;%i %n%L &#x2F;work&#x2F;jenkins&#x2F;workspace&#x2F;categraf&#x2F; <a href="mailto:&#109;&#x61;&#x67;&#101;&#x40;&#49;&#57;&#x32;&#x2e;&#x31;&#54;&#56;&#46;&#x31;&#x2e;&#x31;&#54;&#48;">&#109;&#x61;&#x67;&#101;&#x40;&#49;&#57;&#x32;&#x2e;&#x31;&#54;&#56;&#46;&#x31;&#x2e;&#x31;&#54;&#48;</a>:categraf&#x2F;<br>│                   └─ssh,257430 -S none -o StrictHostKeyChecking&#x3D;no -o UserKnownHostsFile&#x3D;&#x2F;dev&#x2F;null -l mage 192.168.1.160 rsync –server -logDtprze.iLsfxC –log-format&#x3D;%i –delete-after –delay-updates . categraf&#x2F;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<p>task_vars[‘ansible_shell_executable’]<br>task_vars[‘ansible_shell_type’]<br>task_vars[‘inventory_hostname’]  ‘192.168.1.105’</p>
<p>会循环这3个，然后获取对应的 hostvars 值<br>LOCALHOST &#x3D; (‘127.0.0.1’, ‘localhost’, ‘::1’)</p>
<p>task_vars[‘hostvars’]</p>
<p>loader.py<br>817 行<br>        plugin_load_context &#x3D; self.find_plugin_with_context(name, collection_list&#x3D;collection_list)  # collection_list&#x3D;None， name&#x3D;bash<br>        if not plugin_load_context.resolved or not plugin_load_context.plugin_resolved_path:</p>
<p>当是 bash的时候 plugin_load_context.plugin_resolved_path 这个是 None，导致这个if 进去了。<br>如果是 sh  的时候这个就是 ‘&#x2F;home&#x2F;mamh&#x2F;work&#x2F;github&#x2F;ansible-ansible&#x2F;lib&#x2F;ansible&#x2F;plugins&#x2F;shell&#x2F;sh.py’<br>如果是 cmd 的时候这个就是 ‘&#x2F;home&#x2F;mamh&#x2F;work&#x2F;github&#x2F;ansible-ansible&#x2F;lib&#x2F;ansible&#x2F;plugins&#x2F;shell&#x2F;cmd.py’  可以发现 这个变量 决定 用 ansible&#x2F;plugins&#x2F;shell 下面的哪个 文件了。</p>
<p>后面就看这个里面 怎么查找这个 插件的？？？<br>        plugin_load_context &#x3D; self.find_plugin_with_context(name, collection_list&#x3D;collection_list)  # collection_list&#x3D;None， name&#x3D;bash</p>
<pre><code>
</code></pre>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://magesfc.github.io">mage</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://magesfc.github.io/mage/a0bfcc2b49b5167196ecf1ed7f20f9eb180d9a43/">https://magesfc.github.io/mage/a0bfcc2b49b5167196ecf1ed7f20f9eb180d9a43/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://magesfc.github.io" target="_blank">马哥私房菜</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ansible/">ansible</a><a class="post-meta__tags" href="/tags/synchronize/">synchronize</a></div><div class="post_share"><div class="social-share" data-image="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/null" target="_blank"><img class="post-qr-code-img" src= "/img/loading.gif" data-lazy-src="/null" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/null" target="_blank"><img class="post-qr-code-img" src= "/img/loading.gif" data-lazy-src="/null" alt="支付寶"/></a><div class="post-qr-code-desc">支付寶</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/mage/9797fe175c0183a6563e7397692d780ecf683a6f/"><img class="prev-cover" src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Ansible自动化运维工具之ansible-resources</div></div></a></div><div class="next-post pull-right"><a href="/mage/11746f2e578549a6bef3af02d587fa65f8a9b7ab/"><img class="next-cover" src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Nightingale学习之安装部署</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/mage/9797fe175c0183a6563e7397692d780ecf683a6f/" title="Ansible自动化运维工具之ansible-resources"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-16</div><div class="title">Ansible自动化运维工具之ansible-resources</div></div></a></div><div><a href="/mage/531887d5e7eb014078dd6f2951d13500e0551ca5/" title="Ansible自动化运维工具之playbook介绍"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-04</div><div class="title">Ansible自动化运维工具之playbook介绍</div></div></a></div><div><a href="/mage/c480dbde40d58e354795a1a408fdb8bad06fe7cc/" title="Ansible自动化运维工具之role介绍"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-01</div><div class="title">Ansible自动化运维工具之role介绍</div></div></a></div><div><a href="/mage/3988ad506287c3c5ea81a4669e671c026ed1520e/" title="Ansible自动化运维工具之总体介绍总结"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-04</div><div class="title">Ansible自动化运维工具之总体介绍总结</div></div></a></div><div><a href="/mage/c17549d1cd4516fc242a8551d78cc1754d69a33e/" title="Ansible自动化运维工具之常用的模块"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-04</div><div class="title">Ansible自动化运维工具之常用的模块</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "/img/loading.gif" data-lazy-src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">mage</div><div class="author-info__description"> 这里是 马哥 的个人博客 </div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">167</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">185</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">34</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mamh2021"><i class="fab fa-github"></i><span>GitHub</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/mamh2021" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%97%AE%E9%A2%981%EF%BC%9A"><span class="toc-number">1.</span> <span class="toc-text">问题1：</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-1"><span class="toc-number">1.1.</span> <span class="toc-text">问题分析 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-2"><span class="toc-number">1.2.</span> <span class="toc-text">问题分析 2</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/mage/c480dbde40d58e354795a1a408fdb8bad06fe7cc/" title="Ansible自动化运维工具之role介绍"><img src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Ansible自动化运维工具之role介绍"/></a><div class="content"><a class="title" href="/mage/c480dbde40d58e354795a1a408fdb8bad06fe7cc/" title="Ansible自动化运维工具之role介绍">Ansible自动化运维工具之role介绍</a><time datetime="2022-12-01T12:18:31.000Z" title="更新于 2022-12-01 20:18:31">2022-12-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/mage/6118b9bf91824574204e116d5b138ffbaab72268/" title="Golang学习之struct转json"><img src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Golang学习之struct转json"/></a><div class="content"><a class="title" href="/mage/6118b9bf91824574204e116d5b138ffbaab72268/" title="Golang学习之struct转json">Golang学习之struct转json</a><time datetime="2022-11-14T06:06:32.000Z" title="更新于 2022-11-14 14:06:32">2022-11-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/mage/9e24b8712fd7596796aa8992d2b6496d0660585a/" title="jenkins学习之记master的一次报错"><img src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="jenkins学习之记master的一次报错"/></a><div class="content"><a class="title" href="/mage/9e24b8712fd7596796aa8992d2b6496d0660585a/" title="jenkins学习之记master的一次报错">jenkins学习之记master的一次报错</a><time datetime="2022-11-11T05:29:56.000Z" title="更新于 2022-11-11 13:29:56">2022-11-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/mage/3b62171753fddbbf78c36e3f6d7c9ba008365560/" title="Golang学习之mtail"><img src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Golang学习之mtail"/></a><div class="content"><a class="title" href="/mage/3b62171753fddbbf78c36e3f6d7c9ba008365560/" title="Golang学习之mtail">Golang学习之mtail</a><time datetime="2022-11-11T02:54:18.000Z" title="更新于 2022-11-11 10:54:18">2022-11-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/mage/f7b2ae126d593c93046cbf03febb201f10fef861/" title="Golang学习之类型转换"><img src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Golang学习之类型转换"/></a><div class="content"><a class="title" href="/mage/f7b2ae126d593c93046cbf03febb201f10fef861/" title="Golang学习之类型转换">Golang学习之类型转换</a><time datetime="2022-11-08T13:52:36.000Z" title="更新于 2022-11-08 21:52:36">2022-11-08</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2022 By mage</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="true" data-click="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>