<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>gerrit源码分析之ls-user-refs命令的实现 | 马哥私房菜</title><meta name="author" content="mage"><meta name="copyright" content="mage"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="今天我们讲讲gerrit 的 ssh 命令的 ls-user-refs命令的实现的实现，采用的代码是gerrit的 stable2.15 分支的，因为我们使用的版本是 2.15.1的。 LsUserRefs 类详解123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051">
<meta property="og:type" content="article">
<meta property="og:title" content="gerrit源码分析之ls-user-refs命令的实现">
<meta property="og:url" content="https://magesfc.github.io/mage/e854c498a45a92fcd548e4078c82c78d997810b8/">
<meta property="og:site_name" content="马哥私房菜">
<meta property="og:description" content="今天我们讲讲gerrit 的 ssh 命令的 ls-user-refs命令的实现的实现，采用的代码是gerrit的 stable2.15 分支的，因为我们使用的版本是 2.15.1的。 LsUserRefs 类详解123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg">
<meta property="article:published_time" content="2022-02-23T09:47:19.000Z">
<meta property="article:modified_time" content="2022-02-23T09:47:19.000Z">
<meta property="article:author" content="mage">
<meta property="article:tag" content="gerrit">
<meta property="article:tag" content="user">
<meta property="article:tag" content="ls">
<meta property="article:tag" content="refs">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg"><link rel="shortcut icon" href="http://www.blackshark.com/favicon.ico"><link rel="canonical" href="https://magesfc.github.io/mage/e854c498a45a92fcd548e4078c82c78d997810b8/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: mage","link":"链接: ","source":"来源: 马哥私房菜","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'gerrit源码分析之ls-user-refs命令的实现',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-02-23 17:47:19'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><style type="text/css">.card-announcement .social-button{margin:.6rem 0 0 0;text-align:center}.card-announcement .social-button a{display:block;background-color:var(--btn-bg);color:var(--btn-color);text-align:center;line-height:2.4;margin:4px 0}.card-announcement .social-button a:hover{background-color:var(--btn-hover-color)}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "/img/loading.gif" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">184</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">200</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">38</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-compass"></i><span> 目录</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 精选文档</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/21cfbf15/"><span> 🚀 快速开始</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/dc584b87/"><span> 📑 主题页面</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/4aa8abbe/"><span> 🛠 主题配置-1</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/ceeb73f/"><span> 🛠 主题配置-2</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/98d20436/"><span> ❓ 主题问答</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/4073eda/"><span> ⚡️ 进阶教程</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/198a4240/"><span> ✨ 更新日志</span></a></li></ul></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://butterfly.js.org/link/"><i class="fa-fw fas fa-thumbs-up"></i><span> 其他示例</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">马哥私房菜</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-compass"></i><span> 目录</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 精选文档</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/21cfbf15/"><span> 🚀 快速开始</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/dc584b87/"><span> 📑 主题页面</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/4aa8abbe/"><span> 🛠 主题配置-1</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/ceeb73f/"><span> 🛠 主题配置-2</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/98d20436/"><span> ❓ 主题问答</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/4073eda/"><span> ⚡️ 进阶教程</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/198a4240/"><span> ✨ 更新日志</span></a></li></ul></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://butterfly.js.org/link/"><i class="fa-fw fas fa-thumbs-up"></i><span> 其他示例</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">gerrit源码分析之ls-user-refs命令的实现</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-02-23T09:47:19.000Z" title="发表于 2022-02-23 17:47:19">2022-02-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-02-23T09:47:19.000Z" title="更新于 2022-02-23 17:47:19">2022-02-23</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/gerrit/">gerrit</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="gerrit源码分析之ls-user-refs命令的实现"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>今天我们讲讲gerrit 的 ssh 命令的 ls-user-refs命令的实现的实现，采用的代码是gerrit的 stable2.15 分支的，因为我们使用的版本是 2.15.1的。</p>
<h1 id="LsUserRefs-类详解"><a href="#LsUserRefs-类详解" class="headerlink" title="LsUserRefs 类详解"></a>LsUserRefs 类详解</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">这个命令在 com.google.gerrit.sshd.commands.LsUserRefs 类中，</span><br><span class="line">@RequiresCapability(GlobalCapability.ADMINISTRATE_SERVER)</span><br><span class="line">@CommandMetaData(</span><br><span class="line">    name = &quot;ls-user-refs&quot;,</span><br><span class="line">    description = &quot;List refs visible to a specific user&quot;,</span><br><span class="line">    runsAt = MASTER_OR_SLAVE)</span><br><span class="line">public class LsUserRefs extends SshCommand &#123;</span><br><span class="line">  @Inject private AccountResolver accountResolver;</span><br><span class="line">  @Inject private OneOffRequestContext requestContext;</span><br><span class="line">  @Inject private VisibleRefFilter.Factory refFilterFactory;</span><br><span class="line">  @Inject private GitRepositoryManager repoManager;</span><br><span class="line"></span><br><span class="line">  @Option(</span><br><span class="line">      name = &quot;--project&quot;,</span><br><span class="line">      aliases = &#123;&quot;-p&quot;&#125;,</span><br><span class="line">      metaVar = &quot;PROJECT&quot;,</span><br><span class="line">      required = true,</span><br><span class="line">      usage = &quot;project for which the refs should be listed&quot;)</span><br><span class="line">  private ProjectControl projectControl;</span><br><span class="line"></span><br><span class="line">  @Option(</span><br><span class="line">      name = &quot;--user&quot;,</span><br><span class="line">      aliases = &#123;&quot;-u&quot;&#125;,</span><br><span class="line">      metaVar = &quot;USER&quot;,</span><br><span class="line">      required = true,</span><br><span class="line">      usage = &quot;user for which the groups should be listed&quot;)</span><br><span class="line">  private String userName;</span><br><span class="line"></span><br><span class="line">  @Option(name = &quot;--only-refs-heads&quot;, usage = &quot;list only refs under refs/heads&quot;)</span><br><span class="line">  private boolean onlyRefsHeads;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  protected void run() throws Failure &#123;</span><br><span class="line">    Account userAccount;</span><br><span class="line">    try &#123;</span><br><span class="line">      userAccount = accountResolver.find(userName);</span><br><span class="line">    &#125; catch (OrmException | IOException | ConfigInvalidException e) &#123;</span><br><span class="line">      throw die(e);</span><br><span class="line">    &#125;</span><br><span class="line">    if (userAccount == null) &#123;</span><br><span class="line">      stdout.print(&quot;No single user could be found when searching for: &quot; + userName + &#x27;\n&#x27;);</span><br><span class="line">      stdout.flush();</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Project.NameKey projectName = projectControl.getProject().getNameKey();</span><br><span class="line">    try (Repository repo = repoManager.openRepository(projectName);</span><br><span class="line">        ManualRequestContext ctx = requestContext.openAs(userAccount.getId())) &#123;</span><br><span class="line">      try &#123;</span><br><span class="line">        Map&lt;String, Ref&gt; refsMap =</span><br><span class="line">            refFilterFactory</span><br><span class="line">                .create(projectControl.getProjectState(), repo)</span><br><span class="line">                .filter(repo.getRefDatabase().getRefs(ALL), false);</span><br><span class="line"></span><br><span class="line">        for (String ref : refsMap.keySet()) &#123;</span><br><span class="line">          if (!onlyRefsHeads || ref.startsWith(RefNames.REFS_HEADS)) &#123;</span><br><span class="line">            stdout.println(ref);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; catch (IOException e) &#123;</span><br><span class="line">        throw new Failure(1, &quot;fatal: Error reading refs: &#x27;&quot; + projectName, e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; catch (RepositoryNotFoundException e) &#123;</span><br><span class="line">      throw die(&quot;&#x27;&quot; + projectName + &quot;&#x27;: not a git archive&quot;);</span><br><span class="line">    &#125; catch (IOException | OrmException e) &#123;</span><br><span class="line">      throw die(&quot;Error opening: &#x27;&quot; + projectName);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="注解-RequiresCapability-GlobalCapability-ADMINISTRATE-SERVER"><a href="#注解-RequiresCapability-GlobalCapability-ADMINISTRATE-SERVER" class="headerlink" title="注解@RequiresCapability(GlobalCapability.ADMINISTRATE_SERVER)"></a>注解@RequiresCapability(GlobalCapability.ADMINISTRATE_SERVER)</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@RequiresCapability(GlobalCapability.ADMINISTRATE_SERVER)</span><br><span class="line">这个暂时没理解， 估计是 需要什么 能力， 也就是 Requires Capability字面翻译， 需要一个全局的 能力GlobalCapability， 感觉像是 需要什么权限类似的，就是说执行这个 ls-user-refs命令 命令是需要一定权限的。</span><br><span class="line"></span><br><span class="line">下面我们看看  com.google.gerrit.common.data.GlobalCapability 类里面的， 可以发现 里面确实是一个一个的权限类型。</span><br><span class="line">/** Server wide capabilities. Represented as &#123;@link Permission&#125; objects. */</span><br><span class="line">public class GlobalCapability &#123;</span><br><span class="line">  /** Ability to access the database (with gsql). */</span><br><span class="line">  public static final String ACCESS_DATABASE = &quot;accessDatabase&quot;;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * Denotes the server&#x27;s administrators.</span><br><span class="line">   *</span><br><span class="line">   * &lt;p&gt;This is similar to UNIX root, or Windows SYSTEM account. Any user that has this capability</span><br><span class="line">   * can perform almost any other action, or can grant themselves the power to perform any other</span><br><span class="line">   * action on the site. Most of the other capabilities and permissions fall-back to the predicate</span><br><span class="line">   * &quot;OR user has capability ADMINISTRATE_SERVER&quot;.</span><br><span class="line">   */</span><br><span class="line">  public static final String ADMINISTRATE_SERVER = &quot;administrateServer&quot;;</span><br><span class="line"></span><br><span class="line">GlobalCapability.ADMINISTRATE_SERVER 就是管理员。</span><br><span class="line"></span><br><span class="line">@RequiresCapability 这个注解 放这里就是说明 执行 ls-user-refs命令 需要 administrateServer 权限。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="注解-CommandMetaData-分析"><a href="#注解-CommandMetaData-分析" class="headerlink" title="注解@CommandMetaData 分析"></a>注解@CommandMetaData 分析</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@CommandMetaData(</span><br><span class="line">    name = &quot;ls-user-refs&quot;,</span><br><span class="line">    description = &quot;List refs visible to a specific user&quot;,</span><br><span class="line">    runsAt = MASTER_OR_SLAVE)</span><br><span class="line"></span><br><span class="line">这个是 定义 这个类是要执行什么命令的， name 就是命令名称了。 description 命令的描述，runsAt 表示这个命令可以运行在master端 还是 slave端。（gerrit也有 master - slave的模式的。有些命令是在slave模式下面没有的。）</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="LsUserRefs-extends-SshCommand"><a href="#LsUserRefs-extends-SshCommand" class="headerlink" title="LsUserRefs extends SshCommand"></a>LsUserRefs extends SshCommand</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public class LsUserRefs extends SshCommand &#123;</span><br><span class="line">  @Inject private AccountResolver accountResolver;</span><br><span class="line">  @Inject private OneOffRequestContext requestContext;</span><br><span class="line">  @Inject private VisibleRefFilter.Factory refFilterFactory;</span><br><span class="line">  @Inject private GitRepositoryManager repoManager;</span><br><span class="line"></span><br><span class="line">从这个 extends 继承关系可以发现 所有的  ssh -p 29418 gerrit.example.com gerrit &lt;命令&gt;  这样类似的命令估计都会 继承 SshCommand  类。</span><br><span class="line">一般的类似spring IOC这样的容器，在服务启动之后 会扫描所有的 子类的实现， 例如扫描所有 SshCommand 子类，</span><br><span class="line">然后就可以得到所有的ssh命令行的实现，然后在自动的依赖注入，下面我们就会看到。</span><br><span class="line">又比如，jenkins中，很多类都会实现 JobProperty ，（比如这个插件 public class BuildLogCompressor extends JobProperty&lt;AbstractProject&lt;?, ?&gt;&gt;），</span><br><span class="line">这样jenkins在启动的时候会 扫描所有的 实现JobProperty类。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="Inject依赖注入"><a href="#Inject依赖注入" class="headerlink" title="@Inject依赖注入"></a>@Inject依赖注入</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public class LsUserRefs extends SshCommand &#123;</span><br><span class="line">  @Inject private AccountResolver accountResolver;</span><br><span class="line">  @Inject private OneOffRequestContext requestContext;</span><br><span class="line">  @Inject private VisibleRefFilter.Factory refFilterFactory;</span><br><span class="line">  @Inject private GitRepositoryManager repoManager;</span><br><span class="line"></span><br><span class="line">从这里 @Inject 我们可以看到 这里有4个成员， 这几个的实例化估计都是 通过 @Inject ，或者说是某个框架自动注入的。</span><br><span class="line">gerrit应该用的不是我们平常属性的spring框架，是google自己开发的一个 Guice - 轻量级IoC容器，Google公司开发的轻量级IoC容器，其特点是： 速度快，据说是spring的100倍速度；无需配置文件。</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="Option-注解"><a href="#Option-注解" class="headerlink" title="@Option 注解"></a>@Option 注解</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">  @Option(</span><br><span class="line">      name = &quot;--project&quot;,</span><br><span class="line">      aliases = &#123;&quot;-p&quot;&#125;,</span><br><span class="line">      metaVar = &quot;PROJECT&quot;,</span><br><span class="line">      required = true,</span><br><span class="line">      usage = &quot;project for which the refs should be listed&quot;)</span><br><span class="line">  private ProjectControl projectControl;</span><br><span class="line"></span><br><span class="line">  @Option(</span><br><span class="line">      name = &quot;--user&quot;,</span><br><span class="line">      aliases = &#123;&quot;-u&quot;&#125;,</span><br><span class="line">      metaVar = &quot;USER&quot;,</span><br><span class="line">      required = true,</span><br><span class="line">      usage = &quot;user for which the groups should be listed&quot;)</span><br><span class="line">  private String userName;</span><br><span class="line"></span><br><span class="line">  @Option(name = &quot;--only-refs-heads&quot;, usage = &quot;list only refs under refs/heads&quot;)</span><br><span class="line">  private boolean onlyRefsHeads;</span><br><span class="line"></span><br><span class="line">先看 private ProjectControl projectControl;</span><br><span class="line">这个注解 应该是 设置命令 需要的选项，然后把 命令行参数 选项后面的值 初始化到对应的类成员变量中，</span><br><span class="line">例如 --project 这个选项，如果命令行上 填写了， --project git/android/repo 这样的， gerrit就会初始 projectControl 这个，</span><br><span class="line">这个变量是个复杂的类型， 不过这个类 ProjectControl 里面肯定有一个属性 会存放 git/android/repo  这个值的。不过通过看 ProjectControl源码发现，</span><br><span class="line">并没有这么简单，里面嵌入了好几层。 不过通过字面意思和命令参数的作用，可以猜出 这个 projectControl 就是存放 git 仓库路径的， 就是gerrit上的project的。 例如命令 create-branch 中有这个 project的概念。</span><br><span class="line">下面是 create-branch 中的</span><br><span class="line">com.google.gerrit.sshd.commands.CreateBranchCommand</span><br><span class="line">  @Argument(index = 0, required = true, metaVar = &quot;PROJECT&quot;, usage = &quot;name of the project&quot;)</span><br><span class="line">  private ProjectControl project;</span><br><span class="line">这个 ProjectControl 属性，和我们猜测的一样。</span><br><span class="line"></span><br><span class="line">name = &quot;--project&quot;, 指定选项名称，</span><br><span class="line">aliases = &#123;&quot;-p&quot;&#125;, 指定了选项别名，这里是一个短选项，例如很多linux中的命令 都有 长选项 和 短选项的。</span><br><span class="line">metaVar = &quot;PROJECT&quot;, 说明选项后面需要跟上一个值的。</span><br><span class="line">required = true, 表面这个选项是必须的。有些选项是可选的，就是可以不用显示的指出，这些应该是会有一个默认值。</span><br><span class="line">但是像这个 如果不执行，怎么知道你要查看哪个仓库下面的 refs 是否有权限呢？？？ 要不然所有仓库都列出来？，这样就会太多了。</span><br><span class="line">一个命令 尽可能的做到功能单一， 一个命令再和其他命令组合起来实现一个复杂的命令。就比如这个想列出来所有仓库的，</span><br><span class="line">可以先用 ls-projects 命令列出所有仓库，然后再结合 这个 ls-user-refs 命令。这就是unix编程艺术 思想。</span><br><span class="line">usage = &quot;project for which the refs should be listed&quot; 这个说明了这个选项的作用，描述等等。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">再看另外一个  private String userName;</span><br><span class="line">这个应该是 用户名，就是你想列出 哪个用的 对这个仓库的 </span><br><span class="line"></span><br><span class="line">最后看 private boolean onlyRefsHeads;</span><br><span class="line">这是一个布尔类型的，如果命令行有个 --only-refs-heads 选项，就只会 列出 refs/heads/ 下面的。也就是之后列出分支了。</span><br><span class="line">如果没有就会 列出 refs/heads/  和 refs/tags/ 下面的。</span><br><span class="line"></span><br><span class="line"> 这个注解 其实是来自jenkins的。哈哈哈。 import org.kohsuke.args4j.Option;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<h1 id="run-方法"><a href="#run-方法" class="headerlink" title="run() 方法"></a>run() 方法</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">  @Override</span><br><span class="line">  protected void run() throws Failure &#123;</span><br><span class="line"></span><br><span class="line">最后我们看这个 run() 方法，这个很类似  java 中Thread的用法，里面放到就是命令主要实现。</span><br><span class="line"></span><br><span class="line">public abstract class SshCommand extends BaseCommand &#123;</span><br><span class="line">SshCommand 继承 BaseCommand 类，估计出了 ssh 命令，还会有其他的命令类型吧。 例如 HttpCommand？？？ GitCommand？？？这里只是猜测。。</span><br><span class="line"></span><br><span class="line">public abstract class BaseCommand implements Command &#123;</span><br><span class="line">BaseCommand 又实现了 接口 Command， 原来是 org.apache.sshd.server.Command 这个接口，也就是 apache 的ssh命令实现。</span><br><span class="line"></span><br><span class="line">我们猜测的 真对，还真有个 gitcommand，估计是执行git相关的命令的。</span><br><span class="line">public abstract class AbstractGitCommand extends BaseCommand</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">从run() 方法中我们可以看到 仓库路径 project 是怎么用的：</span><br><span class="line">    Project.NameKey projectName = projectControl.getProject().getNameKey();</span><br><span class="line">仓库名，仓库路径是存放为    Project.NameKey 类型的。。。。。projectControl里面包装了好几层。。。</span><br><span class="line">有了git仓库 然后怎么使用呢，调用 repoManager 来 处理 git仓库：</span><br><span class="line">    try (Repository repo = repoManager.openRepository(projectName);</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">from https://blog.csdn.net/czq7511/article/details/73610510</span><br><span class="line">本文章主要记录本人在学习开发Gerrit插件过程中的一些心得，一些零零碎碎的资料：</span><br><span class="line"></span><br><span class="line">一、关于插件jar的META-INF/MANIFEST.MF文件：这个文件的主要作用是记录一些有关这个jar的属性，以便被识别、引用或加载，也可以理解为是这个jar的配置文件。</span><br><span class="line"></span><br><span class="line">这里举些例子：</span><br><span class="line"></span><br><span class="line">Manifest-Version: 1.0----配置版本号。如果日后要做升级兼容的话，可以利用这个属性。</span><br><span class="line">Gerrit-ApiType: plugin----指定Gerrit插件类型为plugin。Gerrit插件类型有两种：plugin和extension</span><br><span class="line">Gerrit-ApiVersion: 2.13.7----指定该插件匹配的Gerrit平台版本，如果指定版本不一致的话，插件很有可能不能用。</span><br><span class="line">Implementation-Title: Cookbook plugin ----实现Titile</span><br><span class="line">Implementation-Version: 2.13.7----实现的版本号，也就是该插件的版本号，一般和要适应的Gerrit平台的版本号一致。</span><br><span class="line">Archiver-Version: Plexus Archiver----</span><br><span class="line">Built-By: czq ----打包作者</span><br><span class="line"></span><br><span class="line">Gerrit-PluginName: cookbook----插件名称</span><br><span class="line">Gerrit-Module: com.googlesource.gerrit.plugins.cookbook.Module----Gerrit加载插件时，会根据这个指定去加载相应的Module类。该类主要实现前后台业务逻辑。</span><br><span class="line">Gerrit-HttpModule: com.googlesource.gerrit.plugins.cookbook.HttpModule ----Gerrit加载插件时，会根据这个指定去加载相应的HttpModule类。该类主要实现Http接口业务逻辑。</span><br><span class="line">Gerrit-SshModule: com.googlesource.gerrit.plugins.cookbook.SshModule ----Gerrit加载插件时，会根据这个指定去加载相应的HttpModule类。该类主要实现SSH接口业务逻辑。</span><br><span class="line">Implementation-Vendor: Gerrit Code Review----开发商</span><br><span class="line">Created-By: Apache Maven 3.5.0----编译打包工具</span><br><span class="line">Build-Jdk: 1.8.0_101----编译的JDK版本</span><br><span class="line">Implementation-URL: https://gerrit-review.googlesource.com/#/admin/projects/plugins/cookbook-plugin  ----代码实现URL</span><br><span class="line"></span><br><span class="line">二、如何编译插件请参考：http://blog.csdn.net/czq7511/article/details/73189168</span><br><span class="line"></span><br><span class="line">三、Gerrit插件的前端独立UI主要是用GWT来开发，通过在pom.xml里来指定编译入口，如(module是入口类，省去了扩展名gwt.xml)：</span><br><span class="line"></span><br><span class="line">      &lt;plugin&gt;</span><br><span class="line">        &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;gwt-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.7.0&lt;/version&gt;</span><br><span class="line">        &lt;configuration&gt;</span><br><span class="line">          &lt;module&gt;com.googlesource.gerrit.plugins.cookbook.HelloForm&lt;/module&gt;</span><br><span class="line">          &lt;disableClassMetadata&gt;true&lt;/disableClassMetadata&gt;</span><br><span class="line">          &lt;disableCastChecking&gt;true&lt;/disableCastChecking&gt;</span><br><span class="line">          &lt;webappDirectory&gt;$&#123;project.build.directory&#125;/classes/static&lt;/webappDirectory&gt;</span><br><span class="line">        &lt;/configuration&gt;</span><br><span class="line">        &lt;executions&gt;</span><br><span class="line">          &lt;execution&gt;</span><br><span class="line">            &lt;goals&gt;</span><br><span class="line">              &lt;goal&gt;compile&lt;/goal&gt;</span><br><span class="line">            &lt;/goals&gt;</span><br><span class="line">          &lt;/execution&gt;</span><br><span class="line">        &lt;/executions&gt;</span><br><span class="line">      &lt;/plugin&gt;</span><br><span class="line"></span><br><span class="line">GWT编译时，会默认对与gwt.xml文件同目录下的client和public两目录下的所以文件进行编译打包，包的名字默认是插件名，可以修改，可以在gwt.xml里的rename-to属性上指定。该包名主要用于gerrit加载插件时，Module模块里指定加载，以便加载前端业务，具体加载代码：</span><br><span class="line"></span><br><span class="line">DynamicSet.bind(binder(), WebUiPlugin.class).toInstance(new GwtPlugin(&quot;rename-to属性上指定的名字&quot;));</span><br><span class="line"></span><br><span class="line">四、对插件创建的screen的引用，必须加 #/x/，因为screen被加载时，会在指定的token前加上/x/ 标签，可参见加载源码：</span><br><span class="line"></span><br><span class="line">gerrit-plugin-gwtui/src/main/java/com/google/gerrit/plugin/client/plugin.java 里的注释说明</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">五、使用MenuItem时，第二个参当我若有 # 号，第三个参数要填写，且为空字符，否则 # 号在前端会被显示为 %23</span><br><span class="line"></span><br><span class="line">六、如何判断用户是否已登录：</span><br><span class="line"></span><br><span class="line">　　１、菜单：继承于菜单TopMenu.class的类有一个构建方法，构建时会传入用户信息类，可通过该类来判断，如：</span><br><span class="line"></span><br><span class="line">  @Inject</span><br><span class="line">  public ImporterTopMenu(@PluginName String pluginName, Provider&lt;CurrentUser&gt; userProvider) &#123;</span><br><span class="line">    if (userProvider.get().isIdentifiedUser()) &#123;</span><br><span class="line">//这里表示用户已登录</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">//这里表示用户未登录</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;　　　　</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">　　２、服务：服务类是继承于RestModifyView.class的，该类的构建方法也会传入 用户信息类 参数，用法同 1</span><br></pre></td></tr></table></figure>


</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://magesfc.github.io">mage</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://magesfc.github.io/mage/e854c498a45a92fcd548e4078c82c78d997810b8/">https://magesfc.github.io/mage/e854c498a45a92fcd548e4078c82c78d997810b8/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://magesfc.github.io" target="_blank">马哥私房菜</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/gerrit/">gerrit</a><a class="post-meta__tags" href="/tags/user/">user</a><a class="post-meta__tags" href="/tags/ls/">ls</a><a class="post-meta__tags" href="/tags/refs/">refs</a></div><div class="post_share"><div class="social-share" data-image="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/null" target="_blank"><img class="post-qr-code-img" src= "/img/loading.gif" data-lazy-src="/null" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/null" target="_blank"><img class="post-qr-code-img" src= "/img/loading.gif" data-lazy-src="/null" alt="支付寶"/></a><div class="post-qr-code-desc">支付寶</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/mage/9542844f15399cb21cdb1da671e09882982d6b16/"><img class="prev-cover" src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Hibernate学习之管理session和批量操作</div></div></a></div><div class="next-post pull-right"><a href="/mage/ff58bbe0f2d5ee3c8b0da4b8c1c7d2869072b2b1/"><img class="next-cover" src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Android下的配置管理之道之OpenGrok代码索引环境搭建</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/mage/9f11362bb48e38171ec1992629522ab39976a878/" title="Android下的配置管理之道之gerrit代码服务器之ssh队列详解"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-23</div><div class="title">Android下的配置管理之道之gerrit代码服务器之ssh队列详解</div></div></a></div><div><a href="/mage/8ac00d53eb291c161df9a3d30ccaca66be48f13c/" title="Android下的配置管理之道之gerrit修改project路径"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-23</div><div class="title">Android下的配置管理之道之gerrit修改project路径</div></div></a></div><div><a href="/mage/4ffe00a009758049d18e75751a7dcc4ee3a21ef9/" title="Android下的配置管理之道之gerrit安装github插件"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-23</div><div class="title">Android下的配置管理之道之gerrit安装github插件</div></div></a></div><div><a href="/mage/e2cc5e300708461bde262aaae49a064be28321d2/" title="Android下的配置管理之道之gerrit权限管理"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-23</div><div class="title">Android下的配置管理之道之gerrit权限管理</div></div></a></div><div><a href="/mage/b1cf003423f7ac158b861abd5a96522cbd2fae86/" title="Android下的配置管理之道之gerrit的ssh命令行工具"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-23</div><div class="title">Android下的配置管理之道之gerrit的ssh命令行工具</div></div></a></div><div><a href="/mage/037b07ff16870d51848a2e4b1a21052b80988d7d/" title="Android下的配置管理之道之安装gerrit代码服务器"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-23</div><div class="title">Android下的配置管理之道之安装gerrit代码服务器</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "/img/loading.gif" data-lazy-src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">mage</div><div class="author-info__description"> 这里是 马哥 的个人博客 </div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">184</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">200</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">38</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mamh2021"><i class="fab fa-github"></i><span>GitHub</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/mamh2021" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#LsUserRefs-%E7%B1%BB%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.</span> <span class="toc-text">LsUserRefs 类详解</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B3%A8%E8%A7%A3-RequiresCapability-GlobalCapability-ADMINISTRATE-SERVER"><span class="toc-number">2.</span> <span class="toc-text">注解@RequiresCapability(GlobalCapability.ADMINISTRATE_SERVER)</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B3%A8%E8%A7%A3-CommandMetaData-%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">注解@CommandMetaData 分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#LsUserRefs-extends-SshCommand"><span class="toc-number">4.</span> <span class="toc-text">LsUserRefs extends SshCommand</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Inject%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5"><span class="toc-number">5.</span> <span class="toc-text">@Inject依赖注入</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Option-%E6%B3%A8%E8%A7%A3"><span class="toc-number">6.</span> <span class="toc-text">@Option 注解</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#run-%E6%96%B9%E6%B3%95"><span class="toc-number">7.</span> <span class="toc-text">run() 方法</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/mage/e593793892e8e2c77cbc7bca0c9eb46ade08efa1/" title="Vue学习之vuex的四个map方法讲解"><img src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Vue学习之vuex的四个map方法讲解"/></a><div class="content"><a class="title" href="/mage/e593793892e8e2c77cbc7bca0c9eb46ade08efa1/" title="Vue学习之vuex的四个map方法讲解">Vue学习之vuex的四个map方法讲解</a><time datetime="2023-07-01T03:46:10.000Z" title="更新于 2023-07-01 11:46:10">2023-07-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/mage/0ccda5094ba02cf491f9788920b7c9ae98740abb/" title="Vue学习之mixin混入详解"><img src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Vue学习之mixin混入详解"/></a><div class="content"><a class="title" href="/mage/0ccda5094ba02cf491f9788920b7c9ae98740abb/" title="Vue学习之mixin混入详解">Vue学习之mixin混入详解</a><time datetime="2023-06-30T07:53:33.000Z" title="更新于 2023-06-30 15:53:33">2023-06-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/mage/fcf51869c12a4429c17398531baeb382770504d5/" title="Vue学习之slot插槽详解"><img src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Vue学习之slot插槽详解"/></a><div class="content"><a class="title" href="/mage/fcf51869c12a4429c17398531baeb382770504d5/" title="Vue学习之slot插槽详解">Vue学习之slot插槽详解</a><time datetime="2023-06-30T07:34:30.000Z" title="更新于 2023-06-30 15:34:30">2023-06-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/mage/86add1806f9c7175f79044b87f82b5e2ed211aae/" title="Vue学习之组件之间的通信"><img src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Vue学习之组件之间的通信"/></a><div class="content"><a class="title" href="/mage/86add1806f9c7175f79044b87f82b5e2ed211aae/" title="Vue学习之组件之间的通信">Vue学习之组件之间的通信</a><time datetime="2023-06-30T07:33:09.000Z" title="更新于 2023-06-30 15:33:09">2023-06-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/mage/2de64dd780f183c8fe0810e908f6a75095526abb/" title="Vue学习之项目上线部署"><img src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Vue学习之项目上线部署"/></a><div class="content"><a class="title" href="/mage/2de64dd780f183c8fe0810e908f6a75095526abb/" title="Vue学习之项目上线部署">Vue学习之项目上线部署</a><time datetime="2023-06-29T06:33:09.000Z" title="更新于 2023-06-29 14:33:09">2023-06-29</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By mage</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="true" data-click="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>