<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Android下的配置管理之道之gerrit自动备份分支ref-protection插件 | 马哥私房菜</title><meta name="author" content="mage"><meta name="copyright" content="mage"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="最近研究了一个gerrit自动备份分支的插件。Ref protection 直译过来就是 引用保护.也就是保护 git下面 refs 的一个插件 1234567891011Ref protection plugin.Protects against commits being lost by creating backups of deleted refs (or non-fast-forward">
<meta property="og:type" content="article">
<meta property="og:title" content="Android下的配置管理之道之gerrit自动备份分支ref-protection插件">
<meta property="og:url" content="https://magesfc.github.io/mage/fdbb4b38b92cf47b0e24bc59c392393921287a2c/">
<meta property="og:site_name" content="马哥私房菜">
<meta property="og:description" content="最近研究了一个gerrit自动备份分支的插件。Ref protection 直译过来就是 引用保护.也就是保护 git下面 refs 的一个插件 1234567891011Ref protection plugin.Protects against commits being lost by creating backups of deleted refs (or non-fast-forward">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://t.mwm.moe/fj/">
<meta property="article:published_time" content="2022-02-23T09:47:18.000Z">
<meta property="article:modified_time" content="2022-10-31T08:56:22.000Z">
<meta property="article:author" content="mage">
<meta property="article:tag" content="android">
<meta property="article:tag" content="gerrit">
<meta property="article:tag" content="ref">
<meta property="article:tag" content="protection">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://t.mwm.moe/fj/"><link rel="shortcut icon" href="https://www.zeekrlife.com/favicon.png"><link rel="canonical" href="https://magesfc.github.io/mage/fdbb4b38b92cf47b0e24bc59c392393921287a2c/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: mage","link":"链接: ","source":"来源: 马哥私房菜","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Android下的配置管理之道之gerrit自动备份分支ref-protection插件',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-10-31 16:56:22'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><style type="text/css">.card-announcement .social-button{margin:.6rem 0 0 0;text-align:center}.card-announcement .social-button a{display:block;background-color:var(--btn-bg);color:var(--btn-color);text-align:center;line-height:2.4;margin:4px 0}.card-announcement .social-button a:hover{background-color:var(--btn-hover-color)}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "/img/loading.gif" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">219</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">230</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">40</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-compass"></i><span> 目录</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 精选文档</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/21cfbf15/"><span> 🚀 快速开始</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/dc584b87/"><span> 📑 主题页面</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/4aa8abbe/"><span> 🛠 主题配置-1</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/ceeb73f/"><span> 🛠 主题配置-2</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/98d20436/"><span> ❓ 主题问答</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/4073eda/"><span> ⚡️ 进阶教程</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/198a4240/"><span> ✨ 更新日志</span></a></li></ul></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://butterfly.js.org/link/"><i class="fa-fw fas fa-thumbs-up"></i><span> 其他示例</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://t.mwm.moe/fj/')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">马哥私房菜</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-compass"></i><span> 目录</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 精选文档</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/21cfbf15/"><span> 🚀 快速开始</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/dc584b87/"><span> 📑 主题页面</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/4aa8abbe/"><span> 🛠 主题配置-1</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/ceeb73f/"><span> 🛠 主题配置-2</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/98d20436/"><span> ❓ 主题问答</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/4073eda/"><span> ⚡️ 进阶教程</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/198a4240/"><span> ✨ 更新日志</span></a></li></ul></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://butterfly.js.org/link/"><i class="fa-fw fas fa-thumbs-up"></i><span> 其他示例</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Android下的配置管理之道之gerrit自动备份分支ref-protection插件</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-02-23T09:47:18.000Z" title="发表于 2022-02-23 17:47:18">2022-02-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-10-31T08:56:22.000Z" title="更新于 2022-10-31 16:56:22">2022-10-31</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/android/">android</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Android下的配置管理之道之gerrit自动备份分支ref-protection插件"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="最近研究了一个gerrit自动备份分支的插件。"><a href="#最近研究了一个gerrit自动备份分支的插件。" class="headerlink" title="最近研究了一个gerrit自动备份分支的插件。"></a>最近研究了一个gerrit自动备份分支的插件。</h1><p>Ref protection 直译过来就是 引用保护.也就是保护 git下面 refs 的一个插件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Ref protection plugin.</span><br><span class="line"></span><br><span class="line">Protects against commits being lost by creating backups of deleted refs (or non-fast-forward commits) under the refs/backups/ namespace.</span><br><span class="line"></span><br><span class="line">Branch deletion protection can be disabled by setting plugin.ref-protection.protectDeleted <span class="literal">false</span> <span class="keyword">in</span> gerrit.config. Similarly, non-fast-forward update protection can be disabled with plugin.ref-protection.protectFastForward <span class="literal">false</span>.</span><br><span class="line"></span><br><span class="line">Branches under refs/heads/ that are deleted or rewritten are backed up as refs/backups/heads/branch-name-YYYYMMDD-HHmmss by default, or as sequentially increasing numbers under refs/backups/heads/branch-name/<span class="comment"># by setting plugin.ref-protection.useTimestamp false.</span></span><br><span class="line"></span><br><span class="line">Tags under refs/tags/ that are deleted are backed up (as branches) as refs/backups/tags/tag-name-YYYYMMDD-HHmmss or as sequentially increasing numbers under refs/backups/tags/branch-name/<span class="comment"># using the same plugin.ref-protection.useTimestamp setting.</span></span><br><span class="line"></span><br><span class="line">By default, the backups are created as branches. Optionally, they may be created as tags, containing information about the original ref that was changed, as well as the user that performed the change. This can be enabled by setting plugin.ref-protection.createTag <span class="literal">true</span>.</span><br></pre></td></tr></table></figure>

<p>根据说明 是当在gerrit上删除分支&#x2F;或者采用了 git 强制push的时候，会触发这个备份分支的动作。<br>在使用过程中发现,git 强制push的时候会报如下的错误。通过分析发现是 git push的这个账号没有<br>在 refs&#x2F;backups&#x2F;* 下面有 create refs 的权限。加上这个权限就不会报错了。<br>不过总觉得这个不合理。你管我怎么操作的，你都要给我备份了就行了。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[2019-12-31 16:23:13,294] [ReceiveCommits-1] ERROR com.googlesource.gerrit.plugins.refprotection.BackupRef : CreateBranch.Input: refs/backups/heads/test_for_20191231_162313-5130c6f4d1dd84a9eae13eca14e627db50f843bd</span><br><span class="line">[2019-12-31 16:23:13,294] [ReceiveCommits-1] ERROR com.googlesource.gerrit.plugins.refprotection.BackupRef : CreateBranch.Input: com.google.gerrit.server.project.CreateBranch$Factory</span><br><span class="line">[2019-12-31 16:23:13,294] [ReceiveCommits-1] ERROR com.googlesource.gerrit.plugins.refprotection.BackupRef : project: com.google.gerrit.server.project.ProjectResource@55f9da39</span><br><span class="line">[2019-12-31 16:23:13,297] [ReceiveCommits-1] ERROR com.googlesource.gerrit.plugins.refprotection.BackupRef : Cannot create &quot;refs/backups/heads/test_for_20191231_162313&quot;</span><br><span class="line">com.google.gerrit.extensions.restapi.AuthException: Cannot create &quot;refs/backups/heads/test_for_20191231_162313&quot;</span><br><span class="line">	at com.google.gerrit.server.project.CreateBranch.apply(CreateBranch.java:138)</span><br><span class="line">	at com.googlesource.gerrit.plugins.refprotection.BackupRef.createBackup(BackupRef.java:162)</span><br><span class="line">	at com.googlesource.gerrit.plugins.refprotection.RefUpdateListener.onEvent(RefUpdateListener.java:92)</span><br><span class="line">	at com.google.gerrit.common.ChangeHookRunner.fireEventForUnrestrictedListeners(ChangeHookRunner.java:742)</span><br><span class="line">	at com.google.gerrit.common.ChangeHookRunner.fireEvent(ChangeHookRunner.java:789)</span><br><span class="line">	at com.google.gerrit.common.ChangeHookRunner.doRefUpdatedHook(ChangeHookRunner.java:610)</span><br><span class="line">	at com.google.gerrit.server.git.ReceiveCommits.processCommands(ReceiveCommits.java:662)</span><br><span class="line">	at com.google.gerrit.server.git.AsyncReceiveCommits$Worker.run(AsyncReceiveCommits.java:89)</span><br><span class="line">	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)</span><br><span class="line">	at com.google.gerrit.server.util.RequestScopePropagator$5.call(RequestScopePropagator.java:222)</span><br><span class="line">	at com.google.gerrit.server.util.RequestScopePropagator$4.call(RequestScopePropagator.java:201)</span><br><span class="line">	at com.google.gerrit.server.util.ThreadLocalRequestScopePropagator$1.call(ThreadLocalRequestScopePropagator.java:55)</span><br><span class="line">	at com.google.gerrit.server.util.RequestScopePropagator$1.call(RequestScopePropagator.java:98)</span><br><span class="line">	at com.google.gerrit.server.util.RequestScopePropagator$2.run(RequestScopePropagator.java:131)</span><br><span class="line">	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)</span><br><span class="line">	at java.util.concurrent.FutureTask.run(FutureTask.java:266)</span><br><span class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(ScheduledThreadPoolExecutor.java:180)</span><br><span class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:293)</span><br><span class="line">	at com.google.gerrit.server.git.WorkQueue$Task.run(WorkQueue.java:376)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:748)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">在 refs/backups/* 下面有 create refs 的权限</span><br><span class="line">-[access &quot;refs/backups/*&quot;]</span><br><span class="line">-	create = group Administrators</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>下面这个是在gerrit上删除分支 触发的 打印的日志。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[2019-12-31 16:21:26,179] [HTTP-71] INFO  com.googlesource.gerrit.plugins.refprotection.RefUpdateListener : Ref Deleted: project [git/shared/tools/blog] refname [refs/heads/test4] old object <span class="built_in">id</span> [5130c6f4d1dd84a9eae13eca14e627db50f843bd]</span><br><span class="line">[2019-12-31 16:21:26,180] [HTTP-71] ERROR com.googlesource.gerrit.plugins.refprotection.BackupRef : CreateBranch.Input: refs/backups/heads/test4_for_20191231_162126-5130c6f4d1dd84a9eae13eca14e627db50f843bd</span><br><span class="line">[2019-12-31 16:21:26,180] [HTTP-71] ERROR com.googlesource.gerrit.plugins.refprotection.BackupRef : CreateBranch.Input: com.google.gerrit.server.project.CreateBranch<span class="variable">$Factory</span></span><br><span class="line">[2019-12-31 16:21:26,180] [HTTP-71] ERROR com.googlesource.gerrit.plugins.refprotection.BackupRef : project: com.google.gerrit.server.project.ProjectResource@2ad678a6</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面准备通过源码来 跟踪一下执行过程，看看为啥会有这个区别。或者为啥会有这个报错。</p>
<p>准备工作</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">gerrit 2.12.x 版本</span><br><span class="line"></span><br><span class="line">从github克隆插件源代码。并且检出到 2.12的分支上。</span><br><span class="line">~/gerrit/plugins/ref-protection</span><br><span class="line">$ git ll</span><br><span class="line">*   3422dca - Merge branch &#x27;stable-2.11&#x27; into master                                                                                   — Doug Kelly (HEAD, origin/stable-2.12) - (4 年 2 个月前)</span><br><span class="line">|\  </span><br><span class="line">| * 0359382 - Fix buck test in standalone BUCK build                                                                                   — David Ostrovsky - (4 年 7 个月前)</span><br><span class="line">| * 31473ff - Add standalone BUCK build                                                                                                — David Pursehouse - (4 年 7 个月前)</span><br><span class="line">* | 0b80a00 - Add documentation updates                                                                                                — Doug Kelly - (4 年 5 个月前)</span><br><span class="line">* | bc23cba - Add details from original tag                                                                                            — Doug Kelly - (4 年 3 个月前)</span><br><span class="line">* | 7ca1b83 - Add ability to back up as tag                                                                                            — Doug Kelly - (4 年 3 个月前)</span><br><span class="line">* | 164b578 - Correct backup of tags                                                                                                   — Doug Kelly - (4 年 2 个月前)</span><br><span class="line">* | 241b34a - Switch to EventListener                                                                                                  — Doug Kelly - (4 年 3 个月前)</span><br><span class="line">* | 6367acf - Add configuration for backup branch names                                                                                — Doug Kelly - (4 年 3 个月前)</span><br><span class="line">* | a711e12 - Add configuration for levels of protection                                                                               — Doug Kelly - (4 年 3 个月前)</span><br><span class="line">* | 95d2f2c - Fix MissingObjectException when checking for non-ff update                                                               — Doug Kelly - (4 年 3 个月前)</span><br><span class="line">* | 007313a - Refactor backup creation to BackupRef                                                                                    — Doug Kelly - (4 年 6 个月前)</span><br><span class="line">|/  </span><br><span class="line">* 7d6c9c6 - Add missing licence headers                                                                                              — David Pursehouse - (4 年 7 个月前)</span><br><span class="line">* 9d3c6e2 - Convert to use auto-closeable Repository and RevWalk                                                                     — David Pursehouse - (4 年 10 个月前)</span><br><span class="line">* 72eebe7 - Create backup branches under refs/backups/                                                                               — David Pursehouse - (5 年前)</span><br><span class="line">* ea03470 - Fix a couple of minor style nits                                                                                         — David Pursehouse - (5 年前)</span><br><span class="line">* 27c081e - Add manifest entries in BUCK file                                                                                        — David Pursehouse - (5 年前)</span><br><span class="line">* 3c9f593 - Handle non-fast-forward pushes                                                                                           — Arun Kumar - (5 年前)</span><br><span class="line">* a17c079 - Added backup branch creation for deleted refs                                                                            — Arun Kumar - (6 年前)</span><br><span class="line">* f5cf43e - Initial stub implementation                                                                                              — David Pursehouse - (6 年前)</span><br><span class="line">* df617dc - Initial empty commit                                                                                                     — David Pursehouse - (6 年前)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">从github克隆gerrit源代码。并且检出到 origin/stable-2.12 的分支上</span><br><span class="line">*   84f29ff - Merge branch &#x27;stable-2.11&#x27; into stable-2.12                                                                              — David Pursehouse (HEAD, origin/stable-2.12) - (12 个月前)</span><br><span class="line">|\  </span><br><span class="line">| *   a53bbb0 - Merge branch &#x27;stable-2.10&#x27; into stable-2.11                                                                              — David Pursehouse (origin/stable-2.11) - (12 个月前)</span><br><span class="line">| |\  </span><br><span class="line">| | *   ed2d5ce - Merge branch &#x27;stable-2.9&#x27; into stable-2.10                                                                               — David Pursehouse (origin/stable-2.10) - (12 个月前)</span><br><span class="line">| | |\  </span><br><span class="line">| | | * 5c6e69a - Consume JGit artifacts from Maven Central                                                                                — David Pursehouse (origin/stable-2.9) - (12 个月前)</span><br><span class="line">| | * | 51a1fa3 - Add release notes for Gerrit v2.10.8                                                                                     — Luca Milanesio - (12 个月前)</span><br><span class="line">| | * |   8943b0c - Merge branch &#x27;stable-2.9&#x27; into stable-2.10                                                                               — Luca Milanesio - (12 个月前)</span><br><span class="line">| | |\ \  </span><br><span class="line">| | | |/  </span><br><span class="line">| | | * decc35e - Add release notes for Gerrit v2.9.5                                                                                      — Luca Milanesio - (12 个月前)</span><br><span class="line">| | | * 2434df4 - Set version to 2.9.5                                                                                                     — Luca Milanesio (tag: v2.9.5) - (12 个月前)</span><br><span class="line">| | * | b5290de - Set version to 2.10.8                                                                                                    — Luca Milanesio (tag: v2.10.8) - (12 个月前)</span><br><span class="line">| * | | ec3ba0c - Set version to 2.11.12                                                                                                   — Luca Milanesio (tag: v2.11.12) - (12 个月前)</span><br><span class="line">* | | | 57ceed8 - Set version to 2.12.9                                                                                                    — Luca Milanesio (tag: v2.12.9) - (12 个月前)</span><br><span class="line">* | | |   08dd052 - Merge branch &#x27;stable-2.11&#x27; into stable-2.12                                                                              — Luca Milanesio - (12 个月前)</span><br><span class="line">|\ \ \ \  </span><br><span class="line">| |/ / /  </span><br><span class="line">| * | |   043b101 - Merge branch &#x27;stable-2.10&#x27; into stable-2.11                                                                              — Luca Milanesio - (12 个月前)</span><br><span class="line">| |\ \ \  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">编译gerrit 2.12.x版本需要用到buck工具</span><br><span class="line"></span><br><span class="line">在github上克隆https://github.com/facebook/buck.git用到buck工具</span><br><span class="line"></span><br><span class="line">通过gerrit代码中的.buckversion文件决定 buck 工具的版本，</span><br><span class="line">$ cat .buckversion </span><br><span class="line">1b03b4313b91b634bd604fc3487a05f877e59dee</span><br><span class="line"></span><br><span class="line">克隆完成buck工具，切换检出到 1b03b4313b91b634bd604fc3487a05f877e59dee 这个节点。</span><br><span class="line">* 1b03b43 - Add some support for running go tests.                                                                         </span><br><span class="line">* 1a6880e - Revert &quot;Add some support for running go tests.&quot;                                                                </span><br><span class="line">* 0b581a2 - C/C++: remove lex/yacc support                                                                                 </span><br><span class="line">* bd13811 - Add some support for running go tests.                                                                         </span><br><span class="line">* 8979c16 - Update to build-tools-23.0.2 in Travis                                                                         </span><br><span class="line">* 2c883f1 - Represent code sign identity fingerprint as Optional&lt;HashCode&gt;                                                 </span><br><span class="line">* f23f93e - Introduce paths-only target hash file mode                                                                     </span><br><span class="line">* 2e5ed11 - Default to BSER output from buck.py and remove JSON output parser                                              </span><br><span class="line">* c22418c - [halide] Build &quot;universal&quot; binaries for Halide libraries                                                       </span><br><span class="line">* d42cabf - Remove unexracted download artifacts                                                                           </span><br><span class="line">* f097b5e - Install the NDK to run those tests                                                                             </span><br><span class="line">* 47b9ee8 - Test Java 7 with CI as well                                                                                    </span><br><span class="line">* a7f980b - Remember Watchman warnings encountered during query so we can pass them to Watchman glob handler               </span><br><span class="line">* f1238db - Easy: Remove unused interface ProjectFilesystemWatcher</span><br><span class="line"></span><br><span class="line">编译buck工具，需要ant工具， 从网上下载ant工具就行，添加ant到环境变量 PATH</span><br><span class="line">然后到 buck 目录执行 ant 命令，编译出来 buck 工具。</span><br><span class="line"></span><br><span class="line">buck编译完成后在 $HOME/bin 目录下面 创建 buck 的软连接。</span><br><span class="line">$ ll ~/bin/buck</span><br><span class="line">lrwxrwxrwx 1 mamh mamh 29 11月 11  2018 /home/mamh/bin/buck -&gt; /work/buck/bin/buck*</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">编译 gerrit 和 插件 </span><br><span class="line"></span><br><span class="line">buck build release </span><br><span class="line"></span><br><span class="line">需要修改plugin/BUCK 文件</span><br><span class="line">BASE = get_base_path()</span><br><span class="line">CORE = [</span><br><span class="line">  &#x27;commit-message-length-validator&#x27;,</span><br><span class="line">  &#x27;download-commands&#x27;,</span><br><span class="line">  &#x27;replication&#x27;,</span><br><span class="line">  &#x27;reviewnotes&#x27;,</span><br><span class="line">  &#x27;singleusergroup&#x27;,</span><br><span class="line">  &#x27;ref-protection&#x27;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">插件生成位置： buck-out/gen/plugins/ref-protection/ref-protection.jar</span><br><span class="line"></span><br><span class="line">或者不修改 BUCK文件 而 值编译 这个插件本身</span><br><span class="line">buck build plugins/ref-protection</span><br></pre></td></tr></table></figure>

<p>报错的地方 plugins&#x2F;ref-protection&#x2F;src&#x2F;main&#x2F;java&#x2F;com&#x2F;googlesource&#x2F;gerrit&#x2F;plugins&#x2F;refprotection&#x2F;BackupRef.java</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#125; else &#123;</span><br><span class="line">    CreateBranch.Input input = new CreateBranch.Input();</span><br><span class="line">    input.ref = backupRef;</span><br><span class="line">    // We need to parse the commit to ensure if it&#x27;s a tag, we get the</span><br><span class="line">    // commit the tag points to!</span><br><span class="line">    input.revision = ObjectId.toString(revWalk.parseCommit(ObjectId.fromString(event.refUpdate.oldRev)).getId());</span><br><span class="line">    log.error(&quot;CreateBranch.Input: &quot; + String.format(&quot;%s-%s&quot;,input.ref, input.revision));</span><br><span class="line">    try &#123;</span><br><span class="line">        log.error(&quot;CreateBranch.Input: &quot;+ createBranchFactory);</span><br><span class="line">        log.error(&quot;project: &quot; +  project);</span><br><span class="line">        createBranchFactory.create(backupRef).apply(project, input);</span><br><span class="line">    &#125; catch (BadRequestException | AuthException | ResourceConflictException | IOException e) &#123;</span><br><span class="line">        log.error(e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过打印 RefControl 对象,我们发现两种操作() 时候的 RefControl 对象基本上没啥差异</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">RefControl&#123;</span><br><span class="line">projectControl=</span><br><span class="line">	ProjectControl&#123;</span><br><span class="line">		uploadGroups=</span><br><span class="line">		[global%3ARegistered-Users, global%3AAnonymous-Users], receiveGroups=[global%3ARegistered-Users]</span><br><span class="line">		, canonicalWebUrl=&#x27;http://gerrit.example.com:8080/&#x27;</span><br><span class="line">		, user=IdentifiedUser[account 1000000]</span><br><span class="line">		, state=com.google.gerrit.server.project.ProjectState@151533ed</span><br><span class="line">		, repoManager=com.google.gerrit.server.git.LocalDiskRepositoryManager@63fa17dc</span><br><span class="line">		, changeControlFactory=com.google.gerrit.server.project.ChangeControl$AssistedFactory</span><br><span class="line">		, permissionFilter=com.google.gerrit.server.project.PermissionCollection$Factory@2b652749</span><br><span class="line">		, contributorAgreements=[]</span><br><span class="line">		, tagCache=com.google.gerrit.server.git.TagCache@57e993dd</span><br><span class="line">		, changeCache=com.google.gerrit.server.git.SearchingChangeCacheImpl@6b5f5896</span><br><span class="line">		, allSections=[com.google.gerrit.server.project.SectionMatcher@4119ca1d, </span><br><span class="line">						com.google.gerrit.server.project.SectionMatcher@5093a140, </span><br><span class="line">						com.google.gerrit.server.project.SectionMatcher@4f92e3c2,</span><br><span class="line">						com.google.gerrit.server.project.SectionMatcher@3bfc8530, </span><br><span class="line">						com.google.gerrit.server.project.SectionMatcher@34bae970]</span><br><span class="line">		, localSections=null</span><br><span class="line">		, labelTypes=null</span><br><span class="line">		, declaredOwner=null</span><br><span class="line">	&#125;</span><br><span class="line">, refName=&#x27;refs/backups/heads/test5_for_20200109_181945&#x27;</span><br><span class="line">, relevant=PermissionCollection&#123;rules=&#123;read=[group Administrators, group Anonymous Users]&#125;, overridden=&#123;&#125;, ruleProps=&#123;group Administrators=ProjectRef&#123;project=All-Projects, ref=refs/*&#125;, group Anonymous Users=ProjectRef&#123;project=All-Projects, ref=refs/*&#125;&#125;, perUser=false&#125;</span><br><span class="line">, effective=&#123;&#125;</span><br><span class="line">, owner=null</span><br><span class="line">, canForgeAuthor=null</span><br><span class="line">, canForgeCommitter=null</span><br><span class="line">, isVisible=null</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RefControl&#123;</span><br><span class="line">projectControl=</span><br><span class="line">	ProjectControl&#123;</span><br><span class="line">	uploadGroups=[global%3ARegistered-Users, global%3AAnonymous-Users], receiveGroups=[global%3ARegistered-Users]</span><br><span class="line">		, canonicalWebUrl=&#x27;http://gerrit.example.com:8080/&#x27;</span><br><span class="line">		, user=IdentifiedUser[account 1000000]</span><br><span class="line">		, state=com.google.gerrit.server.project.ProjectState@151533ed</span><br><span class="line">		, repoManager=com.google.gerrit.server.git.LocalDiskRepositoryManager@63fa17dc</span><br><span class="line">		, changeControlFactory=com.google.gerrit.server.project.ChangeControl$AssistedFactory</span><br><span class="line">		, permissionFilter=com.google.gerrit.server.project.PermissionCollection$Factory@2b652749</span><br><span class="line">		, contributorAgreements=[]</span><br><span class="line">		, tagCache=com.google.gerrit.server.git.TagCache@57e993dd</span><br><span class="line">		, changeCache=com.google.gerrit.server.git.SearchingChangeCacheImpl@6b5f5896</span><br><span class="line">		, allSections=[com.google.gerrit.server.project.SectionMatcher@4119ca1d, </span><br><span class="line">					com.google.gerrit.server.project.SectionMatcher@5093a140,</span><br><span class="line">					com.google.gerrit.server.project.SectionMatcher@4f92e3c2,</span><br><span class="line">					com.google.gerrit.server.project.SectionMatcher@3bfc8530, </span><br><span class="line">					com.google.gerrit.server.project.SectionMatcher@34bae970]</span><br><span class="line">		, localSections=null</span><br><span class="line">		, labelTypes=null</span><br><span class="line">		, declaredOwner=null</span><br><span class="line">	&#125;</span><br><span class="line">, refName=&#x27;refs/backups/heads/test5_for_20200109_182142&#x27;</span><br><span class="line">, relevant=PermissionCollection&#123;rules=&#123;read=[group Administrators, group Anonymous Users]&#125;, overridden=&#123;&#125;, ruleProps=&#123;group Administrators=ProjectRef&#123;project=All-Projects, ref=refs/*&#125;, group ; Users=ProjectRef&#123;project=All-Projects, ref=refs/*&#125;&#125;, perUser=false&#125;</span><br><span class="line">, effective=&#123;&#125;</span><br><span class="line">, owner=null</span><br><span class="line">, canForgeAuthor=null</span><br><span class="line">, canForgeCommitter=null</span><br><span class="line">, isVisible=null</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面是在gerrit上操作删除分支的日志</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[2020-01-09 18:43:32,983] [HTTP-62] INFO  com.google.gerrit.server.project.CreateBranch : ===========================================</span><br><span class="line">[2020-01-09 18:43:32,985] [HTTP-62] INFO  com.google.gerrit.server.project.RefControl : ReviewDb = com.google.gerrit.reviewdb.server.ReviewDb_Schema_GwtOrm$$20@188ac92c</span><br><span class="line">[2020-01-09 18:43:32,985] [HTTP-62] INFO  com.google.gerrit.server.project.RefControl : RevWalk = org.eclipse.jgit.revwalk.ObjectWalk@41980182</span><br><span class="line">[2020-01-09 18:43:32,985] [HTTP-62] INFO  com.google.gerrit.server.project.RefControl : RevObject = commit 2f335d90bca227f7c8d115990081c5dcf6be5ac5 1573610871 -----p</span><br><span class="line">[2020-01-09 18:43:32,985] [HTTP-62] INFO  com.google.gerrit.server.project.RefControl : if (object instanceof RevCommit) &#123; start</span><br><span class="line">[2020-01-09 18:43:32,985] [HTTP-62] INFO  com.google.gerrit.server.project.RefControl : (admin || (owner &amp;&amp; !isBlocked(Permission.CREATE))) </span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>下面是 强制 push输出的日志</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[2020-01-09 18:44:32,117] [ReceiveCommits-2] INFO  com.google.gerrit.server.project.CreateBranch : ===========================================</span><br><span class="line">[2020-01-09 18:44:32,118] [ReceiveCommits-2] INFO  com.google.gerrit.server.project.RefControl : ReviewDb = com.google.gerrit.reviewdb.server.ReviewDb_Schema_GwtOrm$$20@7b303c26</span><br><span class="line">[2020-01-09 18:44:32,118] [ReceiveCommits-2] INFO  com.google.gerrit.server.project.RefControl : RevWalk = org.eclipse.jgit.revwalk.ObjectWalk@17c09ed9</span><br><span class="line">[2020-01-09 18:44:32,118] [ReceiveCommits-2] INFO  com.google.gerrit.server.project.RefControl : RevObject = commit 2f335d90bca227f7c8d115990081c5dcf6be5ac5 1573610871 -----p</span><br><span class="line">[2020-01-09 18:44:32,118] [ReceiveCommits-2] INFO  com.google.gerrit.server.project.RefControl : if (object instanceof RevCommit) &#123; start</span><br><span class="line">[2020-01-09 18:44:32,118] [ReceiveCommits-2] INFO  com.google.gerrit.server.project.RefControl : else if (!canPerform(Permission.CREATE)) </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>继续追踪代码</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">通过之前 push时候报错 我追踪到 这里 plugins/ref-protection/src/main/java/com/googlesource/gerrit/plugins/refprotection/BackupRef.java</span><br><span class="line">try &#123;</span><br><span class="line">    createBranchFactory.create(backupRef).apply(project, input);</span><br><span class="line">&#125; catch (BadRequestException | AuthException | ResourceConflictException | IOException e) &#123;</span><br><span class="line">    log.error(e.getMessage(), e);</span><br><span class="line">&#125;</span><br><span class="line">          </span><br><span class="line">继续追踪代码执行找到这个文件 gerrit-server/src/main/java/com/google/gerrit/server/project/CreateBranch.java 中的apply()方法处</span><br><span class="line">报错的地方 直接找到这个处</span><br><span class="line">rw.reset();</span><br><span class="line">if (!refControl.canCreate(db.get(), rw, object)) &#123;</span><br><span class="line">    throw new AuthException(&quot;Cannot create \&quot;&quot; + ref + &quot;\&quot;&quot;);</span><br><span class="line">&#125;</span><br><span class="line">到这里找到了 报错的地方, 也就是if判断过后 主动 抛出了一个异常,到这里的代码都不属于 插件的代码了.</span><br><span class="line">[2020-01-09 18:44:32,119] [ReceiveCommits-2] ERROR com.googlesource.gerrit.plugins.refprotection.BackupRef : Cannot create &quot;refs/backups/heads/test5_for_20200109_184432&quot;</span><br><span class="line">com.google.gerrit.extensions.restapi.AuthException: Cannot create &quot;refs/backups/heads/test5_for_20200109_184432&quot;</span><br><span class="line">	at com.google.gerrit.server.project.CreateBranch.apply(CreateBranch.java:144)</span><br><span class="line">	at com.googlesource.gerrit.plugins.refprotection.BackupRef.createBackup(BackupRef.java:166)</span><br><span class="line">	at com.googlesource.gerrit.plugins.refprotection.RefUpdateListener.onEvent(RefUpdateListener.java:103)</span><br><span class="line">	at com.google.gerrit.common.ChangeHookRunner.fireEventForUnrestrictedListeners(ChangeHookRunner.java:742)</span><br><span class="line">	at com.google.gerrit.common.ChangeHookRunner.fireEvent(ChangeHookRunner.java:789)</span><br><span class="line">	at com.google.gerrit.common.ChangeHookRunner.doRefUpdatedHook(ChangeHookRunner.java:610)</span><br><span class="line">	at com.google.gerrit.server.git.ReceiveCommits.processCommands(ReceiveCommits.java:662)</span><br><span class="line">	at com.google.gerrit.server.git.AsyncReceiveCommits$Worker.run(AsyncReceiveCommits.java:89)</span><br><span class="line">	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)</span><br><span class="line">	at com.google.gerrit.server.util.RequestScopePropagator$5.call(RequestScopePropagator.java:222)</span><br><span class="line">	at com.google.gerrit.server.util.RequestScopePropagator$4.call(RequestScopePropagator.java:201)</span><br><span class="line">	at com.google.gerrit.server.util.ThreadLocalRequestScopePropagator$1.call(ThreadLocalRequestScopePropagator.java:55)</span><br><span class="line">	at com.google.gerrit.server.util.RequestScopePropagator$1.call(RequestScopePropagator.java:98)</span><br><span class="line">	at com.google.gerrit.server.util.RequestScopePropagator$2.run(RequestScopePropagator.java:131)</span><br><span class="line">	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)</span><br><span class="line">	at java.util.concurrent.FutureTask.run(FutureTask.java:266)</span><br><span class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(ScheduledThreadPoolExecutor.java:180)</span><br><span class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:293)</span><br><span class="line">	at com.google.gerrit.server.git.WorkQueue$Task.run(WorkQueue.java:376)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:748)</span><br></pre></td></tr></table></figure>


<p>继续追踪代码</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">继续追踪代码 refControl.canCreate(db.get(), rw, object) 的执行</span><br><span class="line"></span><br><span class="line">继续定位,发现在 refControl.canCreate() 方法 中 两种操作() 有不同了. 一个返回了false,一个返回true.</span><br><span class="line"></span><br><span class="line">我们在  canCreate() 方法中 加上 日志输出 从而判断 return true/false 是 在哪里执行的return.</span><br><span class="line">if (object instanceof RevCommit) &#123;</span><br><span class="line">    log.info(&quot;if (object instanceof RevCommit) &#123; start&quot;);</span><br><span class="line">    if (admin || (owner &amp;&amp; !isBlocked(Permission.CREATE))) &#123;</span><br><span class="line">        // Admin or project owner; bypass visibility check.</span><br><span class="line">        log.info(&quot;(admin || (owner &amp;&amp; !isBlocked(Permission.CREATE))) &quot;); 下面是在gerrit上操作删除分支的日志</span><br><span class="line">        return true;</span><br><span class="line">    &#125; else if (!canPerform(Permission.CREATE)) &#123;     </span><br><span class="line">        log.info(&quot;else if (!canPerform(Permission.CREATE)) &quot;);   强制 push输出的日志</span><br><span class="line">        return false;</span><br><span class="line">    &#125; </span><br><span class="line">    </span><br><span class="line">到这里找到了</span><br><span class="line">一种情况走到了 if (admin || (owner &amp;&amp; !isBlocked(Permission.CREATE))) &#123; 判断,然后直接返回true了.</span><br><span class="line"></span><br><span class="line">另外一种情况走到了 &#125; else if (!canPerform(Permission.CREATE)) &#123; 判断,  然后直接返回 false 了.</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>下面就要分析 为什么两种操作 走的 不同的 if else 语句了</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">我们在  canCreate() 方法中 继续加上更多的  日志输出</span><br><span class="line"></span><br><span class="line">public boolean canCreate(ReviewDb db, RevWalk rw, RevObject object) &#123;</span><br><span class="line">    log.info(&quot;ReviewDb = &quot; + db);</span><br><span class="line">    log.info(&quot;RevWalk = &quot; + rw);</span><br><span class="line">    log.info(&quot;RevObject = &quot; + object);</span><br><span class="line"></span><br><span class="line">    log.info(&quot;getUser() = &quot; + getUser()); //IdentifiedUser[account 1000000]</span><br><span class="line">    log.info(&quot;getUser().getAccessPath() = &quot; + getUser().getAccessPath());</span><br><span class="line">    log.info(&quot;getUser().getCapabilities().canAdministrateServer() = &quot; + getUser().getCapabilities().canAdministrateServer());</span><br><span class="line"></span><br><span class="line">    if (!canWrite()) &#123;</span><br><span class="line">        log.info(&quot;canWrite = &quot; + canWrite());</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    boolean owner;</span><br><span class="line">    boolean admin;</span><br><span class="line">    switch (getUser().getAccessPath()) &#123;</span><br><span class="line">        case REST_API:</span><br><span class="line">        case JSON_RPC:</span><br><span class="line">        case UNKNOWN:</span><br><span class="line">            owner = isOwner();</span><br><span class="line">            admin = getUser().getCapabilities().canAdministrateServer();</span><br><span class="line">            break;</span><br><span class="line"></span><br><span class="line">        default:</span><br><span class="line">            owner = false;</span><br><span class="line">            admin = false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">下面是在gerrit上直接操作的输出日志</span><br><span class="line">[2020-01-09 19:55:35,726] [HTTP-64] INFO  com.google.gerrit.server.project.RefControl : ReviewDb = com.google.gerrit.reviewdb.server.ReviewDb_Schema_GwtOrm$$20@3ca80f6c</span><br><span class="line">[2020-01-09 19:55:35,726] [HTTP-64] INFO  com.google.gerrit.server.project.RefControl : RevWalk = org.eclipse.jgit.revwalk.ObjectWalk@7594c212</span><br><span class="line">[2020-01-09 19:55:35,726] [HTTP-64] INFO  com.google.gerrit.server.project.RefControl : RevObject = commit c620bcc00a0cefbfcb760ca4185dd0269b9bb409 1573610856 -----p</span><br><span class="line">[2020-01-09 19:55:35,726] [HTTP-64] INFO  com.google.gerrit.server.project.RefControl : getUser() = IdentifiedUser[account 1000000]</span><br><span class="line">[2020-01-09 19:55:35,726] [HTTP-64] INFO  com.google.gerrit.server.project.RefControl : getUser().getAccessPath() = REST_API</span><br><span class="line">[2020-01-09 19:55:35,726] [HTTP-64] INFO  com.google.gerrit.server.project.RefControl : getUser().getCapabilities().canAdministrateServer() = true</span><br><span class="line">[2020-01-09 19:55:35,726] [HTTP-64] INFO  com.google.gerrit.server.project.RefControl : if (object instanceof RevCommit) &#123; start</span><br><span class="line">[2020-01-09 19:55:35,726] [HTTP-64] INFO  com.google.gerrit.server.project.RefControl : (admin || (owner &amp;&amp; !isBlocked(Permission.CREATE))) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[2020-01-09 19:56:12,372] [HTTP-71] INFO  com.google.gerrit.server.project.RefControl : ReviewDb = com.google.gerrit.reviewdb.server.ReviewDb_Schema_GwtOrm$$20@739b8695</span><br><span class="line">[2020-01-09 19:56:12,372] [HTTP-71] INFO  com.google.gerrit.server.project.RefControl : RevWalk = org.eclipse.jgit.revwalk.ObjectWalk@98832ac</span><br><span class="line">[2020-01-09 19:56:12,372] [HTTP-71] INFO  com.google.gerrit.server.project.RefControl : RevObject = commit 5130c6f4d1dd84a9eae13eca14e627db50f843bd 1577691879 -----p</span><br><span class="line">[2020-01-09 19:56:12,372] [HTTP-71] INFO  com.google.gerrit.server.project.RefControl : getUser() = IdentifiedUser[account 1000000]</span><br><span class="line">[2020-01-09 19:56:12,372] [HTTP-71] INFO  com.google.gerrit.server.project.RefControl : getUser().getAccessPath() = REST_API</span><br><span class="line">[2020-01-09 19:56:12,372] [HTTP-71] INFO  com.google.gerrit.server.project.RefControl : getUser().getCapabilities().canAdministrateServer() = true</span><br><span class="line">[2020-01-09 19:56:12,372] [HTTP-71] INFO  com.google.gerrit.server.project.RefControl : if (object instanceof RevCommit) &#123; start</span><br><span class="line">[2020-01-09 19:56:12,372] [HTTP-71] INFO  com.google.gerrit.server.project.RefControl : (admin || (owner &amp;&amp; !isBlocked(Permission.CREATE))) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">下面是采用git push输出的日志</span><br><span class="line">[2020-01-09 19:56:44,187] [ReceiveCommits-1] INFO  com.google.gerrit.server.project.RefControl : ReviewDb = com.google.gerrit.reviewdb.server.ReviewDb_Schema_GwtOrm$$20@45bc3d47</span><br><span class="line">[2020-01-09 19:56:44,187] [ReceiveCommits-1] INFO  com.google.gerrit.server.project.RefControl : RevWalk = org.eclipse.jgit.revwalk.RevWalk@368252f1</span><br><span class="line">[2020-01-09 19:56:44,188] [ReceiveCommits-1] INFO  com.google.gerrit.server.project.RefControl : RevObject = commit c620bcc00a0cefbfcb760ca4185dd0269b9bb409 1573610856 -----p</span><br><span class="line">[2020-01-09 19:56:44,188] [ReceiveCommits-1] INFO  com.google.gerrit.server.project.RefControl : getUser() = IdentifiedUser[account 1000000]</span><br><span class="line">[2020-01-09 19:56:44,188] [ReceiveCommits-1] INFO  com.google.gerrit.server.project.RefControl : getUser().getAccessPath() = GIT</span><br><span class="line">[2020-01-09 19:56:44,188] [ReceiveCommits-1] INFO  com.google.gerrit.server.project.RefControl : getUser().getCapabilities().canAdministrateServer() = true</span><br><span class="line">[2020-01-09 19:56:44,188] [ReceiveCommits-1] INFO  com.google.gerrit.server.project.RefControl : if (object instanceof RevCommit) &#123; start</span><br><span class="line">[2020-01-09 19:56:44,188] [ReceiveCommits-1] INFO  com.google.gerrit.server.project.RefControl : else if (canUpdate())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[2020-01-09 19:57:36,970] [ReceiveCommits-2] INFO  com.google.gerrit.server.project.RefControl : ReviewDb = com.google.gerrit.reviewdb.server.ReviewDb_Schema_GwtOrm$$20@6d1c1e42</span><br><span class="line">[2020-01-09 19:57:36,970] [ReceiveCommits-2] INFO  com.google.gerrit.server.project.RefControl : RevWalk = org.eclipse.jgit.revwalk.ObjectWalk@281e8d85</span><br><span class="line">[2020-01-09 19:57:36,970] [ReceiveCommits-2] INFO  com.google.gerrit.server.project.RefControl : RevObject = commit 2f335d90bca227f7c8d115990081c5dcf6be5ac5 1573610871 -----p</span><br><span class="line">[2020-01-09 19:57:36,970] [ReceiveCommits-2] INFO  com.google.gerrit.server.project.RefControl : getUser() = IdentifiedUser[account 1000000]</span><br><span class="line">[2020-01-09 19:57:36,970] [ReceiveCommits-2] INFO  com.google.gerrit.server.project.RefControl : getUser().getAccessPath() = GIT</span><br><span class="line">[2020-01-09 19:57:36,970] [ReceiveCommits-2] INFO  com.google.gerrit.server.project.RefControl : getUser().getCapabilities().canAdministrateServer() = true</span><br><span class="line">[2020-01-09 19:57:36,970] [ReceiveCommits-2] INFO  com.google.gerrit.server.project.RefControl : if (object instanceof RevCommit) &#123; start</span><br><span class="line">[2020-01-09 19:57:36,970] [ReceiveCommits-2] INFO  com.google.gerrit.server.project.RefControl : else if (!canPerform(Permission.CREATE)) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">通过日志分析 我们发现 </span><br><span class="line"> getUser().getAccessPath() = GIT </span><br><span class="line"> getUser().getAccessPath() = REST_API</span><br><span class="line">这个2不一样了</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>继续加日志分析</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[2020-01-09 20:08:27,868] [HTTP-62] INFO  com.google.gerrit.server.project.RefControl : ReviewDb = com.google.gerrit.reviewdb.server.ReviewDb_Schema_GwtOrm$$20@42530bd7</span><br><span class="line">[2020-01-09 20:08:27,868] [HTTP-62] INFO  com.google.gerrit.server.project.RefControl : RevWalk = org.eclipse.jgit.revwalk.ObjectWalk@2a04d30b</span><br><span class="line">[2020-01-09 20:08:27,868] [HTTP-62] INFO  com.google.gerrit.server.project.RefControl : RevObject = commit c620bcc00a0cefbfcb760ca4185dd0269b9bb409 1573610856 -----p</span><br><span class="line">[2020-01-09 20:08:27,868] [HTTP-62] INFO  com.google.gerrit.server.project.RefControl : getUser() = IdentifiedUser[account 1000000]</span><br><span class="line">[2020-01-09 20:08:27,868] [HTTP-62] INFO  com.google.gerrit.server.project.RefControl : getUser().getAccessPath() = REST_API</span><br><span class="line">[2020-01-09 20:08:27,868] [HTTP-62] INFO  com.google.gerrit.server.project.RefControl : getUser().getCapabilities().canAdministrateServer() = true</span><br><span class="line">[2020-01-09 20:08:27,869] [HTTP-62] INFO  com.google.gerrit.server.project.RefControl : owner = true</span><br><span class="line">[2020-01-09 20:08:27,869] [HTTP-62] INFO  com.google.gerrit.server.project.RefControl : admin = true</span><br><span class="line">[2020-01-09 20:08:27,869] [HTTP-62] INFO  com.google.gerrit.server.project.RefControl : if (object instanceof RevCommit) &#123; start</span><br><span class="line">[2020-01-09 20:08:27,869] [HTTP-62] INFO  com.google.gerrit.server.project.RefControl : (admin || (owner &amp;&amp; !isBlocked(Permission.CREATE))) </span><br><span class="line"></span><br><span class="line">[2020-01-09 20:08:53,799] [HTTP-64] INFO  com.google.gerrit.server.project.RefControl : ReviewDb = com.google.gerrit.reviewdb.server.ReviewDb_Schema_GwtOrm$$20@2996426b</span><br><span class="line">[2020-01-09 20:08:53,799] [HTTP-64] INFO  com.google.gerrit.server.project.RefControl : RevWalk = org.eclipse.jgit.revwalk.ObjectWalk@68e4f072</span><br><span class="line">[2020-01-09 20:08:53,799] [HTTP-64] INFO  com.google.gerrit.server.project.RefControl : RevObject = commit c620bcc00a0cefbfcb760ca4185dd0269b9bb409 1573610856 -----p</span><br><span class="line">[2020-01-09 20:08:53,799] [HTTP-64] INFO  com.google.gerrit.server.project.RefControl : getUser() = IdentifiedUser[account 1000000]</span><br><span class="line">[2020-01-09 20:08:53,800] [HTTP-64] INFO  com.google.gerrit.server.project.RefControl : getUser().getAccessPath() = REST_API</span><br><span class="line">[2020-01-09 20:08:53,800] [HTTP-64] INFO  com.google.gerrit.server.project.RefControl : getUser().getCapabilities().canAdministrateServer() = true</span><br><span class="line">[2020-01-09 20:08:53,800] [HTTP-64] INFO  com.google.gerrit.server.project.RefControl : owner = true</span><br><span class="line">[2020-01-09 20:08:53,800] [HTTP-64] INFO  com.google.gerrit.server.project.RefControl : admin = true</span><br><span class="line">[2020-01-09 20:08:53,800] [HTTP-64] INFO  com.google.gerrit.server.project.RefControl : if (object instanceof RevCommit) &#123; start</span><br><span class="line">[2020-01-09 20:08:53,800] [HTTP-64] INFO  com.google.gerrit.server.project.RefControl : (admin || (owner &amp;&amp; !isBlocked(Permission.CREATE))) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[2020-01-09 20:09:29,898] [ReceiveCommits-1] INFO  com.google.gerrit.server.project.RefControl : ReviewDb = com.google.gerrit.reviewdb.server.ReviewDb_Schema_GwtOrm$$20@70fac7b8</span><br><span class="line">[2020-01-09 20:09:29,898] [ReceiveCommits-1] INFO  com.google.gerrit.server.project.RefControl : RevWalk = org.eclipse.jgit.revwalk.ObjectWalk@385a985b</span><br><span class="line">[2020-01-09 20:09:29,898] [ReceiveCommits-1] INFO  com.google.gerrit.server.project.RefControl : RevObject = commit 2f335d90bca227f7c8d115990081c5dcf6be5ac5 1573610871 -----p</span><br><span class="line">[2020-01-09 20:09:29,898] [ReceiveCommits-1] INFO  com.google.gerrit.server.project.RefControl : getUser() = IdentifiedUser[account 1000000]</span><br><span class="line">[2020-01-09 20:09:29,898] [ReceiveCommits-1] INFO  com.google.gerrit.server.project.RefControl : getUser().getAccessPath() = GIT</span><br><span class="line">[2020-01-09 20:09:29,899] [ReceiveCommits-1] INFO  com.google.gerrit.server.project.RefControl : getUser().getCapabilities().canAdministrateServer() = true</span><br><span class="line">[2020-01-09 20:09:29,899] [ReceiveCommits-1] INFO  com.google.gerrit.server.project.RefControl : default owner = false</span><br><span class="line">[2020-01-09 20:09:29,899] [ReceiveCommits-1] INFO  com.google.gerrit.server.project.RefControl : default admin = false</span><br><span class="line">[2020-01-09 20:09:29,899] [ReceiveCommits-1] INFO  com.google.gerrit.server.project.RefControl : if (object instanceof RevCommit) &#123; start</span><br><span class="line">[2020-01-09 20:09:29,899] [ReceiveCommits-1] INFO  com.google.gerrit.server.project.RefControl : else if (!canPerform(Permission.CREATE)) </span><br><span class="line"></span><br><span class="line">最终我们可以定位到这里 </span><br><span class="line">boolean owner;</span><br><span class="line">boolean admin;</span><br><span class="line">switch (getUser().getAccessPath()) &#123;</span><br><span class="line">    case REST_API:</span><br><span class="line">    case JSON_RPC:</span><br><span class="line">    case UNKNOWN:</span><br><span class="line">        owner = isOwner();</span><br><span class="line">        admin = getUser().getCapabilities().canAdministrateServer();</span><br><span class="line">        log.info(&quot;owner = &quot; + owner);</span><br><span class="line">        log.info(&quot;admin = &quot; + admin);</span><br><span class="line">        break;</span><br><span class="line"></span><br><span class="line">    default:</span><br><span class="line"></span><br><span class="line">        owner = false;</span><br><span class="line">        admin = false;</span><br><span class="line">        log.info(&quot;default owner = &quot; + owner);</span><br><span class="line">        log.info(&quot;default admin = &quot; + admin);</span><br><span class="line">&#125;</span><br><span class="line">这个switch没有判断 等于 GIT 的这种情况,而是直接走到了default,这样就会导致 owern和admin都是false了.</span><br><span class="line">也就会报没有权限创建refs/backups/*分支了.解决方法是 试着 在插件 那边 把 getUser().getAccessPath()</span><br><span class="line">的类型 改成 REST_API. 然后 最好能把 仅在push操作的时候 user 改成 admin 账号.一般的gerrit 管理员 会</span><br><span class="line">有 创建 refs/backups/* 的权限的.其中这里我一致觉得 这个插件 做的不合理. 既然是备份分支,不管谁来操作,</span><br><span class="line">你插件都应该给我备份上的.这个插件的安装也是在管理员情况下面才能安装的. 你备份分支还判断 有没有权限备份就太不合理了.</span><br></pre></td></tr></table></figure>
<p>最终我给出了一个修改放啊,可以参考<br><a target="_blank" rel="noopener" href="https://github.com/mamh-java/plugins_ref-protection/tree/mamh-2.12.7">https://github.com/mamh-java/plugins_ref-protection/tree/mamh-2.12.7</a></p>
<p>下面是 修改后 几种操作的日志输出</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">git push fast forward的操作</span><br><span class="line">[2020-01-10 17:39:35,744] [ReceiveCommits-1] not isRefDeleted or not NonFastForward: project [git/shared/tools/blog] refname [refs/heads/master1] oldRev [17b185ee7ee879242f38f8200c9855f530c5329b] newRev [bc071c0e21cad2a09c998af15b7b6ea90e5908a8]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">git push  non fast forward的操作</span><br><span class="line">[2020-01-10 17:40:01,026] [ReceiveCommits-1] this user want to delete ref or no fast forward update ref: IdentifiedUser[account 1000003]</span><br><span class="line">[2020-01-10 17:40:01,026] [ReceiveCommits-1] Ref Deleted: project [git/shared/tools/blog] refname [refs/heads/master1] oldRev [bc071c0e21cad2a09c998af15b7b6ea90e5908a8] newRev [17b185ee7ee879242f38f8200c9855f530c5329b]</span><br><span class="line">[2020-01-10 17:40:01,027] [ReceiveCommits-1] Ref  Backup: project [git/shared/tools/blog] refname [refs/heads/backup/master1_20200110_174001] oldRev [bc071c0e21cad2a09c998af15b7b6ea90e5908a8] newRev [17b185ee7ee879242f38f8200c9855f530c5329b]</span><br><span class="line">[2020-01-10 17:40:01,045] [ReceiveCommits-1] not a relevant ref: project [git/shared/tools/blog] refname [refs/heads/backup/master1_20200110_174001] oldRev [0000000000000000000000000000000000000000] newRev [bc071c0e21cad2a09c998af15b7b6ea90e5908a8]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">git push 删除分支的操作</span><br><span class="line">[2020-01-10 17:40:39,882] [ReceiveCommits-2] this user want to delete ref or no fast forward update ref: IdentifiedUser[account 1000003]</span><br><span class="line">[2020-01-10 17:40:39,882] [ReceiveCommits-2] Ref Deleted: project [git/shared/tools/blog] refname [refs/heads/master1] oldRev [17b185ee7ee879242f38f8200c9855f530c5329b] newRev [0000000000000000000000000000000000000000]</span><br><span class="line">[2020-01-10 17:40:39,883] [ReceiveCommits-2] Ref  Backup: project [git/shared/tools/blog] refname [refs/heads/backup/master1_20200110_174039] oldRev [17b185ee7ee879242f38f8200c9855f530c5329b] newRev [0000000000000000000000000000000000000000]</span><br><span class="line">[2020-01-10 17:40:39,890] [ReceiveCommits-2] not a relevant ref: project [git/shared/tools/blog] refname [refs/heads/backup/master1_20200110_174039] oldRev [0000000000000000000000000000000000000000] newRev [17b185ee7ee879242f38f8200c9855f530c5329b]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">gerrit网页上创建分支输入的日志</span><br><span class="line">[2020-01-10 17:42:24,059] [HTTP-65] not a relevant ref: project [git/shared/tools/blog] refname [refs/heads/sm8250_mp_zero] oldRev [0000000000000000000000000000000000000000] newRev [4fef20ecde1f67b20de9a4434bdbca568ffcb763]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">gerrit网页上删除分支的日志</span><br><span class="line">[2020-01-10 17:42:44,435] [HTTP-63] this user want to delete ref or no fast forward update ref: IdentifiedUser[account 1000000]</span><br><span class="line">[2020-01-10 17:42:44,435] [HTTP-63] Ref Deleted: project [git/shared/tools/blog] refname [refs/heads/sm8250_mp_zero_20200110] oldRev [4fef20ecde1f67b20de9a4434bdbca568ffcb763] newRev [0000000000000000000000000000000000000000]</span><br><span class="line">[2020-01-10 17:42:44,435] [HTTP-63] Ref  Backup: project [git/shared/tools/blog] refname [refs/heads/backup/sm8250_mp_zero_20200110_20200110_174244] oldRev [4fef20ecde1f67b20de9a4434bdbca568ffcb763] newRev [0000000000000000000000000000000000000000]</span><br><span class="line">[2020-01-10 17:42:44,443] [HTTP-63] not a relevant ref: project [git/shared/tools/blog] refname [refs/heads/backup/sm8250_mp_zero_20200110_20200110_174244] oldRev [0000000000000000000000000000000000000000] newRev [4fef20ecde1f67b20de9a4434bdbca568ffcb763]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>





















</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://magesfc.github.io">mage</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://magesfc.github.io/mage/fdbb4b38b92cf47b0e24bc59c392393921287a2c/">https://magesfc.github.io/mage/fdbb4b38b92cf47b0e24bc59c392393921287a2c/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://magesfc.github.io" target="_blank">马哥私房菜</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/android/">android</a><a class="post-meta__tags" href="/tags/gerrit/">gerrit</a><a class="post-meta__tags" href="/tags/ref/">ref</a><a class="post-meta__tags" href="/tags/protection/">protection</a></div><div class="post_share"><div class="social-share" data-image="https://t.mwm.moe/fj/" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/null" target="_blank"><img class="post-qr-code-img" src= "/img/loading.gif" data-lazy-src="/null" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/null" target="_blank"><img class="post-qr-code-img" src= "/img/loading.gif" data-lazy-src="/null" alt="支付寶"/></a><div class="post-qr-code-desc">支付寶</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/mage/45fd28bfb59ce78db2a647f34a31e83ae9bb24e1/"><img class="prev-cover" src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Android下的配置管理之道之gerrit代码服务器搭建</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/mage/9f11362bb48e38171ec1992629522ab39976a878/" title="Android下的配置管理之道之gerrit代码服务器之ssh队列详解"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-23</div><div class="title">Android下的配置管理之道之gerrit代码服务器之ssh队列详解</div></div></a></div><div><a href="/mage/8ac00d53eb291c161df9a3d30ccaca66be48f13c/" title="Android下的配置管理之道之gerrit修改project路径"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-23</div><div class="title">Android下的配置管理之道之gerrit修改project路径</div></div></a></div><div><a href="/mage/e2cc5e300708461bde262aaae49a064be28321d2/" title="Android下的配置管理之道之gerrit权限管理"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-23</div><div class="title">Android下的配置管理之道之gerrit权限管理</div></div></a></div><div><a href="/mage/b1cf003423f7ac158b861abd5a96522cbd2fae86/" title="Android下的配置管理之道之gerrit的ssh命令行工具"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-23</div><div class="title">Android下的配置管理之道之gerrit的ssh命令行工具</div></div></a></div><div><a href="/mage/4ffe00a009758049d18e75751a7dcc4ee3a21ef9/" title="Android下的配置管理之道之gerrit安装github插件"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-23</div><div class="title">Android下的配置管理之道之gerrit安装github插件</div></div></a></div><div><a href="/mage/037b07ff16870d51848a2e4b1a21052b80988d7d/" title="Android下的配置管理之道之安装gerrit代码服务器"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-23</div><div class="title">Android下的配置管理之道之安装gerrit代码服务器</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "/img/loading.gif" data-lazy-src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">mage</div><div class="author-info__description"> 这里是 马哥 的个人博客 </div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">219</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">230</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">40</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mamh2021"><i class="fab fa-github"></i><span>GitHub</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/mamh2021" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%80%E8%BF%91%E7%A0%94%E7%A9%B6%E4%BA%86%E4%B8%80%E4%B8%AAgerrit%E8%87%AA%E5%8A%A8%E5%A4%87%E4%BB%BD%E5%88%86%E6%94%AF%E7%9A%84%E6%8F%92%E4%BB%B6%E3%80%82"><span class="toc-number">1.</span> <span class="toc-text">最近研究了一个gerrit自动备份分支的插件。</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/mage/2a9ef50014df49410b7232170f2a33410e557f9e/" title="Android下的配置管理之道repo支持多线程去checkout的"><img src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android下的配置管理之道repo支持多线程去checkout的"/></a><div class="content"><a class="title" href="/mage/2a9ef50014df49410b7232170f2a33410e557f9e/" title="Android下的配置管理之道repo支持多线程去checkout的">Android下的配置管理之道repo支持多线程去checkout的</a><time datetime="2023-10-03T14:27:48.000Z" title="更新于 2023-10-03 22:27:48">2023-10-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/mage/57c6d6d47f27965a3b16751908caacdc6eea440c/" title="Android下的配置管理之道之自动abandon很久之前的处于open的patch"><img src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android下的配置管理之道之自动abandon很久之前的处于open的patch"/></a><div class="content"><a class="title" href="/mage/57c6d6d47f27965a3b16751908caacdc6eea440c/" title="Android下的配置管理之道之自动abandon很久之前的处于open的patch">Android下的配置管理之道之自动abandon很久之前的处于open的patch</a><time datetime="2023-10-03T14:26:24.000Z" title="更新于 2023-10-03 22:26:24">2023-10-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/mage/e405c9d59f8b11b211eff5302fecd36de161171e/" title="Android下的配置管理之道之Android编译环境搭建"><img src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android下的配置管理之道之Android编译环境搭建"/></a><div class="content"><a class="title" href="/mage/e405c9d59f8b11b211eff5302fecd36de161171e/" title="Android下的配置管理之道之Android编译环境搭建">Android下的配置管理之道之Android编译环境搭建</a><time datetime="2023-10-03T14:25:36.000Z" title="更新于 2023-10-03 22:25:36">2023-10-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/mage/f9af26d5f35c7f0b5996dd16b21cfaf6b5bbed6b/" title="Android下的配置管理之道高通kernel的构建为什么有2个-j 参数"><img src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android下的配置管理之道高通kernel的构建为什么有2个-j 参数"/></a><div class="content"><a class="title" href="/mage/f9af26d5f35c7f0b5996dd16b21cfaf6b5bbed6b/" title="Android下的配置管理之道高通kernel的构建为什么有2个-j 参数">Android下的配置管理之道高通kernel的构建为什么有2个-j 参数</a><time datetime="2023-10-03T14:14:57.000Z" title="更新于 2023-10-03 22:14:57">2023-10-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/mage/c1853b7677473f4bdbbbae48ee66216a0f4bc493/" title="Android下的配置管理之道关于AndroidBoard.mk和AndroidProducts.mk"><img src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android下的配置管理之道关于AndroidBoard.mk和AndroidProducts.mk"/></a><div class="content"><a class="title" href="/mage/c1853b7677473f4bdbbbae48ee66216a0f4bc493/" title="Android下的配置管理之道关于AndroidBoard.mk和AndroidProducts.mk">Android下的配置管理之道关于AndroidBoard.mk和AndroidProducts.mk</a><time datetime="2023-10-03T13:56:35.000Z" title="更新于 2023-10-03 21:56:35">2023-10-03</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://t.mwm.moe/fj/')"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By mage</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="true" data-click="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>