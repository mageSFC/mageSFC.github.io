<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Golangå­¦ä¹ ä¹‹mtail | é©¬å“¥ç§æˆ¿èœ</title><meta name="author" content="mage"><meta name="copyright" content="mage"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="mtail  å­¦ä¹ mtail ä»‹ç»extract internal monitoring data from application logs for collection in a timeseries database mtail :ä»åº”ç”¨ç¨‹åºæ—¥å¿—ä¸­æå–æŒ‡æ ‡ä»¥å¯¼å‡ºåˆ°æ—¶é—´åºåˆ—æ•°æ®åº“  å®ƒæ˜¯ä¸€ä¸ªgoogleå¼€å‘çš„æ—¥å¿—æå–å·¥å…·ï¼Œç”¨é€”å°±æ˜¯:  å®æ—¶è¯»å–åº”ç”¨ç¨‹åºçš„æ—¥å¿—ã€ å†é€šè¿‡è‡ªå·±ç¼–å†™çš„è„šæœ¬è¿›è¡Œåˆ†æã€">
<meta property="og:type" content="article">
<meta property="og:title" content="Golangå­¦ä¹ ä¹‹mtail">
<meta property="og:url" content="https://magesfc.github.io/mage/3b62171753fddbbf78c36e3f6d7c9ba008365560/">
<meta property="og:site_name" content="é©¬å“¥ç§æˆ¿èœ">
<meta property="og:description" content="mtail  å­¦ä¹ mtail ä»‹ç»extract internal monitoring data from application logs for collection in a timeseries database mtail :ä»åº”ç”¨ç¨‹åºæ—¥å¿—ä¸­æå–æŒ‡æ ‡ä»¥å¯¼å‡ºåˆ°æ—¶é—´åºåˆ—æ•°æ®åº“  å®ƒæ˜¯ä¸€ä¸ªgoogleå¼€å‘çš„æ—¥å¿—æå–å·¥å…·ï¼Œç”¨é€”å°±æ˜¯:  å®æ—¶è¯»å–åº”ç”¨ç¨‹åºçš„æ—¥å¿—ã€ å†é€šè¿‡è‡ªå·±ç¼–å†™çš„è„šæœ¬è¿›è¡Œåˆ†æã€">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg">
<meta property="article:published_time" content="2022-11-08T07:53:13.000Z">
<meta property="article:modified_time" content="2022-11-11T02:54:18.000Z">
<meta property="article:author" content="mage">
<meta property="article:tag" content="golang">
<meta property="article:tag" content="mtail">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg"><link rel="shortcut icon" href="http://www.blackshark.com/favicon.ico"><link rel="canonical" href="https://magesfc.github.io/mage/3b62171753fddbbf78c36e3f6d7c9ba008365560/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'å¤©',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: {"limitCount":150,"languages":{"author":"ä½œè€…: mage","link":"é“¾æ¥: ","source":"æ¥æº: é©¬å“¥ç§æˆ¿èœ","info":"è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Golangå­¦ä¹ ä¹‹mtail',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-11-11 10:54:18'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><style type="text/css">.card-announcement .social-button{margin:.6rem 0 0 0;text-align:center}.card-announcement .social-button a{display:block;background-color:var(--btn-bg);color:var(--btn-color);text-align:center;line-height:2.4;margin:4px 0}.card-announcement .social-button a:hover{background-color:var(--btn-hover-color)}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "/img/loading.gif" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">169</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">187</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">34</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-compass"></i><span> ç›®å½•</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> å½’æ¡£</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> ç²¾é€‰æ–‡æ¡£</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/21cfbf15/"><span> ğŸš€ å¿«é€Ÿå¼€å§‹</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/dc584b87/"><span> ğŸ“‘ ä¸»é¢˜é¡µé¢</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/4aa8abbe/"><span> ğŸ›  ä¸»é¢˜é…ç½®-1</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/ceeb73f/"><span> ğŸ›  ä¸»é¢˜é…ç½®-2</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/98d20436/"><span> â“ ä¸»é¢˜é—®ç­”</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/4073eda/"><span> âš¡ï¸ è¿›é˜¶æ•™ç¨‹</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/198a4240/"><span> âœ¨ æ›´æ–°æ—¥å¿—</span></a></li></ul></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://butterfly.js.org/link/"><i class="fa-fw fas fa-thumbs-up"></i><span> å…¶ä»–ç¤ºä¾‹</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">é©¬å“¥ç§æˆ¿èœ</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-compass"></i><span> ç›®å½•</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> å½’æ¡£</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> ç²¾é€‰æ–‡æ¡£</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/21cfbf15/"><span> ğŸš€ å¿«é€Ÿå¼€å§‹</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/dc584b87/"><span> ğŸ“‘ ä¸»é¢˜é¡µé¢</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/4aa8abbe/"><span> ğŸ›  ä¸»é¢˜é…ç½®-1</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/ceeb73f/"><span> ğŸ›  ä¸»é¢˜é…ç½®-2</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/98d20436/"><span> â“ ä¸»é¢˜é—®ç­”</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/4073eda/"><span> âš¡ï¸ è¿›é˜¶æ•™ç¨‹</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/198a4240/"><span> âœ¨ æ›´æ–°æ—¥å¿—</span></a></li></ul></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://butterfly.js.org/link/"><i class="fa-fw fas fa-thumbs-up"></i><span> å…¶ä»–ç¤ºä¾‹</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Golangå­¦ä¹ ä¹‹mtail</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2022-11-08T07:53:13.000Z" title="å‘è¡¨äº 2022-11-08 15:53:13">2022-11-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2022-11-11T02:54:18.000Z" title="æ›´æ–°äº 2022-11-11 10:54:18">2022-11-11</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/golang/">golang</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Golangå­¦ä¹ ä¹‹mtail"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="mtail-å­¦ä¹ "><a href="#mtail-å­¦ä¹ " class="headerlink" title="mtail  å­¦ä¹ "></a>mtail  å­¦ä¹ </h1><h1 id="mtail-ä»‹ç»"><a href="#mtail-ä»‹ç»" class="headerlink" title="mtail ä»‹ç»"></a>mtail ä»‹ç»</h1><p>extract internal monitoring data from application logs for collection in a timeseries database</p>
<pre><code>mtail :ä»åº”ç”¨ç¨‹åºæ—¥å¿—ä¸­æå–æŒ‡æ ‡ä»¥å¯¼å‡ºåˆ°æ—¶é—´åºåˆ—æ•°æ®åº“
</code></pre>
<p>å®ƒæ˜¯ä¸€ä¸ªgoogleå¼€å‘çš„æ—¥å¿—æå–å·¥å…·ï¼Œç”¨é€”å°±æ˜¯:</p>
<ol>
<li>å®æ—¶è¯»å–åº”ç”¨ç¨‹åºçš„æ—¥å¿—ã€</li>
<li>å†é€šè¿‡è‡ªå·±ç¼–å†™çš„è„šæœ¬è¿›è¡Œåˆ†æã€</li>
<li>æœ€ç»ˆç”Ÿæˆæ—¶é—´åºåˆ—æŒ‡æ ‡</li>
</ol>
<p>mtailä½¿ç”¨æµå¼è¯»å–æ—¥å¿—ï¼Œé€šè¿‡æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…çš„æ–¹å¼ä»æ—¥å¿—ä¸­æå–metricsæŒ‡æ ‡ï¼Œ</p>
<p>è¿™ç§æ–¹å¼å¯ä»¥åˆ©ç”¨ç›®æ ‡æœºå™¨çš„ç®—åŠ›ï¼Œä¸è¿‡å¦‚æœé‡å¤ªå¤§ï¼Œå¯èƒ½ä¼šå½±å“ç›®æ ‡æœºå™¨ä¸Šçš„ä¸šåŠ¡ç¨‹åº</p>
<h1 id="è¿è¡Œ-mtail"><a href="#è¿è¡Œ-mtail" class="headerlink" title="è¿è¡Œ mtail"></a>è¿è¡Œ mtail</h1><pre><code>-progs string
    Name of the directory containing mtail programs

é€šè¿‡ --progs å‚æ•°æŒ‡å®šä¸€ä¸ªç›®å½•ï¼Œè¿™ä¸ªç›®å½•é‡Œæ”¾ç½®ä¸€å †çš„*.mtailæ–‡ä»¶ï¼Œ

-logs value
    List of log files to monitor, separated by commas.  This flag may be specified multiple times.

æ¯ä¸ªmtailæ–‡ä»¶å°±æ˜¯æè¿°çš„æ­£åˆ™æå–è§„åˆ™ï¼Œé€šè¿‡ --logs å‚æ•°æ¥æŒ‡å®šè¦ç›‘æ§çš„æ—¥å¿—ç›®å½•ï¼Œ
å¯ä»¥å†™é€šé…ç¬¦ï¼Œ--logs å¯ä»¥å†™å¤šæ¬¡

-one_shot
    Compile the programs, then read the contents of the provided logs from start until EOF, print the values of the metrics store in the given format and exit. This is a debugging flag only, not for production use.
-one_shot_format string
    Format to use with -one_shot. This is a debugging flag only, not for production use. Supported formats: json, prometheus. (default &quot;json&quot;)

-one_shot åªæ˜¾ç¤ºæ‰“å°å‡ºæ¥ä¸€æ¬¡æŒ‡æ ‡æ•°æ®ï¼Œæµ‹è¯•çš„æ—¶å€™éå¸¸æœ‰ç”¨ã€‚-one_shot_format ç”¨æ¥æŒ‡å®šæ‰“å°å‡ºæ¥çš„æ•°æ®çš„æ ¼å¼ï¼Œé»˜è®¤æ˜¯json æ ¼å¼ã€‚ å¯ä»¥æŒ‡å®šä¸ºprometheusæ ¼å¼çš„ã€‚
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ /tmp/___mtail -progs ./conf/input.mtail -logs /var/log/kern.log -one_shot -one_shot_format prometheus  -logtostderr</span><br><span class="line"></span><br><span class="line">I1108 11:01:06.610898   20788 main.go:119] mtail version invalid:-use-make-to-build git revision invalid:-use-make-to-build go version go1.18.6 go arch amd64 go os linux</span><br><span class="line">I1108 11:01:06.610923   20788 main.go:120] Commandline: [&quot;/tmp/___mtail&quot; &quot;-progs&quot; &quot;/home/mamh/work/github/flashcatcloud-categraf/conf/input.mtail&quot; &quot;-logs&quot; &quot;/var/log/kern.log.1&quot; &quot;-one_shot&quot; &quot;-one_shot_format&quot; &quot;prometheus&quot; &quot;-logtostderr&quot;]</span><br><span class="line">I1108 11:01:06.611064   20788 store.go:189] Starting metric store expiry loop every 1h0m0s</span><br><span class="line">I1108 11:01:06.611209   20788 runtime.go:84] unmarking mtail.toml</span><br><span class="line">I1108 11:01:06.611229   20788 logstream.go:61] Parsed url as /var/log/kern.log.1</span><br><span class="line">I1108 11:01:06.611295   20788 filestream.go:278] signalling stop at next EOF</span><br><span class="line">I1108 11:01:06.611312   20788 tail.go:287] Tailing /var/log/kern.log.1</span><br><span class="line">I1108 11:01:06.611388   20788 tail.go:343] No polling loop in oneshot mode.</span><br><span class="line">I1108 11:01:06.611388   20788 tail.go:315] No gc loop in oneshot mode.</span><br><span class="line">I1108 11:01:06.611414   20788 mtail.go:132] Listening on [::]:3903</span><br><span class="line">I1108 11:01:06.621508   20788 runtime.go:288] END OF LINE</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å»æ‰ -one_shot æ‰§è¡Œ å°±ä¼šé˜»å¡åˆ°é‚£é‡Œäº†ï¼Œç„¶åå°±å¯ä»¥æµè§ˆå™¨ è®¿é—® 3903 ç«¯å£ è¿™ä¸ª åœ°å€å•¦ã€‚</p>
<h1 id="mtail-å‘½ä»¤-æºç åˆ†æ"><a href="#mtail-å‘½ä»¤-æºç åˆ†æ" class="headerlink" title="mtail å‘½ä»¤ æºç åˆ†æ"></a>mtail å‘½ä»¤ æºç åˆ†æ</h1><p>å‰æèƒŒæ™¯ï¼š </p>
<pre><code>0. ä¸ºä»€ä¹ˆè¦çœ‹è¿™ä¸ªmtailæºç å‘¢ï¼Ÿ æœ€å¼€å§‹æ˜¯ categraf ç›‘æ§é‡Œé¢åŠ å…¥äº†è¿™ä¸ª mtailæ’ä»¶ï¼Œç„¶å
æˆ‘è¯•ç€æ‰§è¡Œäº†ä¸€ä¸‹ ä½†æ˜¯æ²¡æœ‰æ‰§è¡Œå‡ºæ¥æƒ³è¦çš„ç»“æœï¼Œä¹Ÿå°±æ˜¯ ç”¨ mtail æ–‡ä»¶ åŠ ä¸Šä¸€ä¸ª æ—¥å¿—æ–‡ä»¶ å»æ‰§è¡Œæ²¡æœ‰å‡ºæ¥
æƒ³è¦çš„ç»“æœã€‚ ä½†æ˜¯å‘¢ æˆ‘ç›´æ¥åŒæ ·çš„æ–‡ä»¶ ç”¨ mtail å‘½ä»¤ å°±èƒ½å¾—å‡ºæƒ³è¦çš„ç»“æœäº†ã€‚ æ‰€ä»¥æƒ³åˆ†æåˆ†æ mtail é‡Œé¢
çš„æºç éƒ½æ˜¯ä¸€æ­¥ä¸€æ­¥æ€ä¹ˆæ‰§è¡Œçš„ã€‚
</code></pre>
<p>é€šè¿‡æºç åˆ†æ æˆ‘ä»¬æƒ³æ¢è®¨çš„å‡ ä¸ªé—®é¢˜ï¼š</p>
<pre><code>1. åœ¨å“ªé‡Œ è¯»å– æ—¥å¿—æ–‡ä»¶çš„ï¼Ÿï¼Ÿï¼Ÿ  è¿™ä¸ªç­”æ¡ˆå·²ç»å‡ºæ¥äº†ã€‚ å‚è€ƒ ä¸‹é¢  Runtime  New æ–¹æ³• ç›¸å…³çš„ åˆ†æã€‚
2. åœ¨å“ªé‡Œ ä½¿ç”¨ mtail æ–‡ä»¶çš„ ï¼Ÿï¼Ÿï¼Ÿ è¿™ä¸ªçŸ¥é“ æ˜¯åœ¨  Runtime  New æ–¹æ³• é‡Œé¢å»åŠ è½½äº†ï¼Œ åŒæ—¶ è¿™ä¸ªé‡Œé¢ä¹Ÿ
                                 åŠ è½½ æ—¥å¿—æ–‡ä»¶å†…å®¹ã€‚é‚£ä¹ˆ è¿™2ä¸ªç»“åˆå»å¤„ç† ä¼°è®¡ä¹Ÿæ˜¯åœ¨è¿™ä¸ª Runtime é‡Œé¢äº†
</code></pre>
<h2 id="mtail-New-åˆå§‹åŒ–"><a href="#mtail-New-åˆå§‹åŒ–" class="headerlink" title="mtail.New åˆå§‹åŒ–"></a>mtail.New åˆå§‹åŒ–</h2><p>é¦–å…ˆ æ˜¯ æ ¹æ® å‘½ä»¤è¡Œçš„ä¸€äº›å‚æ•° å» åˆå§‹ mtail äº†ã€‚</p>
<p>åœ¨ main.go ä¸­ æœ‰ mtail.New() æ–¹æ³•è°ƒç”¨</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mtail.New(ctx, store, opts...)</span><br></pre></td></tr></table></figure>

<p>éœ€è¦ç”¨åˆ° 3ä¸ª å‚æ•°</p>
<pre><code>ctx æ˜¯ context.WithCancel(context.Background()) 
store æ˜¯ metrics.NewStore() ç”Ÿæˆå‡ºæ¥çš„
opts å°±æ˜¯å¯¹åº”å‘½ä»¤è¡Œä¸Šçš„ é€‰é¡¹äº†ï¼ŒæŠŠå‘½ä»¤è¡Œé€‰é¡¹ è½¬æ¢äº†ä¸€ä¸‹ï¼Œmtail.Optionåˆ‡ç‰‡äº†ã€‚
</code></pre>
<p>ä¸»è¦å°±æ˜¯ åˆå§‹åŒ– type Server struct  è¿™ä¸ª</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">m := &amp;Server&#123;</span><br><span class="line">    ctx:   ctx,</span><br><span class="line">    store: store,</span><br><span class="line"></span><br><span class="line">    lines: make(chan *logline.LogLine),</span><br><span class="line"></span><br><span class="line">    reg: prometheus.NewRegistry(),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ New() æ–¹æ³•åç»­çš„ è¿˜è°ƒç”¨äº† å…¶ä»–çš„ ä¸€äº›ä¸ª åˆå§‹åŒ– æ–¹æ³•</p>
<pre><code>if err := m.initExporter(); err != nil &#123;

if err := m.initRuntime(); err != nil &#123;

if err := m.initTailer(); err != nil &#123;

if err := m.initHTTPServer(); err != nil &#123;
</code></pre>
<p>ä»¥ä¸Š å››ä¸ª init æ–¹æ³• é‡Œé¢ åˆå„è‡ª åˆå§‹åŒ–äº† å…¶ä»–ç±»å‹çš„ ç»“æ„ä½“äº†ã€‚ ä¸»è¦æœ‰ä¸‹é¢å‡ ä¸ªã€‚</p>
<pre><code>type Exporter struct

type Runtime struct // è¿™é‡Œé¢æœ‰ compiler.New() åˆå§‹åŒ–

type Tailer struct

type Server struct   net http åŒ…ä¸‹é¢çš„ï¼Œ ç›´æ¥æä¾› http æœåŠ¡çš„ã€‚
</code></pre>
<p>å½“ç„¶ è¿™äº› ç»“æ„ä½“ åœ¨ è°ƒç”¨ New() æ–¹æ³•çš„é‡Œé¢ ä¹Ÿä¼šæœ‰ å¦å¤–çš„  ç»“æ„ä½“çš„ åˆå§‹åŒ–ã€‚</p>
<h2 id="Runtime-New-æ–¹æ³•ã€‚"><a href="#Runtime-New-æ–¹æ³•ã€‚" class="headerlink" title="Runtime  New æ–¹æ³•ã€‚"></a>Runtime  New æ–¹æ³•ã€‚</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// initRuntime constructs a new runtime and performs the initial load of program files in the program directory.</span><br><span class="line">func (m *Server) initRuntime() (err error) &#123;</span><br><span class="line">	m.r, err = runtime.New(m.lines, &amp;m.wg, m.programPath, m.store, m.rOpts...)</span><br><span class="line">	return</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">func New(lines &lt;-chan *logline.LogLine, wg *sync.WaitGroup, programPath string, store *metrics.Store, options ...Option) (*Runtime, error) &#123;</span><br><span class="line">	if store == nil &#123;</span><br><span class="line">		return nil, errors.New(&quot;loader needs a store&quot;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	r := &amp;Runtime&#123;</span><br><span class="line">		ms:            store,</span><br><span class="line">		programPath:   programPath,</span><br><span class="line">		handles:       make(map[string]*vmHandle),</span><br><span class="line">		programErrors: make(map[string]error),</span><br><span class="line">		signalQuit:    make(chan struct&#123;&#125;),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	initDone := make(chan struct&#123;&#125;)</span><br><span class="line">	defer close(initDone)</span><br><span class="line"></span><br><span class="line">	var err error</span><br><span class="line">	if err = r.SetOption(options...); err != nil &#123;</span><br><span class="line">		return nil, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if r.c, err = compiler.New(r.cOpts...); err != nil &#123;</span><br><span class="line">		return nil, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// Defer shutdown handling to avoid a race on r.wg.</span><br><span class="line">	wg.Add(1)</span><br><span class="line">	defer func() &#123;</span><br><span class="line">		go func() &#123;</span><br><span class="line">			defer wg.Done()</span><br><span class="line">			&lt;-initDone</span><br><span class="line">			r.wg.Wait()        // ä¸‹é¢å¯åŠ¨äº†2ä¸ª goroutineï¼Œ è¿™é‡Œç­‰å¾… å°±æ˜¯ r.wg çš„ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ</span><br><span class="line">		&#125;()</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	// This goroutine is the main consumer/producer loop.</span><br><span class="line">	r.wg.Add(1)</span><br><span class="line">    go func() &#123;</span><br><span class="line">		defer r.wg.Done() // signal to owner we&#x27;re done</span><br><span class="line">		&lt;-initDone</span><br><span class="line">		for line := range lines &#123;</span><br><span class="line">			LineCount.Add(1)</span><br><span class="line">			r.handleMu.RLock()</span><br><span class="line">			for prog := range r.handles &#123;</span><br><span class="line">				r.handles[prog].lines &lt;- line</span><br><span class="line">			&#125;</span><br><span class="line">			r.handleMu.RUnlock()</span><br><span class="line">		&#125;</span><br><span class="line">		glog.Info(&quot;END OF LINE&quot;)</span><br><span class="line">		close(r.signalQuit)</span><br><span class="line">		r.handleMu.Lock()</span><br><span class="line">		for prog := range r.handles &#123;</span><br><span class="line">			close(r.handles[prog].lines)</span><br><span class="line">			delete(r.handles, prog)</span><br><span class="line">		&#125;</span><br><span class="line">		r.handleMu.Unlock()</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	if r.programPath == &quot;&quot; &#123;</span><br><span class="line">		glog.Info(&quot;No program path specified, no programs will be loaded.&quot;)</span><br><span class="line">		return r, nil</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// Create one goroutine that handles reload signals.</span><br><span class="line">	r.wg.Add(1)</span><br><span class="line">	go func() &#123;</span><br><span class="line">		defer r.wg.Done()</span><br><span class="line">		&lt;-initDone</span><br><span class="line">		if r.programPath == &quot;&quot; &#123;</span><br><span class="line">			glog.Info(&quot;no program reload on SIGHUP without programPath&quot;)</span><br><span class="line">			return</span><br><span class="line">		&#125;</span><br><span class="line">		n := make(chan os.Signal, 1)</span><br><span class="line">		signal.Notify(n, syscall.SIGHUP)</span><br><span class="line">		defer signal.Stop(n)</span><br><span class="line">		for &#123;</span><br><span class="line">			select &#123;</span><br><span class="line">			case &lt;-r.signalQuit:</span><br><span class="line">				return</span><br><span class="line">			case &lt;-n:</span><br><span class="line">				if err := r.LoadAllPrograms(); err != nil &#123;</span><br><span class="line">					glog.Info(err)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	// Guarantee all existing programmes get loaded before we leave.</span><br><span class="line">	if err := r.LoadAllPrograms(); err != nil &#123;</span><br><span class="line">		return nil, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return r, nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªNew ä¸»è¦å°±æ˜¯ç”¨æ¥åˆå§‹åŒ– &amp;Runtime è¿™ä¸ªçš„ã€‚</p>
<p>é‡Œé¢ç”¨åˆ°äº† ä¸€ä¸ªå°æŠ€å·§ã€‚</p>
<pre><code>initDone := make(chan struct&#123;&#125;)  æ–°å»ºä¸€ä¸ª é€šé“
defer close(initDone)  è¿™ä¸ªä¼šåœ¨ New æ–¹æ³•ç»“æŸæ—¶å€™ å»å…³é—­è¿™ä¸ªé€šé“ã€‚
</code></pre>
<p>æˆ‘ä»¬å…ˆæ¥ ç ”ç©¶ handles æ€ä¹ˆåˆå§‹åŒ–çš„ï¼Ÿï¼Œé¦–é€‰ä¸€å¼€å§‹ å°±æ–°å»ºäº†ä¸ªç©ºçš„ mapï¼Œè¿™ä¸ªæ—¶å€™ map é‡Œé¢ è¿˜æ²¡æœ‰ å»<br>åˆå§‹åŒ– vmHandle å¯¹è±¡çš„ã€‚</p>
<p>åœ¨ New æ–¹æ³•é‡Œé¢ æœ‰ 3ä¸ªåœ°æ–¹æ¯”è¾ƒé‡è¦ï¼Œ é‡Œé¢å¯åŠ¨äº† å‡ ä¸ª routineã€‚</p>
<h3 id="è¿™ç¬¬ä¸€ä¸ªé‡è¦ç‚¹"><a href="#è¿™ç¬¬ä¸€ä¸ªé‡è¦ç‚¹" class="headerlink" title="è¿™ç¬¬ä¸€ä¸ªé‡è¦ç‚¹"></a>è¿™ç¬¬ä¸€ä¸ªé‡è¦ç‚¹</h3><p>å¯åŠ¨äº†ä¸€ä¸ª routineï¼Œ é‡Œé¢for å¾ªç¯å»éå† è¿™ä¸ª linesï¼Œè¿™æ˜¯ä¸€ä¸ª é€šé“ï¼Œå°±æ˜¯ æ—¥å¿—æ–‡ä»¶çš„æ¯ä¸€è¡Œã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// This goroutine is the main consumer/producer loop.</span><br><span class="line">r.wg.Add(1)</span><br><span class="line">go func() &#123;</span><br><span class="line">	defer r.wg.Done() // signal to owner we&#x27;re done</span><br><span class="line">	&lt;-initDone</span><br><span class="line">	for line := range lines &#123;  //  for  å¾ªç¯ ä¸€ä¸ª é€šé“ï¼Œ ä¼šé˜»å¡åˆ°è¿™é‡Œï¼Œä¸€ç›´åˆ°é€šé“å…³é—­ã€‚é€šé“å…³é—­ æ˜¯åœ¨ tail.go é‡Œé¢çš„ New() æ–¹æ³•çš„ æœ€åæœ‰ä¸ª close(t.lines)</span><br><span class="line">		LineCount.Add(1)</span><br><span class="line">		r.handleMu.RLock()</span><br><span class="line">		for prog := range r.handles &#123;</span><br><span class="line">			r.handles[prog].lines &lt;- line</span><br><span class="line">		&#125;</span><br><span class="line">		r.handleMu.RUnlock()</span><br><span class="line">	&#125;</span><br><span class="line">	glog.Info(&quot;END OF LINE&quot;)</span><br><span class="line">	close(r.signalQuit)  //  ç”¨æˆ· å‘é€ åœæ­¢ ä¿¡å· å°±ä¼š é€€å‡ºä¸Šé¢çš„ for line := range lines å¾ªç¯ï¼Œè¿™é‡Œå°±ä¼š å…³é—­ signalQuit é€šé“ï¼Œç„¶å å°±ä¼š åˆ° ä¸‹é¢ select case &lt;-r.signalQuit: è¿™é‡Œ æ‰§è¡Œäº†ã€‚ã€‚ã€‚ã€‚ã€‚</span><br><span class="line">	r.handleMu.Lock()</span><br><span class="line">	for prog := range r.handles &#123;</span><br><span class="line">		close(r.handles[prog].lines)</span><br><span class="line">		delete(r.handles, prog)</span><br><span class="line">	&#125;</span><br><span class="line">	r.handleMu.Unlock()</span><br><span class="line">&#125;()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="è¿™ç¬¬-2-ä¸ª-é‡è¦ç‚¹-ä¹Ÿæ˜¯-å¯åŠ¨äº†ä¸€ä¸ª-routineï¼Œ"><a href="#è¿™ç¬¬-2-ä¸ª-é‡è¦ç‚¹-ä¹Ÿæ˜¯-å¯åŠ¨äº†ä¸€ä¸ª-routineï¼Œ" class="headerlink" title="è¿™ç¬¬ 2 ä¸ª é‡è¦ç‚¹  ä¹Ÿæ˜¯ å¯åŠ¨äº†ä¸€ä¸ª routineï¼Œ"></a>è¿™ç¬¬ 2 ä¸ª é‡è¦ç‚¹  ä¹Ÿæ˜¯ å¯åŠ¨äº†ä¸€ä¸ª routineï¼Œ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// Create one goroutine that handles reload signals.</span><br><span class="line">r.wg.Add(1)</span><br><span class="line">go func() &#123;</span><br><span class="line">	defer r.wg.Done()</span><br><span class="line">	&lt;-initDone</span><br><span class="line">	if r.programPath == &quot;&quot; &#123;</span><br><span class="line">		glog.Info(&quot;no program reload on SIGHUP without programPath&quot;)</span><br><span class="line">		return</span><br><span class="line">	&#125;</span><br><span class="line">	n := make(chan os.Signal, 1)</span><br><span class="line">	signal.Notify(n, syscall.SIGHUP)   // æ³¨å†Œä¸ª sighup ä¿¡å·çš„å‡ºæ¥ï¼Œ</span><br><span class="line">	defer signal.Stop(n)</span><br><span class="line">	for &#123;</span><br><span class="line">		select &#123;</span><br><span class="line">		case &lt;-r.signalQuit:  // è¿™ä¸ªå°±æ˜¯ é€€å‡ºçš„æ—¶å€™æ‰§è¡Œåˆ°è¿™é‡Œ</span><br><span class="line">			return</span><br><span class="line">		case &lt;-n:  // è¿™é‡Œ ç­‰å¾… æ¥æ”¶ ç”¨æˆ· å‘é€ çš„ sighup ä¿¡å·ï¼Œ è¿™ä¸ª æ„Ÿè§‰ å‘é€è¿™ä¸ªå‹å· å°±ä¼š é‡æ–° æ‰§è¡Œ LoadAllPrograms() æ–¹æ³•ï¼Œæ„Ÿè§‰åƒæ˜¯ é‡æ–° åŠ è½½ é…ç½®æ–‡ä»¶çš„ä½œç”¨ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ</span><br><span class="line">			if err := r.LoadAllPrograms(); err != nil &#123;</span><br><span class="line">				glog.Info(err)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>

<h3 id="ç¬¬ä¸‰ä¸ªé‡è¦ç‚¹"><a href="#ç¬¬ä¸‰ä¸ªé‡è¦ç‚¹" class="headerlink" title="ç¬¬ä¸‰ä¸ªé‡è¦ç‚¹"></a>ç¬¬ä¸‰ä¸ªé‡è¦ç‚¹</h3><p>LoadAllPrograms åŠ è½½ .mtail æ–‡ä»¶çš„å§</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// Guarantee all existing programmes get loaded before we leave.</span><br><span class="line">if err := r.LoadAllPrograms(); err != nil &#123;</span><br><span class="line">	return nil, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ä»è¡¨æ˜ä¸Š çœ‹ å…ˆ æ‰§è¡Œ ç¬¬ä¸€ä¸ªåœ°æ–¹ï¼Œ ç„¶å ç¬¬äºŒä¸ª åœ°æ–¹ï¼Œæœ€åæ˜¯ ç¬¬ä¸‰ä¸ªè¿™ä¸ªåœ°æ–¹ã€‚</p>
<p>å¦‚æœçœŸçš„æ˜¯ è¿™æ · handles æ€ä¹ˆåˆå§‹åŒ–çš„ï¼Ÿ è¿™ä¸ª å°±ä¼šæœ‰é—®é¢˜ï¼Œæ²¡æœ‰åˆå§‹åŒ– æ€ä¹ˆ èƒ½ ç›´æ¥ è¿™ä¹ˆä½¿ç”¨å‘¢ï¼Ÿ r.handles[prog].lines &lt;- line</p>
<p>æ‰€ä»¥ è¿™æ®µä»£ç  å¹¶ä¸æ˜¯ è¡¨æ˜çœ‹åˆ°çš„é‚£ä¸ªé¡ºåº  å»æ‰§è¡Œçš„ã€‚</p>
<p>è¿™2ä¸ª goroutine é‡Œé¢ éƒ½æœ‰ä¸€ä¸ª ç­‰å¾… æ¥æ”¶ initDone é€šè¿‡çš„ åŠ¨ä½œã€‚ <code>&lt;-initDone</code> éƒ½æ˜¯ä¸€ä¸Šæ¥å°±å…ˆæ‰§è¡Œè¿™å¥ã€‚<br>è¿™ä¸ªæ˜¯ä¸ª åªè¯»çš„ é€šé“ï¼Œä¸èƒ½å¾€é‡Œå†™å…¥çš„ï¼Œä¹Ÿçš„ç¡®æ²¡çœ‹åˆ°å“ªä¸ªåœ°æ–¹å¾€é‡Œå†™å…¥ã€‚é‚£ä¹ˆè°ƒç”¨è¿™ä¸ªä¸å°±ä¼šä¸€ç›´é˜»å¡çš„å—ï¼Œç¡®å®ä¼šé˜»å¡åˆ°è¿™é‡Œï¼Œä½†æ˜¯å½“ å…³é—­é€šé“æ—¶å€™<br>è¿™ä¸ªå°±ä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œäº†ã€‚ã€‚ã€‚ è¿™é‡Œé¢æ­£å¼ ç”¨åˆ°äº†è¿™ä¸ªæŠ€å·§ å¯¼è‡´ ä¸Šé¢ 3ä¸ª ç‚¹ æ‰§è¡Œé¡ºåº ä¸ä¸€æ ·äº†ã€‚</p>
<h3 id="æ€»ç»“-Runtime-New"><a href="#æ€»ç»“-Runtime-New" class="headerlink" title="æ€»ç»“ Runtime  New"></a>æ€»ç»“ Runtime  New</h3><p>ä¸‹é¢ æ€»ç»“ä¸€ä¸‹ è¿™ä¸ª æ‰§è¡Œé¡ºåºï¼š</p>
<pre><code>1. å…ˆ  `initDone := make(chan struct&#123;&#125;)` æ–°å»ºé€šé“
2. æ³¨å†Œ å¹¶ä¸” ç«‹å³ æ‰§è¡Œ ç¬¬1ä¸ª åœ°æ–¹çš„ goroutine
3. æ³¨å†Œ å¹¶ä¸” ç«‹å³ æ‰§è¡Œ ç¬¬2ä¸ª åœ°æ–¹çš„ goroutine
4. æ‰§è¡Œ ç¬¬ä¸‰ä¸ª åœ°æ–¹çš„ä»£ç  LoadAllPrograms(), è¿™ä¸€æ­¥é‡Œé¢ ä¼šå» åˆå§‹åŒ– handles é‡Œé¢çš„ å¯¹è±¡ã€‚è¿™ä¸ªåˆå§‹åŒ–å¥½ä¹‹å å°±èƒ½ ` r.handles[prog].lines ` è¿™æ ·æ¥ä½¿ç”¨äº†
5. æ­¤æ—¶ New() æ–¹æ³• ç»“æŸäº†ã€‚è¦æ‰§è¡Œ defer æ³¨å†Œçš„ æ–¹æ³•äº†ï¼Œå…¶ä¸­ æœ‰ä¸€ä¸ª å°±æ˜¯ å…³é—­ close(initDone) é€šé“çš„ã€‚
6. é€šé“å…³é—­ä¹‹åï¼Œ ç¬¬ä¸€ä¸ª goroutine  ä¼šç»§ç»­ &lt;-initDone ä¹‹åä»£ç çš„æ‰§è¡Œã€‚
7. åŒæ ·çš„ï¼Œ ç¬¬2ä¸ª goroutine  ä¹Ÿä¼šç»§ç»­ &lt;-initDone ä¹‹åä»£ç çš„æ‰§è¡Œã€‚
</code></pre>
<p>mtail ä»£ç  é‡Œé¢ å¤šå¤„ ç”¨åˆ° äº†è¿™æ ·çš„ æŠ€å·§ã€‚</p>
<p>ä¸Šé¢æåˆ°çš„ ç¬¬ä¸€ä¸ª goroutine æ˜¯ ç”¨æ¥æ¥æ”¶ ä»logæ–‡ä»¶è¯»å–çš„æ¯ä¸€è¡Œå†…å®¹çš„ã€‚ ä» lines é€šé“æ¥æ”¶ã€‚</p>
<p>åœ¨å“ªé‡Œ å¾€è¿™ä¸ªé€šé“æ”¾æ•°æ®å‘¢ï¼Ÿ </p>
<p>æ˜¯åœ¨ <code>internal/tailer/logstream/filestream.go</code> ä¸­çš„ <code>stream()</code> æ–¹æ³•ï¼Œ</p>
<p>è¿™é‡Œé¢æœ‰ä¸ª for å¾ªç¯ å»ä¸åœçš„è¯»æ–‡ä»¶ã€‚è¯»åˆ°æ–‡ä»¶ç»“å°¾å°±ä¼š sleepäº†ã€‚åé¢æ–‡ä»¶æœ‰æ–°å†™å…¥ä¼šç»§ç»­è¯»å–ã€‚</p>
<p>ç”¨åˆ°äº† <code>waker.Wake()</code> è¿™ä¸ªã€‚æ˜¯ä»è¿™é‡Œåˆå§‹åŒ–çš„ <code>logStreamPollWaker := waker.NewTimed(ctx, *pollInterval)</code></p>
<p>åœ¨ for å¾ªç¯é‡Œé¢ æœ‰ä¸ª <code>func decodeAndSend</code> æ–¹æ³•ï¼Œ åœ¨é‡Œé¢ æœ‰ä¸ª <code>func sendLine</code> å°±æ˜¯è¿™ä¸ªæ–¹æ³• å¾€é€šé“é‡Œé¢å‘é€æ¯ä¸€è¡Œæ•°æ®çš„ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">func sendLine(ctx context.Context, pathname string, partial *bytes.Buffer, lines chan&lt;- *logline.LogLine) &#123;</span><br><span class="line">	glog.V(2).Infof(&quot;sendline&quot;)</span><br><span class="line">	logLines.Add(pathname, 1)</span><br><span class="line">	lines &lt;- logline.New(ctx, pathname, partial.String())</span><br><span class="line">	partial.Reset()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Runtime-ä¸­çš„-LoadAllPrograms-æ–¹æ³•"><a href="#Runtime-ä¸­çš„-LoadAllPrograms-æ–¹æ³•" class="headerlink" title="Runtime ä¸­çš„ LoadAllPrograms æ–¹æ³•"></a>Runtime ä¸­çš„ LoadAllPrograms æ–¹æ³•</h3><p>è°ƒç”¨ é¡ºåº <code>LoadAllPrograms</code> -&gt; <code>LoadProgram </code> -&gt;  <code>CompileAndRun</code>  -&gt; <code>Compile(name, &amp;buf)</code> -&gt; <code>VM ä¸­çš„ Run()</code></p>
<ol>
<li><p>LoadAllPrograms é‡Œé¢ å¾ªç¯ -prog é€‰é¡¹ åé¢çš„ç›®å½•ï¼Œéå† è¿™ä¸ª ç›®å½•ä¸‹é¢çš„ æ‰€æœ‰çš„ mtail ç»“å°¾çš„æ–‡ä»¶ã€‚</p>
<p> è¿™ä¸ªé‡Œé¢ è¿˜ä¼š å¯¹ ä¸€äº› å·²ç» åˆ é™¤æ‰çš„ mtail æ–‡ä»¶ è¿›è¡Œå¤„ç†ï¼Œ ä¼šå…³é—­ å…¶å¯¹åº”çš„ handle.lines å’Œ ä» handles map ä¸­åˆ é™¤ã€‚</p>
</li>
<li><p>å¦‚æœ  -prog é€‰é¡¹ è·Ÿç€çš„æ˜¯ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ é‚£å°± åª éå† è¿™ä¸ªä¸€ä¸ªæ–‡ä»¶äº†ï¼Œ</p>
</li>
<li><p>å…¶å® å°±æ˜¯ å¾ªç¯ æ¯ä¸ª mtail æ–‡ä»¶ï¼Œå¯¹å…¶è°ƒç”¨ <code>LoadProgram</code> æ–¹æ³•äº†. è¿™ä¸ªæ–¹æ³•å°±æ¥æ”¶ä¸€ä¸ª mtailæ–‡ä»¶è·¯å¾„ä½œä¸ºå‚æ•°ã€‚</p>
</li>
</ol>
<h3 id="Runtime-ä¸­çš„-LoadProgram-æ–¹æ³•"><a href="#Runtime-ä¸­çš„-LoadProgram-æ–¹æ³•" class="headerlink" title="Runtime ä¸­çš„ LoadProgram æ–¹æ³•"></a>Runtime ä¸­çš„ LoadProgram æ–¹æ³•</h3><ol>
<li>åˆ¤æ–­ æ˜¯å¦ ç‚¹ å¼€å¤´çš„æ–‡ä»¶ï¼Œéšè—æ–‡ä»¶ä¼šå¿½ç•¥çš„ã€‚</li>
<li>åˆ¤æ–­æ˜¯å¦ .mtail åç¼€çš„æ–‡ä»¶ï¼Œä¸æ˜¯ä¹Ÿä¼šå¿½ç•¥çš„ã€‚</li>
<li>æ‰“å¼€è¿™ä¸ªæ–‡ä»¶ï¼Œæ‰“å¼€å¤±è´¥ä¼šç›´æ¥è¿”å›ï¼Œä¹Ÿä¼šåŠ ä¸ªé”™è¯¯æ ‡è®° åˆ° <code>ProgLoadErrors.Add(name, 1)</code>, è¿™ä¸ªæ˜¯ç”¨æ¥ è®¡æ•° åŠ è½½ mtail å¤±è´¥æ¬¡æ•°çš„ã€‚é‡Œé¢éƒ½æœ‰ é”ä¿æŠ¤çš„ã€‚</li>
<li>æ‰“å¼€æ–‡ä»¶æˆåŠŸï¼Œç„¶å æ³¨å†Œ defer æ–¹æ³• å»è¦å…³é—­è¿™ä¸ªæ–‡ä»¶çš„ã€‚</li>
<li>è°ƒç”¨ <code>CompileAndRun</code> æ–¹æ³•ï¼Œ è¿”å›å€¼ ä¼šå­˜æ”¾åˆ° <code>r.programErrors</code> å­—å…¸é‡Œé¢ï¼Œå­—å…¸keyå°±æ˜¯ mtail æ–‡ä»¶åï¼Œ<br> å½“ç„¶ å¾€è¿™ä¸ªå­—å…¸é‡Œé¢ åŠ æ•°æ® å‰åä¹Ÿæœ‰é” ä¿æŠ¤çš„ã€‚</li>
<li>å¦‚æœ  <code> r.programErrors[name] </code>  ä¸æ˜¯nil ï¼Œå¹¶ä¸” <code>r.errorsAbort</code> è®¾ç½®äº†ï¼Œå°±ä¼šè¿”å› è¿™ä¸ªé”™è¯¯çŠ¶æ€äº†ã€‚è¿™æ˜¯ä¸ª error ç±»å‹çš„ã€‚</li>
</ol>
<h3 id="Runtime-ä¸­çš„-CompileAndRun-æ–¹æ³•"><a href="#Runtime-ä¸­çš„-CompileAndRun-æ–¹æ³•" class="headerlink" title="Runtime ä¸­çš„ CompileAndRun æ–¹æ³•"></a>Runtime ä¸­çš„ CompileAndRun æ–¹æ³•</h3><p>è¿™ä¸ªæ–¹æ³• æ¥æ”¶ 2ä¸ªå‚æ•° ï¼Œä¸€ä¸ªæ˜¯ mtail æ–‡ä»¶åï¼Œ ä¸€ä¸ªå°±æ˜¯  æ‰“å¼€çš„ mtail æ–‡ä»¶ çš„ <code>io.Reader</code></p>
<ol>
<li><p>è®¡ç®— mtail æ–‡ä»¶å†…å®¹çš„ sha256 å€¼ï¼Œ åˆ©ç”¨äº† TeeReader æ¥è¯»å–ï¼Œå‡å°‘å†…å­˜æ¶ˆè€—ã€‚</p>
</li>
<li><p>åŠ é”ä¿æŠ¤ï¼Œè¯»å–mapä¸­æ•°æ®ï¼Œ <code>vh, ok := r.handles[name]</code>  çš„å¥½ handles ä¸­çš„ vhï¼Œè¿™ä¸ªæ˜¯ vmHandle ç±»å‹çš„ã€‚</p>
<pre><code> ç¬¬ä¸€æ¬¡è¯»å–ï¼Œok=falseï¼Œè‚¯å®šæ˜¯æ²¡æœ‰å€¼çš„ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰ åˆå§‹åŒ–å‘¢ï¼Œ
 åªæ˜¯å‰è¾¹å§ handles è¿™ä¸ª map ç»™æ–°å»ºå‡ºæ¥äº†ï¼Œè¿˜æ²¡å¾€é‡Œæ”¾ä¸œè¥¿å‘¢ã€‚
 
 åç»­å†æ¬¡è¯»å–å°±èƒ½ å¾—åˆ°å€¼ï¼Œå¦‚æœçš„åˆ°äº†ï¼Œå°±ä¼š è¿›è¡Œ æ¯”è¾ƒäº†`  bytes.Equal(vh.contentHash, contentHash)`
 vhé‡Œé¢å­˜æ”¾çš„ mtail æ–‡ä»¶å†…å®¹çš„ hash å€¼ å’Œ å‰é¢é‚£ä¸€æ­¥ç®—å‡ºæ¥çš„ æ˜¯å¦ä¸€è‡´ï¼Œä¸€è‡´è¯´æ˜ mtail æ–‡ä»¶æ²¡æœ‰å˜åŒ–å‘€ï¼Œç›´æ¥returnäº†ã€‚
 æœ‰å˜åŒ– æ‰ä¼šå¾€ä¸‹æ‰§è¡Œï¼Œå¾€ä¸‹æ‰§è¡Œ è‚¯å®šæ˜¯ é‡æ–° New å‡ºæ¥ä¸€ä¸ª æ–°çš„ vmHandle å¤åˆ¶ç»™ å­—å…¸é‡Œé¢ r.handles[name] æ‹‰ã€‚
</code></pre>
</li>
<li><p>æ‰§è¡Œ <code>obj, errs := r.c.Compile(name, &amp;buf)</code> æŠŠ mtail æ–‡ä»¶åä¼ å…¥ï¼Œ mtail æ–‡ä»¶ å†…å®¹ä¼ å…¥ã€‚è¿”å› <code>*code.Object</code> ç±» å‹,æ¥è‡ª <code>internal/runtime/code/object.go</code> æ–‡ä»¶ä¸­</p>
</li>
<li><p>å¦‚æœç¬¬ä¸‰æ­¥ æ‰§è¡Œ æœ‰ errï¼Œ æˆ–è€… è¿”å› çš„ obj æ˜¯ nil å°±ä¼š è®°å½•åœ¨ ProgLoadErrors é‡Œé¢ï¼Œå°±ä¼šç»™è¿™ä¸ª é‡Œé¢çš„è®¡æ•° åŠ ä¸€äº†ã€‚ è¿™ä¸ªåœ¨ (â€œRuntime ä¸­çš„ LoadProgram æ–¹æ³•â€) ç¬¬ 6 æ­¥çš„ æ—¶å€™ä¹Ÿæœ‰ä»‹ç»ã€‚</p>
</li>
<li><p>é‡å¤´å‡ºæ¥äº†ï¼Œvmçš„åˆå§‹åŒ–ï¼Œä¹Ÿå°±æ˜¯ vmHandle ä¸­çš„ vmçš„ åˆå§‹åŒ–ã€‚ è°ƒç”¨ vm.New() æ–¹æ³•</p>
</li>
<li><p>æ¥ç€ é‡å¤´ï¼š vmHandle çš„åˆå§‹åŒ–ï¼Œ<code>&amp;vmHandle&#123;contentHash: contentHash, vm: v, lines: lines&#125;</code></p>
</li>
<li><p>è°ƒç”¨ <code>go v.Run(lines, &amp;r.wg)</code>ï¼Œ è¿˜æ˜¯æ”¾åˆ°ä¸€ä¸ª goroutine é‡Œé¢æ‰§è¡Œçš„ã€‚åœ¨è¿™ä¸ªé‡Œé¢å°±ä¼šå‡ºæ¥ lines é€šé“ã€‚å°±æ˜¯å¤„ç†æ¯ä¸€è¡Œæ—¥å¿—æ–‡ä»¶çš„å†…å®¹äº†ã€‚</p>
</li>
</ol>
<h3 id="VM-ä¸­çš„-Run-æ–¹æ³•"><a href="#VM-ä¸­çš„-Run-æ–¹æ³•" class="headerlink" title="VM ä¸­çš„ Run æ–¹æ³•"></a>VM ä¸­çš„ Run æ–¹æ³•</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">func (v *VM) Run(lines &lt;-chan *logline.LogLine, wg *sync.WaitGroup) &#123;</span><br><span class="line">	defer wg.Done()</span><br><span class="line">	glog.V(1).Infof(&quot;started VM %q&quot;, v.name)</span><br><span class="line">	ctx := context.TODO()</span><br><span class="line">	for line := range lines &#123;</span><br><span class="line">		v.ProcessLogLine(ctx, line)</span><br><span class="line">	&#125;</span><br><span class="line">	glog.Infof(&quot;VM %q finished&quot;, v.name)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ª run æ–¹æ³• å°±æ˜¯ å¾ªç¯ å¤„ç† æ¥è‡ª é€šé“ lines çš„æ¯ä¸€è¡Œæ•°æ®çš„ï¼Œæ²¡æœ‰æ–°çš„æ•°æ®æ¥ å›ç­‰å¾…é‚£é‡Œã€‚</p>
<h3 id="VM-ä¸­çš„-ProcessLogLine-æ–¹æ³•"><a href="#VM-ä¸­çš„-ProcessLogLine-æ–¹æ³•" class="headerlink" title="VM ä¸­çš„ ProcessLogLine æ–¹æ³•"></a>VM ä¸­çš„ ProcessLogLine æ–¹æ³•</h3><p>çœŸæ­£å» å¤„ç† æ¯ä¸€è¡Œæ—¥å¿—æ•°æ®çš„ã€‚æ¯ä¸€è¡Œ å°±æ˜¯ä¸€ä¸ª å­—ç¬¦ä¸²ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">func (v *VM) ProcessLogLine(ctx context.Context, line *logline.LogLine) &#123;</span><br><span class="line">	start := time.Now()</span><br><span class="line">	defer func() &#123;</span><br><span class="line">		LineProcessingDurations.WithLabelValues(v.name).Observe(time.Since(start).Seconds())</span><br><span class="line">	&#125;()</span><br><span class="line">	t := new(thread)</span><br><span class="line">	t.matched = false</span><br><span class="line">	v.t = t</span><br><span class="line">	v.input = line</span><br><span class="line">	t.stack = make([]interface&#123;&#125;, 0)</span><br><span class="line">	t.matches = make(map[int][]string, len(v.re))</span><br><span class="line">	for &#123;</span><br><span class="line">		if t.pc &gt;= len(v.prog) &#123;</span><br><span class="line">			return</span><br><span class="line">		&#125;</span><br><span class="line">		if v.trace != nil &#123;</span><br><span class="line">			v.trace = append(v.trace, t.pc)</span><br><span class="line">		&#125;</span><br><span class="line">		i := v.prog[t.pc]</span><br><span class="line">		t.pc++</span><br><span class="line"></span><br><span class="line">		v.execute(t, i)</span><br><span class="line"></span><br><span class="line">		if v.terminate &#123;</span><br><span class="line">			// Terminate only stops this invocation on this line of input; reset the terminate flag.</span><br><span class="line">			v.terminate = false</span><br><span class="line">			return</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•é‡Œé¢ å°±æ˜¯ å¯¹ ä¸€è¡Œæ•°æ® è¿›è¡Œ å¤„ç†çš„ã€‚ ä¸»è¦çš„å°±æ˜¯ <code>v.execute(t, i) </code> t æ˜¯ä¸€ä¸ª threadï¼Œ i æ˜¯ Instrï¼Œè¿™ä¸ªåº”è¯¥æ˜¯mtailæ–‡ä»¶ç¼–è¯‘åå¾—åˆ°çš„ã€‚</p>
<h3 id="è¯¦ç»†-åˆ†æä¸€ä¸‹-Compile-name-amp-buf-æ–¹æ³•"><a href="#è¯¦ç»†-åˆ†æä¸€ä¸‹-Compile-name-amp-buf-æ–¹æ³•" class="headerlink" title="è¯¦ç»† åˆ†æä¸€ä¸‹ Compile(name, &amp;buf) æ–¹æ³•"></a>è¯¦ç»† åˆ†æä¸€ä¸‹ Compile(name, &amp;buf) æ–¹æ³•</h3><p>è¿™ä¸ªæ–¹æ³•çš„ è¿”å›å€¼ æ˜¯ åœ¨ æ–°å»ºVMå®ä¾‹çš„æ—¶å€™ç”¨åˆ°çš„ï¼Œéœ€è¦ä¼ å…¥çš„ä¸€ä¸ªå‚æ•°ï¼Œ vm.New() æ—¶å€™ç”¨åˆ°çš„ã€‚</p>
<p>è¿™ä¸ªæ–¹æ³• å°±æ˜¯ æŠŠ mtail æ–‡ä»¶å†…å®¹ è§£æè½¬æ¢æˆ å¯¹åº”çš„ code.Object ç±»å‹ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ast, err = parser.Parse(name, input)  é€šè¿‡ parse è§£æï¼Œ å¾—åˆ° ast</span><br><span class="line"></span><br><span class="line">name æ˜¯ mtail æ–‡ä»¶åç§°ï¼Œä¸å¸¦è·¯å¾„çš„</span><br><span class="line">input å°±æ˜¯ mtail æ–‡ä»¶æ•´ä½“å†…å®¹ã€‚æ³¨é‡Šçš„è¡Œ ä¹ŸåŒ…å«åœ¨é‡Œé¢çš„ã€‚</span><br><span class="line"></span><br><span class="line">ast æŠ½è±¡ è¯­æ³•æ ‘</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">obj, err = codegen.CodeGen(name, ast) é€šè¿‡ ast è½¬æ¢ä¸º obj</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªè§£æ æ„Ÿè§‰ åˆ è¿›å…¥äº†åˆ°äº† å¦å¤–ä¸€ä¸ª å¤æ‚çš„é¢†åŸŸäº†ã€‚ã€‚ã€‚ yaccï¼Œ lexer ç­‰ç­‰ã€‚</p>
<p>parser.Parse æ–¹æ³•ï¼Œé‡Œé¢æœ‰è°ƒç”¨ newParser() ç„¶åå°±è°ƒç”¨ mtailParse(p) äº†ã€‚è°ƒç”¨è¿™ä¸ªæ–¹æ³• å°±ä¸èƒ½æ–­ç‚¹è°ƒè¯•äº†ã€‚ã€‚ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">func Parse(name string, input io.Reader) (ast.Node, error) &#123;</span><br><span class="line">	p := newParser(name, input)</span><br><span class="line">	r := mtailParse(p)</span><br><span class="line">	if r != 0 || p.errors != nil &#123;</span><br><span class="line">		return nil, p.errors</span><br><span class="line">	&#125;</span><br><span class="line">	return p.root, nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">counter lines_total</span><br><span class="line">/$/ &#123;</span><br><span class="line">  lines_total++</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·çš„ä¸€ä¸ª mtail æ–‡ä»¶ ç¼–è¯‘å åˆ°çš„ Object.Program é‡Œé¢ æœ‰7ä¸ª Instrã€‚ è¿™æ˜¯ä¸€ä¸ªåˆ‡ç‰‡ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0 = &#123;github.com/google/mtail/internal/runtime/code.Instr&#125; </span><br><span class="line">1 = &#123;github.com/google/mtail/internal/runtime/code.Instr&#125; </span><br><span class="line">2 = &#123;github.com/google/mtail/internal/runtime/code.Instr&#125; </span><br><span class="line">3 = &#123;github.com/google/mtail/internal/runtime/code.Instr&#125; </span><br><span class="line">4 = &#123;github.com/google/mtail/internal/runtime/code.Instr&#125; </span><br><span class="line">5 = &#123;github.com/google/mtail/internal/runtime/code.Instr&#125; </span><br><span class="line">6 = &#123;github.com/google/mtail/internal/runtime/code.Instr&#125; </span><br></pre></td></tr></table></figure>
<p>åŒæ—¶ Object.Strings æ˜¯ nil</p>
<p>Object.Regexps æ˜¯ æ­£åˆ™ <code>$</code></p>
<p>Object.Metrics é‡Œé¢æœ‰ 1 ä¸ª</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="https://magesfc.github.io">mage</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://magesfc.github.io/mage/3b62171753fddbbf78c36e3f6d7c9ba008365560/">https://magesfc.github.io/mage/3b62171753fddbbf78c36e3f6d7c9ba008365560/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://magesfc.github.io" target="_blank">é©¬å“¥ç§æˆ¿èœ</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/golang/">golang</a><a class="post-meta__tags" href="/tags/mtail/">mtail</a></div><div class="post_share"><div class="social-share" data-image="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> æ‰“èµ</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/null" target="_blank"><img class="post-qr-code-img" src= "/img/loading.gif" data-lazy-src="/null" alt="å¾®ä¿¡"/></a><div class="post-qr-code-desc">å¾®ä¿¡</div></li><li class="reward-item"><a href="/null" target="_blank"><img class="post-qr-code-img" src= "/img/loading.gif" data-lazy-src="/null" alt="æ”¯ä»˜å¯¶"/></a><div class="post-qr-code-desc">æ”¯ä»˜å¯¶</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/mage/f7b2ae126d593c93046cbf03febb201f10fef861/"><img class="prev-cover" src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">Golangå­¦ä¹ ä¹‹ç±»å‹è½¬æ¢</div></div></a></div><div class="next-post pull-right"><a href="/mage/59738b29b03ec88e9f98548ab2d29fd5592d7c6d/"><img class="next-cover" src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">Golangå­¦ä¹ ä¹‹dlvæ–­ç‚¹è°ƒè¯•</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/mage/6118b9bf91824574204e116d5b138ffbaab72268/" title="Golangå­¦ä¹ ä¹‹structè½¬json"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-14</div><div class="title">Golangå­¦ä¹ ä¹‹structè½¬json</div></div></a></div><div><a href="/mage/f7b2ae126d593c93046cbf03febb201f10fef861/" title="Golangå­¦ä¹ ä¹‹ç±»å‹è½¬æ¢"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-08</div><div class="title">Golangå­¦ä¹ ä¹‹ç±»å‹è½¬æ¢</div></div></a></div><div><a href="/mage/18ccd178a6f3d405a26d5528e6f41f3b38eb6aa9/" title="Golangå­¦ä¹ ç¬”è®°æ€»ç»“"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-23</div><div class="title">Golangå­¦ä¹ ç¬”è®°æ€»ç»“</div></div></a></div><div><a href="/mage/59738b29b03ec88e9f98548ab2d29fd5592d7c6d/" title="Golangå­¦ä¹ ä¹‹dlvæ–­ç‚¹è°ƒè¯•"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-08</div><div class="title">Golangå­¦ä¹ ä¹‹dlvæ–­ç‚¹è°ƒè¯•</div></div></a></div><div><a href="/mage/c2d4f359f2ad8b1560a3323b9940d7aee2b7aabc/" title="Golangçš„58ä¸ªå‘"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-02</div><div class="title">Golangçš„58ä¸ªå‘</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "/img/loading.gif" data-lazy-src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">mage</div><div class="author-info__description"> è¿™é‡Œæ˜¯ é©¬å“¥ çš„ä¸ªäººåšå®¢ </div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">169</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">187</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">34</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mamh2021"><i class="fab fa-github"></i><span>GitHub</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/mamh2021" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#mtail-%E5%AD%A6%E4%B9%A0"><span class="toc-number">1.</span> <span class="toc-text">mtail  å­¦ä¹ </span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#mtail-%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.</span> <span class="toc-text">mtail ä»‹ç»</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C-mtail"><span class="toc-number">3.</span> <span class="toc-text">è¿è¡Œ mtail</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#mtail-%E5%91%BD%E4%BB%A4-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">mtail å‘½ä»¤ æºç åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#mtail-New-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">4.1.</span> <span class="toc-text">mtail.New åˆå§‹åŒ–</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Runtime-New-%E6%96%B9%E6%B3%95%E3%80%82"><span class="toc-number">4.2.</span> <span class="toc-text">Runtime  New æ–¹æ³•ã€‚</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%99%E7%AC%AC%E4%B8%80%E4%B8%AA%E9%87%8D%E8%A6%81%E7%82%B9"><span class="toc-number">4.2.1.</span> <span class="toc-text">è¿™ç¬¬ä¸€ä¸ªé‡è¦ç‚¹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%99%E7%AC%AC-2-%E4%B8%AA-%E9%87%8D%E8%A6%81%E7%82%B9-%E4%B9%9F%E6%98%AF-%E5%90%AF%E5%8A%A8%E4%BA%86%E4%B8%80%E4%B8%AA-routine%EF%BC%8C"><span class="toc-number">4.2.2.</span> <span class="toc-text">è¿™ç¬¬ 2 ä¸ª é‡è¦ç‚¹  ä¹Ÿæ˜¯ å¯åŠ¨äº†ä¸€ä¸ª routineï¼Œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E4%B8%AA%E9%87%8D%E8%A6%81%E7%82%B9"><span class="toc-number">4.2.3.</span> <span class="toc-text">ç¬¬ä¸‰ä¸ªé‡è¦ç‚¹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-Runtime-New"><span class="toc-number">4.2.4.</span> <span class="toc-text">æ€»ç»“ Runtime  New</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Runtime-%E4%B8%AD%E7%9A%84-LoadAllPrograms-%E6%96%B9%E6%B3%95"><span class="toc-number">4.2.5.</span> <span class="toc-text">Runtime ä¸­çš„ LoadAllPrograms æ–¹æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Runtime-%E4%B8%AD%E7%9A%84-LoadProgram-%E6%96%B9%E6%B3%95"><span class="toc-number">4.2.6.</span> <span class="toc-text">Runtime ä¸­çš„ LoadProgram æ–¹æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Runtime-%E4%B8%AD%E7%9A%84-CompileAndRun-%E6%96%B9%E6%B3%95"><span class="toc-number">4.2.7.</span> <span class="toc-text">Runtime ä¸­çš„ CompileAndRun æ–¹æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#VM-%E4%B8%AD%E7%9A%84-Run-%E6%96%B9%E6%B3%95"><span class="toc-number">4.2.8.</span> <span class="toc-text">VM ä¸­çš„ Run æ–¹æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#VM-%E4%B8%AD%E7%9A%84-ProcessLogLine-%E6%96%B9%E6%B3%95"><span class="toc-number">4.2.9.</span> <span class="toc-text">VM ä¸­çš„ ProcessLogLine æ–¹æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%A6%E7%BB%86-%E5%88%86%E6%9E%90%E4%B8%80%E4%B8%8B-Compile-name-amp-buf-%E6%96%B9%E6%B3%95"><span class="toc-number">4.2.10.</span> <span class="toc-text">è¯¦ç»† åˆ†æä¸€ä¸‹ Compile(name, &amp;buf) æ–¹æ³•</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/mage/298144bf31bdad623369d39b38ebddb64dde1abd/" title="jenkinså­¦ä¹ ä¹‹Jenkinså¼€å‘è°ƒè¯•äºjenkinsæ’ä»¶å¼€å‘è°ƒè¯•"><img src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="jenkinså­¦ä¹ ä¹‹Jenkinså¼€å‘è°ƒè¯•äºjenkinsæ’ä»¶å¼€å‘è°ƒè¯•"/></a><div class="content"><a class="title" href="/mage/298144bf31bdad623369d39b38ebddb64dde1abd/" title="jenkinså­¦ä¹ ä¹‹Jenkinså¼€å‘è°ƒè¯•äºjenkinsæ’ä»¶å¼€å‘è°ƒè¯•">jenkinså­¦ä¹ ä¹‹Jenkinså¼€å‘è°ƒè¯•äºjenkinsæ’ä»¶å¼€å‘è°ƒè¯•</a><time datetime="2023-03-16T05:47:11.000Z" title="æ›´æ–°äº 2023-03-16 13:47:11">2023-03-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/mage/99fd30947b3d8a14f909e4875dc196943b037448/" title="jenkinsæ’ä»¶å­¦ä¹ ä¹‹extended-choice-parameter-plugin"><img src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="jenkinsæ’ä»¶å­¦ä¹ ä¹‹extended-choice-parameter-plugin"/></a><div class="content"><a class="title" href="/mage/99fd30947b3d8a14f909e4875dc196943b037448/" title="jenkinsæ’ä»¶å­¦ä¹ ä¹‹extended-choice-parameter-plugin">jenkinsæ’ä»¶å­¦ä¹ ä¹‹extended-choice-parameter-plugin</a><time datetime="2023-03-11T13:56:49.000Z" title="æ›´æ–°äº 2023-03-11 21:56:49">2023-03-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/mage/b86949e1fd66e39ee6b396cf422c6660cdcb5ebe/" title="Androidä¸‹çš„é…ç½®ç®¡ç†ä¹‹é“ä¹‹gerrité…ç½®jsæ’ä»¶"><img src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Androidä¸‹çš„é…ç½®ç®¡ç†ä¹‹é“ä¹‹gerrité…ç½®jsæ’ä»¶"/></a><div class="content"><a class="title" href="/mage/b86949e1fd66e39ee6b396cf422c6660cdcb5ebe/" title="Androidä¸‹çš„é…ç½®ç®¡ç†ä¹‹é“ä¹‹gerrité…ç½®jsæ’ä»¶">Androidä¸‹çš„é…ç½®ç®¡ç†ä¹‹é“ä¹‹gerrité…ç½®jsæ’ä»¶</a><time datetime="2023-01-11T09:11:46.000Z" title="æ›´æ–°äº 2023-01-11 17:11:46">2023-01-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/mage/8facee0ca4bc4450ba21eea69a97fe1891c415dc/" title="Linuxå­¦ä¹ ä¹‹bashå­¦ä¹ ä¹‹bash_strict_mode"><img src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linuxå­¦ä¹ ä¹‹bashå­¦ä¹ ä¹‹bash_strict_mode"/></a><div class="content"><a class="title" href="/mage/8facee0ca4bc4450ba21eea69a97fe1891c415dc/" title="Linuxå­¦ä¹ ä¹‹bashå­¦ä¹ ä¹‹bash_strict_mode">Linuxå­¦ä¹ ä¹‹bashå­¦ä¹ ä¹‹bash_strict_mode</a><time datetime="2022-12-13T11:18:28.000Z" title="æ›´æ–°äº 2022-12-13 19:18:28">2022-12-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/mage/38b16f805c0e0bfdce028d95fdd10a0b160e9167/" title="Linuxå­¦ä¹ ä¹‹æ–‡ä»¶ç³»ç»Ÿbtrfsæ–‡ä»¶ç³»ç»Ÿ"><img src= "/img/loading.gif" data-lazy-src="https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linuxå­¦ä¹ ä¹‹æ–‡ä»¶ç³»ç»Ÿbtrfsæ–‡ä»¶ç³»ç»Ÿ"/></a><div class="content"><a class="title" href="/mage/38b16f805c0e0bfdce028d95fdd10a0b160e9167/" title="Linuxå­¦ä¹ ä¹‹æ–‡ä»¶ç³»ç»Ÿbtrfsæ–‡ä»¶ç³»ç»Ÿ">Linuxå­¦ä¹ ä¹‹æ–‡ä»¶ç³»ç»Ÿbtrfsæ–‡ä»¶ç³»ç»Ÿ</a><time datetime="2022-12-05T14:37:10.000Z" title="æ›´æ–°äº 2022-12-05 22:37:10">2022-12-05</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://office-1256119282.file.myqcloud.com/2022/official-web/cdn/20220301/pc_bg_05.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By mage</div><div class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="true" data-click="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>