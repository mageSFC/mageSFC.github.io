<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Linux学习之文件系统zfs文件系统 | 马哥私房菜</title><meta name="author" content="mage"><meta name="copyright" content="mage"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="ZFS（Zettabyte File System）一个打破过去思维的文件系统，是 Sun Microsystems这家公司所开发出来的全新型态文件系统，因为License的问题所以目前只有在Solaris、Mac、BSD上看得到，ZFS是128bit的文件系统，而它到底有多强呢？别再等待了马上用了你就知道，只能说ZFS真是一个上帝赐给IT人员的好礼物。  为什么选择 ZFS ZFS 非常的优秀">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux学习之文件系统zfs文件系统">
<meta property="og:url" content="https://magesfc.github.io/mage/d98de400d172c2a1012ced6496ab01f175b24831/">
<meta property="og:site_name" content="马哥私房菜">
<meta property="og:description" content="ZFS（Zettabyte File System）一个打破过去思维的文件系统，是 Sun Microsystems这家公司所开发出来的全新型态文件系统，因为License的问题所以目前只有在Solaris、Mac、BSD上看得到，ZFS是128bit的文件系统，而它到底有多强呢？别再等待了马上用了你就知道，只能说ZFS真是一个上帝赐给IT人员的好礼物。  为什么选择 ZFS ZFS 非常的优秀">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://t.mwm.moe/fj/">
<meta property="article:published_time" content="2022-02-23T09:47:21.000Z">
<meta property="article:modified_time" content="2022-02-23T09:47:21.000Z">
<meta property="article:author" content="mage">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="zfs">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://t.mwm.moe/fj/"><link rel="shortcut icon" href="https://www.zeekrlife.com/favicon.png"><link rel="canonical" href="https://magesfc.github.io/mage/d98de400d172c2a1012ced6496ab01f175b24831/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: mage","link":"链接: ","source":"来源: 马哥私房菜","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Linux学习之文件系统zfs文件系统',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-02-23 17:47:21'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><style type="text/css">.card-announcement .social-button{margin:.6rem 0 0 0;text-align:center}.card-announcement .social-button a{display:block;background-color:var(--btn-bg);color:var(--btn-color);text-align:center;line-height:2.4;margin:4px 0}.card-announcement .social-button a:hover{background-color:var(--btn-hover-color)}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "/img/loading.gif" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">217</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">233</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">40</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-compass"></i><span> 目录</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 精选文档</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/21cfbf15/"><span> 🚀 快速开始</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/dc584b87/"><span> 📑 主题页面</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/4aa8abbe/"><span> 🛠 主题配置-1</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/ceeb73f/"><span> 🛠 主题配置-2</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/98d20436/"><span> ❓ 主题问答</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/4073eda/"><span> ⚡️ 进阶教程</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/198a4240/"><span> ✨ 更新日志</span></a></li></ul></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://butterfly.js.org/link/"><i class="fa-fw fas fa-thumbs-up"></i><span> 其他示例</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://t.mwm.moe/fj/')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">马哥私房菜</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-compass"></i><span> 目录</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 精选文档</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/21cfbf15/"><span> 🚀 快速开始</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/dc584b87/"><span> 📑 主题页面</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/4aa8abbe/"><span> 🛠 主题配置-1</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/ceeb73f/"><span> 🛠 主题配置-2</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/98d20436/"><span> ❓ 主题问答</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/4073eda/"><span> ⚡️ 进阶教程</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://butterfly.js.org/posts/198a4240/"><span> ✨ 更新日志</span></a></li></ul></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://butterfly.js.org/link/"><i class="fa-fw fas fa-thumbs-up"></i><span> 其他示例</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Linux学习之文件系统zfs文件系统</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-02-23T09:47:21.000Z" title="发表于 2022-02-23 17:47:21">2022-02-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-02-23T09:47:21.000Z" title="更新于 2022-02-23 17:47:21">2022-02-23</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/linux/">linux</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Linux学习之文件系统zfs文件系统"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p> ZFS（Zettabyte File System）一个打破过去思维的文件系统，是 Sun Microsystems这家公司所开发出来的全新型态文件系统，因为License的问题所以目前只有在Solaris、Mac、BSD上看得到，ZFS是128bit的文件系统，而它到底有多强呢？别再等待了马上用了你就知道，只能说ZFS真是一个上帝赐给IT人员的好礼物。 </p>
<h2 id="为什么选择-ZFS"><a href="#为什么选择-ZFS" class="headerlink" title="为什么选择 ZFS"></a>为什么选择 ZFS</h2><blockquote>
<p>ZFS 非常的优秀。这是一个真正现代的文件系统，内置的功能对于处理大量的数据很有意义。<br>ZFS 消除了建立传统 RAID 阵列（独立磁盘冗余阵列）的需要。 相反，您可以创建 ZFS 池，甚至可以随时将驱动器添加到这些池中。 ZFS 池的行为操作与 RAID 几乎完全相同，但功能内置于文件系统中。<br>ZFS 也可以替代 LVM （逻辑盘卷管理），使您能够动态地进行分区和管理分区，而无需处理底层的细节，也不必担心相关的风险。<br>这也是一个 CoW （写时复制）文件系统。 这里不会提及太多的技术性，这意味着 ZFS 可以保护您的数据免受逐渐损坏的影响。 ZFS 会创建文件的校验和，并允许您将这些文件回滚到以前的工作版本。</p>
</blockquote>
<h2 id="安装-ZFS"><a href="#安装-ZFS" class="headerlink" title="安装 ZFS"></a>安装 ZFS</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">在 Ubuntu 上安装 ZFS 非常简单，但对于 最新版本来说，这个 稍有不同。</span><br><span class="line"></span><br><span class="line"><span class="comment"># Ubuntu 16.04 LTS</span></span><br><span class="line">sudo apt install zfs</span><br><span class="line"></span><br><span class="line"><span class="comment"># Ubuntu 17.04 及以后</span></span><br><span class="line">sudo apt install zfsutils</span><br></pre></td></tr></table></figure>

<h2 id="zfs-中的-池，集，卷术语"><a href="#zfs-中的-池，集，卷术语" class="headerlink" title="zfs 中的 池，集，卷术语"></a>zfs 中的 池，集，卷术语</h2><p>ZFS有三个概念：</p>
<ol>
<li><p>Z池 - zpool</p>
</li>
<li><p>Z集 - dataset</p>
</li>
<li><p>Z卷 - volume</p>
</li>
</ol>
<p>Z池  <code>zpool create local /dev/sdb /dev/sdc /dev/sdd /dev/sde</code> 这就创建了一个名叫local的Z池，Z池有如下类型:raid1，raid0， raid5，raid6 等。</p>
<p>Z集 当一个Z池创建出来，附带有一个同名的Z集也创建出来了，这里就是 叫 local 这个。注意这个Z集挂载在&#x2F;local, 这个目录可以做一个正常的目录来用，可以在Z集上创建新的Z集：<code>zfs create local/data</code></p>
<p>Z卷 创建Z卷：<code>zfs create -V 10G local/vda</code>  Z卷是一个块设备，可以按需要分区，格式化：<code>mkfs.xfs /dev/zvol/local/vda</code></p>
<h2 id="创建池"><a href="#创建池" class="headerlink" title="创建池"></a>创建池</h2><p>在 ZFS 中，池大致相当于 RAID 。 它们很灵活且易于操作。<br><img src= "/img/loading.gif" data-lazy-src="https://img-blog.csdnimg.cn/20210219170121875.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21taDE5ODkxMTEz,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>RAID0</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#RAID0 只是把你的硬盘集中到一个池子里面，就像一个巨大的驱动器一样。 它可以提高你的驱动器速度，但是如果你的驱动器有损坏，你可能会失丢失数据。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sudo zpool create your-pool /dev/sdc /dev/sdd</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>RAID1（镜像）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">您可以在 ZFS 中使用 mirror 关键字来实现 RAID1 功能。 RAID1 会创建一个一对一的驱动器副本。 这意味着您的数据一直在备份。 它也提高了性能。 当然，你将一半的存储空间用于了复制。</span><br><span class="line"></span><br><span class="line">sudo zpool create your-pool mirror /dev/sdc /dev/sdd</span><br></pre></td></tr></table></figure>
<p>RAID5&#x2F;RAIDZ1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ZFS 将 RAID5 功能实现为 RAIDZ1。 RAID5 要求驱动器至少是 3 个。</span><br><span class="line">并允许您通过将备份奇偶校验数据写入驱动器空间的 1/n（n 是驱动器数），留下的是可用的存储空间。</span><br><span class="line">如果一个驱动器发生故障，阵列仍将保持联机状态，但应尽快更换发生故障的驱动器。</span><br><span class="line"></span><br><span class="line">sudo zpool create your-pool raidz1 /dev/sdc /dev/sdd /dev/sde</span><br></pre></td></tr></table></figure>
<p>RAID6&#x2F;RAIDZ2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RAID6 与 RAID5 几乎完全相同，但它至少需要四个驱动器。 它将奇偶校验数据加倍，最多允许两个驱动器损坏，而不会导致阵列关闭。</span><br><span class="line"></span><br><span class="line">sudo zpool create your-pool raidz2 /dev/sdc /dev/sdd /dev/sde /dev/sdf</span><br></pre></td></tr></table></figure>
<p>RAIDZ3<br>3奇偶校验位，允许在丢失数据之前发生3个磁盘故障，性能与RAIDZ2和RAIDZ类似。例如，创建3奇偶校验6 VDEV池： </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo zpool create example raidz3 /dev/sdb /dev/sdc /dev/sdd /dev/sde /dev/sdf /dev/sdg</span><br></pre></td></tr></table></figure>

<p>RAID10（条带化镜像）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RAID10 旨在通过数据条带化提高存取速度和数据冗余来成为一个两全其美的解决方案。 你至少需要四个驱动器，但只能使用一半的空间。 您可以通过在同一个池中创建两个镜像来创建 RAID10 中的池。</span><br><span class="line"></span><br><span class="line">sudo zpool create your-pool mirror /dev/sdc /dev/sdd mirror /dev/sde /dev/sdf</span><br><span class="line">或者</span><br><span class="line">sudo zpool create example mirror /dev/sdb /dev/sdc</span><br><span class="line">sudo zpool add example mirror /dev/sdd /dev/sde</span><br></pre></td></tr></table></figure>
<p>嵌套RAIDZ （RAID50, RAID60）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo zpool create example raidz /dev/sdb /dev/sdc /dev/sdd /dev/sde</span><br><span class="line">$ sudo zpool add example raidz /dev/sdf /dev/sdg /dev/sdh /dev/sdi</span><br></pre></td></tr></table></figure>




<h2 id="池的操作"><a href="#池的操作" class="headerlink" title="池的操作"></a>池的操作</h2><p>还有一些管理工具，一旦你创建了你的池，你就必须使用它们来操作。 首先，检查你的池的状态。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo zpool status</span><br></pre></td></tr></table></figure>
<p>当你更新 ZFS 时，你也需要更新你的池。 当您检查它们的状态时，您的池会通知您任何更新。 要更新池，请运行以下命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo zpool upgrade your-pool</span><br></pre></td></tr></table></figure>
<p>你也可以更新全部池。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo zpool upgrade -a</span><br></pre></td></tr></table></figure>
<p>您也可以随时将驱动器添加到池中。 告诉 zpool 池的名称和驱动器的位置，它会处理好一切。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo zpool add your-pool /dev/sdx</span><br></pre></td></tr></table></figure>
<p>如果您想破坏池，则可以使用以下命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo zpool destroy pool-name</span><br></pre></td></tr></table></figure>
<h2 id="ZIL-ZFS-Intent-Log"><a href="#ZIL-ZFS-Intent-Log" class="headerlink" title="ZIL (ZFS Intent Log)"></a>ZIL (ZFS Intent Log)</h2><blockquote>
<p>ZIL 我们一般使用一个或多个硬盘，正常情况下使用ssd的磁盘，ZIL能记录所有的写操作，然后写到ZIL 的磁盘，因为zfs copy on write的机制，ZIL实际的存储信息很小, 只保存修改的数据，或者是数据块的外部指针, 假如你写入一个大的数据文件，如果设置logbias&#x3D;troughput, 那么这个所有的写操作是直接到data pool的不经过ZIL, ZIL中只保存数据的指针, 所以说如果设置logbias&#x3D;troughput,那么使用独立的ZIL设备是没有意义的。 如果logbias&#x3D;latency，由于zfs对zil的使用有阈值限制, 例如单次提交的写超过阈值则直接写data pool, 否则会写入ZIL之后sync到data pool。这个阈值是通过设置zfs_immediate_write_sz (&#x2F;etc&#x2F;system文件)的大小来确定。所有的这些参数的调整要更据你的具体应用场景来确定。</p>
</blockquote>
<blockquote>
<p>ZFS 文件系统也有类似数据库的重做日志，被称为 ZFS Intent Log ，简称 ZIL, 还有个术语，被称为 Separate Intent Log, 简称 SLOG，是指存储 ZIL日志的独立的设备， 手册上提到使用 ZIL 可以提高文件系统性能，还能够用来恢复文件系统</p>
</blockquote>
<blockquote>
<p>这里如果我们不添加独立ZIL设备，实际上pool里面的数据盘上也会又ZIL的存储, 只要是ZFS sync&#x3D;standard, 值得一提的是sync&#x3D;always的话，所有文件系统的transaction是直接写到data pool.</p>
</blockquote>
<blockquote>
<p>同步写操作减少对整个data pool的IOPS影响, 使用ssd做ZIL可用降低同步写的延迟, 这一点非常重要，NFS&#x2F;ISCSI Target&#x2F;OLTP Database等都是同步写，这里会大大提升性能。</p>
</blockquote>
<p>稍微总结下：</p>
<pre><code>ZIL提供了断电情况下的数据保护。
在每次同步写发生的情况下避免更新整个磁盘的data structure.
大量的同步写操作会增加了整个data pool的IOPS的压力，所有需要使用独立的ZIL设备。
通过SSD作为独立ZIL设备可以加速同步写。甚至我们可以使用多个SSD将ZIL做成Mirror,防止单盘的失效。
如果你的data pool是全SSD的，又没有独立的ZIL设备，可以直接将logbias=throughput。
</code></pre>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">For example, to add a SSDs to the pool <span class="string">&#x27;mypool&#x27;</span>, use: </span><br><span class="line">$ sudo zpool add mypool <span class="built_in">log</span> /dev/sdg -f</span><br></pre></td></tr></table></figure>
<p>需要注意的是存放log的硬盘若损坏有可能导致数据丢失，如果不能接受这个风险的话考虑给log盘做成mirror模式，命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备注： 给 mypool 池增加 SLOG 设备，并且 sda1 , sda2 做成镜像。 </span></span><br><span class="line">$ sudo zpool add mypool <span class="built_in">log</span> mirror /dev/sda1 /dev/sda2</span><br><span class="line"></span><br><span class="line">$ sudo zpool add ftp-pool <span class="built_in">log</span> mirror /dev/sda /dev/sdb</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="ZFS-Cache-Drives-拿-SSD-做快取"><a href="#ZFS-Cache-Drives-拿-SSD-做快取" class="headerlink" title="ZFS Cache Drives 拿 SSD 做快取"></a>ZFS Cache Drives 拿 SSD 做快取</h2><p> 高速缓存设备在主内存和磁盘之间提供了一个额外的高速缓存层。它们对于提高主要是静态数据的随机读取性能特别有用。 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Fox example, to add a cache drive /dev/sdh to the pool <span class="string">&#x27;mypool&#x27;</span>, use:</span><br><span class="line"></span><br><span class="line">$ sudo zpool add mypool cache /dev/sdh -f</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过 zpool add 加上一顆 SSD 硬盘作為快取使用 (关鍵字是 cache)：</span></span><br><span class="line">$ sudo zpool add ftp-pool cache /dev/disk/by-id/ata-INTEL_SSDSC2BB240G7_PHD12345ABC</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="ZFS与数据去重"><a href="#ZFS与数据去重" class="headerlink" title="ZFS与数据去重"></a>ZFS与数据去重</h2><p> 什么是Deduplication?<br>Deduplication是消除重复数据的过程。去重过程可以基于file-level文件级，block-level块级或者byte-level字节级。使用非常高可能性的hash算法来唯一标识数据块（文件，块，字节）。当使用安全hash，例如SHA256时，hash碰撞的可能性为2的256次方，2^256 &#x3D; 10\67 或者表示为0.00000000000000000000000000000000000000000000000000000000000000000000000000001。</p>
<p>选择哪个等级的去重，files,blocks,bytes?<br>数据可以在文件级，块级，字节级被去重。<br>文件级的去重对文件作为整体来计算hash签名，如果处理的是自然的文件，则此方法需要的消耗最小，但是缺点是对文件的任何修改都需要重新计算文件的hash签名，即对文件的任何修改，将使得此文件之前节约的空间消失，因为两个文件将不再相同。此中方法比较适合类似于文件JPEG，MPEG，但是对于像虚拟机镜像（大文件）文件将无效，因为即使他们只是很小的一部分不同，但是文件级别他们将是不同的文件。<br>块级别的去重（相同大小的块），相比文件级的去重，需要更多的计算消耗，但是他能够很好地对像虚拟机镜像类似的大文件去重。大部分的虚拟机镜像文件是重复数据，例如镜像文件中的操作系统部分。使用块级的去重将使得只有镜像特别的数据才占用额外的空间，相同的数据将共享。<br>字节级别的去重，将需要更多的计算消耗来决定重复数据的开始和结束区域，不管怎么说，此方法对mail服务器来说是理想的选择，例如一个邮件的附件可能出现很多次，但是使用块级别去重时他们并不能被优化。此类型的去重一般用来一些应用程序的去重中，例如exchangeserver，因为应用程序知道他管理的数据，可以在内部容易地去重。<br>ZFS提供了块级别的去重技术，此种技术更适合通用的情况。且ZFS使用SHA256来计算hash签名。</p>
<p>什么时候去重，现在还是将来？<br>除了以上描述的文件级，块级，字节级的区别外，去重还可以分为同步（实时或内置）和异步（批处理或离线处理）。在同步去重中，重复文件在出现的时候即被去除，在异步去重中，文件已经存储在磁盘上，然后通过后续的处理来去重（例如在夜间来处理）。异步去重典型地被用在拥有有限的cpu和多线程的存储系统，最小化对日常工作的影响。但是如果cpu的性能足够，同步去重是推荐的方法，因为避免了无用的磁盘的写操作。</p>
<p>如何使用ZFS的去重</p>
<p>使用非常的简单，如果你有存储池tank，你需要对tank使用zfs，则设置为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">zfs <span class="built_in">set</span> dedup=on tank</span><br><span class="line"></span><br><span class="line">zfs <span class="built_in">set</span> dedup=on <span class="built_in">local</span></span><br><span class="line">zfs <span class="built_in">set</span> compress=lz4 <span class="built_in">local</span></span><br></pre></td></tr></table></figure>

<p>是否需要ZFS的去重的权衡</p>
<p>主要还是取决于你的数据。如果你的数据确实不包含重复，则开启去重功能则会带来额外的开销且没有任何的好处。但是如果你的数据包含重复，则使用zfs的去重可以节约空间而且提高性能。节约空间是显而易见的，性能的提高是因为减少了重复数据的写磁盘消耗和内存页的置换。</p>
<p>大部分的存储环境都是多种数据的混合，zfs支持对有重复的部分开启去重操作，例如你的存储池包含了home目录，虚拟机镜像目录，源代码目录。此时你可以设置如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">zfs <span class="built_in">set</span> dedup=off tank/home</span><br><span class="line"></span><br><span class="line">zfs <span class="built_in">set</span> dedup=on tank/vm</span><br><span class="line"></span><br><span class="line">zfs <span class="built_in">set</span> dedup=on tank/src</span><br></pre></td></tr></table></figure>

<p>信任或验证</p>
<p>如果两个数据的hash相同，我们则认为两个数据是同一个数据，hash例如SHA256，两个不同数据hash相同的可能性为1&#x2F;2^256， 是个很小的概率。当然zfs也提供了验证的选项，此选项对两个数据进行全比较来确定他们是否相同，如果不相同则处理，指定verify的语法如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zfs <span class="built_in">set</span> dedup=verify tank</span><br></pre></td></tr></table></figure>

<p>hash的选择</p>
<p>因为不同种类的hash所需要的运算也不相同，一种推荐的方法是使用较弱的hash（需要的运算较少）加verify来提供快速的去重，zfs对应的选项为:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zfs <span class="built_in">set</span> dedup=fletcher4,verify tank</span><br></pre></td></tr></table></figure>
<p>不像SHA256，fletcher4不能被信任为无碰撞，只适合与verify一起使用，verify来确保碰撞的处理。总的来说性能相对要好些。</p>
<p>通常如果不确定哪种的hash的效率跟高的话，即使用默认的设置dedup&#x3D;on</p>
<p>扩展性和效率</p>
<p>大部分的去重方案都只能针对有限的数据，一般在TB等级，因为他们需要去重数据表常驻在内存。ZFS对数据大大小没有限制，可以处理PB级的数据。但是如果去重数据表常驻内存的话，性能比较好。</p>
<h2 id="ZFS与数据压缩"><a href="#ZFS与数据压缩" class="headerlink" title="ZFS与数据压缩"></a>ZFS与数据压缩</h2><p>什么是ZFS压缩？<br>ZFS中的压缩是一个非常简洁的特性：它可以动态压缩文件，因此可以使用有限的存储空间存储更多的数据。</p>
<p>为什么使用ZFS压缩？<br>显然，ZFS压缩的最大好处是可以节省相当多的空间。你的服务器或桌面上的大文件可能会压缩得很好，那么为什么要浪费空间呢？</p>
<p>以下是一些非常适合ZFS压缩场景的文件：<br>新OS版本的ISO映像（不知道您的情况，但我几乎每天都下载）<br>VirtualBox、KVM或任何其他解决方案的VM映像<br>Docker容器镜像<br>大量应用程序或服务器日志 </p>
<p>为什么禁用压缩？<br>像所有好东西一样，ZFS压缩也有成本，特别是压缩和解压缩ZFS数据需要额外的CPU周期。我对这一点的看法是，在桌面系统上，ZFS压缩绝对是一个很好的主意-您很少会将CPU的最大化扩展到ZFS压缩可以注意到的程度，但优化宝贵的SSD存储空间的好处是巨大的。<br>在较小的系统上，比如我的一些用于远程RSyslog的嵌入式服务器，这可能是一个破坏者：进入的日志数量可能会高到超出舒适水平的CPU使用率峰值。</p>
<p>如何检查ZFS压缩 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ zfs get all work/share/sean |grep compress</span><br><span class="line">work/share/sean  compressratio         4.32x                  -</span><br><span class="line">work/share/sean  compression           lz4                    inherited from work/share</span><br><span class="line">work/share/sean  refcompressratio      4.32x </span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面是没有开启压缩功能的显示结果</span></span><br><span class="line">$ zfs get all newvol | grep compress</span><br><span class="line">work compressratio         1.00x                  -</span><br><span class="line">work compression           off                    <span class="built_in">local</span></span><br><span class="line">work refcompressratio      1.00x                  -</span><br></pre></td></tr></table></figure>

<p>如何开启ZFS压缩？<br> ZFS有多种压缩算法：<br>gzip - standard UNIX compression.<br>gzip-N - selects a specific gzip level. gzip-1 provides the fastest gzip compression. gzip-9 provides the best data compression. gzip-6 is the default.<br>lz4 - provides better compression with lower CPU overhead  这种是比较通用，常用的。<br>lzjb - optimized for performance while providing decent compression<br>zle - zero length encoding is useful for datasets with large blocks of zeros</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 比较常用的 是 lz4 这个，</span></span><br><span class="line"></span><br><span class="line">$ zfs <span class="built_in">set</span> compression=lz4 newvol</span><br><span class="line"></span><br><span class="line">$ zfs <span class="built_in">set</span> compress=lz4 pool/fs</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如何禁用ZFS压缩？</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@server:~ <span class="comment"># zfs set compression=off newvol</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>压缩只对新生成的数据有效。<br>一件非常重要的事情：当您启用或禁用ZFS压缩时，实际上并没有更改ZFS文件系统上的任何数据。<br>这些更改ZFS的行为，意味着将来的任何数据会生效，但当前的数据将保持原样。 </p>
<h2 id="其他补充"><a href="#其他补充" class="headerlink" title="其他补充"></a>其他补充</h2><p>下面坐了3组对比，来观察 去重，和压缩 打开关闭的效果。<br>这个是打开了 dedup&#x3D;on 去重复数据的开关的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ zpool list</span><br><span class="line">NAME   SIZE  ALLOC   FREE  CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP    HEALTH  ALTROOT</span><br><span class="line">work  10.9T   119M  10.9T        -         -     0%     0%  101.00x    ONLINE  -</span><br><span class="line"></span><br><span class="line">$ sudo zdb -b work</span><br><span class="line"></span><br><span class="line">Traversing all blocks to verify nothing leaked ...</span><br><span class="line"></span><br><span class="line">loading concrete vdev 1, metaslab 348 of 349 ...</span><br><span class="line"></span><br><span class="line">	No leaks (block sum matches space maps exactly)</span><br><span class="line"></span><br><span class="line">	bp count:                 59858</span><br><span class="line">	ganged count:                 0</span><br><span class="line">	bp logical:          7825691648      avg: 130737</span><br><span class="line">	bp physical:         7813446656      avg: 130533     compression:   1.00</span><br><span class="line">	bp allocated:       11724856320      avg: 195877     compression:   0.67</span><br><span class="line">	bp deduped:         11599872000    ref&gt;1:    590   deduplication:   1.99</span><br><span class="line">	Normal class:         124984320     used:  0.00%</span><br><span class="line"></span><br><span class="line">	additional, non-pointer bps of type 0:         32</span><br><span class="line">	Dittoed blocks on same vdev: 114</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这个是没有打开  dedup&#x3D;on 去重复数据的开关的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ zpool list</span><br><span class="line">NAME   SIZE  ALLOC   FREE  CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP    HEALTH  ALTROOT</span><br><span class="line">work  10.9T  7.28G  10.9T        -         -     0%     0%  1.00x    ONLINE  -</span><br><span class="line"></span><br><span class="line">$ sudo zdb -b work</span><br><span class="line"></span><br><span class="line">Traversing all blocks to verify nothing leaked ...</span><br><span class="line"></span><br><span class="line">loading concrete vdev 5, metaslab 115 of 116 ...</span><br><span class="line"></span><br><span class="line">	No leaks (block sum matches space maps exactly)</span><br><span class="line"></span><br><span class="line">	bp count:                 59830</span><br><span class="line">	ganged count:                 0</span><br><span class="line">	bp logical:          7825523712      avg: 130795</span><br><span class="line">	bp physical:         7813270528      avg: 130591     compression:   1.00</span><br><span class="line">	bp allocated:        7816024064      avg: 130637     compression:   1.00</span><br><span class="line">	bp deduped:                   0    ref&gt;1:      0   deduplication:   1.00</span><br><span class="line">	Normal class:        7816024064     used:  0.07%</span><br><span class="line"></span><br><span class="line">	additional, non-pointer bps of type 0:         40</span><br></pre></td></tr></table></figure>
<p>打开去重和压缩的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ zpool list</span><br><span class="line">NAME   SIZE  ALLOC   FREE  CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP    HEALTH  ALTROOT</span><br><span class="line">work  10.9T  15.3M  10.9T        -         -     0%     0%  101.00x    ONLINE  -</span><br><span class="line"></span><br><span class="line">$ sudo zdb -b work</span><br><span class="line"></span><br><span class="line">Traversing all blocks to verify nothing leaked ...</span><br><span class="line"></span><br><span class="line">loading concrete vdev 5, metaslab 115 of 116 ...</span><br><span class="line"></span><br><span class="line">	No leaks (block sum matches space maps exactly)</span><br><span class="line"></span><br><span class="line">	bp count:                 59899</span><br><span class="line">	ganged count:                 0</span><br><span class="line">	bp logical:          7825843200      avg: 130650</span><br><span class="line">	bp physical:          948596736      avg:  15836     compression:   8.25</span><br><span class="line">	bp allocated:         951911424      avg:  15891     compression:   8.22</span><br><span class="line">	bp deduped:           936140800    ref&gt;1:    590   deduplication:   1.98</span><br><span class="line">	Normal class:          15770624     used:  0.00%</span><br><span class="line"></span><br><span class="line">	additional, non-pointer bps of type 0:         40</span><br></pre></td></tr></table></figure>

<p>销毁池</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo zpool destroy work</span><br></pre></td></tr></table></figure>

<p>6个硬盘，3个组成raid5，然后在2组组成raid0了。可用空间大概是4个2TB。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo zpool create work raidz1 /dev/sd&#123;b,c,d&#125;1</span><br><span class="line">sudo zpool add -f work raidz1 /dev/sd&#123;e,f,g&#125;1</span><br><span class="line">work            7.1T  7.3G  7.1T   1% /work</span><br></pre></td></tr></table></figure>
<p>6个硬盘，直接组成raid0，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo zpool create work /dev/sd&#123;b,c,d,e,f,g&#125;1</span><br><span class="line">work             11T  128K   11T   1% /work</span><br></pre></td></tr></table></figure>
<p>打开去重和压缩功能</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo zfs set dedup=on work</span><br><span class="line">$ sudo zfs set compression=lz4 work</span><br></pre></td></tr></table></figure>








</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://magesfc.github.io">mage</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://magesfc.github.io/mage/d98de400d172c2a1012ced6496ab01f175b24831/">https://magesfc.github.io/mage/d98de400d172c2a1012ced6496ab01f175b24831/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://magesfc.github.io" target="_blank">马哥私房菜</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/linux/">linux</a><a class="post-meta__tags" href="/tags/zfs/">zfs</a></div><div class="post_share"><div class="social-share" data-image="https://t.mwm.moe/fj/" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/null" target="_blank"><img class="post-qr-code-img" src= "/img/loading.gif" data-lazy-src="/null" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/null" target="_blank"><img class="post-qr-code-img" src= "/img/loading.gif" data-lazy-src="/null" alt="支付寶"/></a><div class="post-qr-code-desc">支付寶</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/mage/8d67839bb6d44eff5b49a469ceced4aac4bb004a/"><img class="prev-cover" src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Linux学习之task-spooler是一个Unix批处理系统</div></div></a></div><div class="next-post pull-right"><a href="/mage/5b96c3ed08ce6300577a1a8cd7169200600b4b1d/"><img class="next-cover" src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Python学习之Anaconda学习笔记总结</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/mage/d09beb62ca31e9a0cf278d3ff1a8795bc551ec06/" title="Linux学习之文件系统zfs性能优化"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-23</div><div class="title">Linux学习之文件系统zfs性能优化</div></div></a></div><div><a href="/mage/bead5c222ebd755a0ea0b8165ff0663545d6c700/" title="Linux学习之10个有用的链式操作符及其实例"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-23</div><div class="title">Linux学习之10个有用的链式操作符及其实例</div></div></a></div><div><a href="/mage/8facee0ca4bc4450ba21eea69a97fe1891c415dc/" title="Linux学习之bash学习之bash_strict_mode"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-13</div><div class="title">Linux学习之bash学习之bash_strict_mode</div></div></a></div><div><a href="/mage/0158e8186f0827d0b00df276735e46e876749b88/" title="Linux学习之bash学习之在bash中&#x3D;和&#x3D;~的区别"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-23</div><div class="title">Linux学习之bash学习之在bash中&#x3D;和&#x3D;~的区别</div></div></a></div><div><a href="/mage/53776646b88e8b3c368d34d9936b880421441770/" title="Linux学习之bash学习之在bash中Quoting的解释"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-06</div><div class="title">Linux学习之bash学习之在bash中Quoting的解释</div></div></a></div><div><a href="/mage/29b1dee9b6336ea01be4716d95ecfbad663018d6/" title="Linux学习之bash学习之几个特殊变量"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-23</div><div class="title">Linux学习之bash学习之几个特殊变量</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "/img/loading.gif" data-lazy-src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">mage</div><div class="author-info__description"> 这里是 马哥 的个人博客 </div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">217</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">233</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">40</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mamh2021"><i class="fab fa-github"></i><span>GitHub</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/mamh2021" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%80%89%E6%8B%A9-ZFS"><span class="toc-number">1.</span> <span class="toc-text">为什么选择 ZFS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-ZFS"><span class="toc-number">2.</span> <span class="toc-text">安装 ZFS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#zfs-%E4%B8%AD%E7%9A%84-%E6%B1%A0%EF%BC%8C%E9%9B%86%EF%BC%8C%E5%8D%B7%E6%9C%AF%E8%AF%AD"><span class="toc-number">3.</span> <span class="toc-text">zfs 中的 池，集，卷术语</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%B1%A0"><span class="toc-number">4.</span> <span class="toc-text">创建池</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B1%A0%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="toc-number">5.</span> <span class="toc-text">池的操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ZIL-ZFS-Intent-Log"><span class="toc-number">6.</span> <span class="toc-text">ZIL (ZFS Intent Log)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ZFS-Cache-Drives-%E6%8B%BF-SSD-%E5%81%9A%E5%BF%AB%E5%8F%96"><span class="toc-number">7.</span> <span class="toc-text">ZFS Cache Drives 拿 SSD 做快取</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ZFS%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%8E%BB%E9%87%8D"><span class="toc-number">8.</span> <span class="toc-text">ZFS与数据去重</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ZFS%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%8E%8B%E7%BC%A9"><span class="toc-number">9.</span> <span class="toc-text">ZFS与数据压缩</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E8%A1%A5%E5%85%85"><span class="toc-number">10.</span> <span class="toc-text">其他补充</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/mage/ee6e53b9fbe2f10991d150675f0b88ed427b1150/" title="Android下的配置管理之道之repo-diffmanifests源码分析"><img src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android下的配置管理之道之repo-diffmanifests源码分析"/></a><div class="content"><a class="title" href="/mage/ee6e53b9fbe2f10991d150675f0b88ed427b1150/" title="Android下的配置管理之道之repo-diffmanifests源码分析">Android下的配置管理之道之repo-diffmanifests源码分析</a><time datetime="2024-05-18T08:38:37.000Z" title="更新于 2024-05-18 16:38:37">2024-05-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/mage/a52bd2f9ab320c603de205368472b5caa19b7207/" title="Android下的配置管理之道之repo-sync源码分析"><img src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android下的配置管理之道之repo-sync源码分析"/></a><div class="content"><a class="title" href="/mage/a52bd2f9ab320c603de205368472b5caa19b7207/" title="Android下的配置管理之道之repo-sync源码分析">Android下的配置管理之道之repo-sync源码分析</a><time datetime="2024-05-18T02:15:08.000Z" title="更新于 2024-05-18 10:15:08">2024-05-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/mage/0bd8125569ad5e0222f4ca4e90e626be2ee24c26/" title="Jenkins学习之DataBoundConstructor和DataBoundSetter"><img src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Jenkins学习之DataBoundConstructor和DataBoundSetter"/></a><div class="content"><a class="title" href="/mage/0bd8125569ad5e0222f4ca4e90e626be2ee24c26/" title="Jenkins学习之DataBoundConstructor和DataBoundSetter">Jenkins学习之DataBoundConstructor和DataBoundSetter</a><time datetime="2024-03-31T06:28:23.000Z" title="更新于 2024-03-31 14:28:23">2024-03-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/mage/4b00a873b39948044a79c7e53eedd63d7af0bfa6/" title="Docker学习之安装docker-swarm集群"><img src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Docker学习之安装docker-swarm集群"/></a><div class="content"><a class="title" href="/mage/4b00a873b39948044a79c7e53eedd63d7af0bfa6/" title="Docker学习之安装docker-swarm集群">Docker学习之安装docker-swarm集群</a><time datetime="2024-03-31T06:28:19.000Z" title="更新于 2024-03-31 14:28:19">2024-03-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/mage/44f033ce59a71a67f64e3c2e330151f82f8754f4/" title="Jenkins学习之master服务器安装使用docker安装"><img src= "/img/loading.gif" data-lazy-src="https://t.mwm.moe/fj/" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Jenkins学习之master服务器安装使用docker安装"/></a><div class="content"><a class="title" href="/mage/44f033ce59a71a67f64e3c2e330151f82f8754f4/" title="Jenkins学习之master服务器安装使用docker安装">Jenkins学习之master服务器安装使用docker安装</a><time datetime="2024-03-24T03:25:01.000Z" title="更新于 2024-03-24 11:25:01">2024-03-24</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://t.mwm.moe/fj/')"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2024 By mage</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="true" data-click="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>